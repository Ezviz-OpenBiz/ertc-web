import e from"webrtc-adapter";class t{constructor(){this.pluginName="TalkAgent",this.instance=null,this.classNative=null}exec(e){let{instance:t,classNative:n}=e;console.log("TalkAgent plugin exec"),this.instance=t,this.classNative=n,t.agentCall=this.agentCall.bind(this),t.agentStop=this.agentStop.bind(this),t.observeVolumeChange=this.observeVolumeChange.bind(this)}destroy(){}async agentCall(e){return new Promise(async(t,n)=>{this._requestCall(e).then(i=>{let{token:a,roomId:s,userId:o}=i;const r=this.instance,l=this.classNative;let c=!1,u=!1;this._updateListeners(()=>{r.publishStream({type:l.STREAM_TYPE.AUDIO_ONLY}).then(()=>{this._setCallTimeout(!1),c=!0,u&&t(!0)}).catch(e=>{r.logger.log("发布音频失败，上报错误",e),n("publish fail"),this.agentStop()})},e=>{let{customId:i,streamtype:a}=e;if(a===l.STREAM_TYPE.AUDIO_ONLY){const e=this._createAudioDom();r.subscribeStream({type:a,userId:i,view:e}).then(()=>{u=!0,c&&t(!0)}).catch(e=>{r.logger.log("订阅音频失败，上报错误",e),n("subscribe fail"),this.agentStop()})}},()=>{this._setCallTimeout(!1),this.agentStop(),r.trigger("error",{code:-1,msg:"对端退出，对讲结束"})}),r.enterRoom({appId:e.ertcAppId,roomId:s,userId:o,accessToken:a}).then(t=>{0!==(null==t?void 0:t.code)?n(t):this._setCallTimeout(e.timeout||6e4,()=>{n("agentCall timeout"),this.agentStop()})}).catch(n)}).catch(n)})}async agentStop(){return this._updateListeners(),this._createAudioDom(!1),clearInterval(this.volumeChangeInterval),this.volumeChangeInterval=null,this.instance.leaveRoom()}observeVolumeChange(){var t;let n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const{interval:i=100,callback:a}=n;this.volumeChangeInterval&&(clearInterval(this.volumeChangeInterval),this.volumeChangeInterval=null);const s=null===(t=this.instance.state.publishAttaches)||void 0===t||null===(t=t.default)||void 0===t?void 0:t.mediaStream;if(!s)return;const o=new AudioContext,r=o.createMediaStreamSource(s),l=o.createAnalyser();l.fftSize=1024,l.smoothingTimeConstant=.8;const c=l.frequencyBinCount,u=new Uint8Array(c);r.connect(l);this.volumeChangeInterval=setInterval(()=>{if(["firefox"].includes(e.browserDetails.browser)){l.getByteFrequencyData(u);let e=0;const t=10,n=100;for(let i=t;i<n&&i<c;i++)e+=u[i];const i=e/(n-t),s=Math.min(1,i/128);a&&a(s)}else{var t;null===(t=this.instance.state.publishAttaches)||void 0===t||null===(t=t.default)||void 0===t||null===(t=t.pluginHandle)||void 0===t||t.webrtcStuff.pc.getStats().then(e=>{e.forEach(e=>{"media-source"===e.type&&a&&a(e.audioLevel)})})}},i)}async _requestCall(e){return new Promise((t,n)=>{var i;(i={url:"/api/service/open/sts/bridge/dialog/room/call",method:"POST",headerOptions:{accessToken:e.accessToken},data:{appId:e.ertcAppId,agentAppId:e.agentAppId}},new Promise((e,t)=>{var n;const a=i.url,s=(null===(n=i.method)||void 0===n?void 0:n.toUpperCase())||"GET",o=i.data||{},r=i.headerOptions||{};let l={"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"},c="";l=Object.assign(l,r);var u=new Headers;Object.keys(l).map(e=>{u.append(e,l[e])}),l=u,Object.keys(Object.assign({},o)).forEach(e=>{let t=o[e];"string"==typeof o[e]&&(t=o[e].replace("%","%25")),void 0!==o[e]&&(c+=`&${e}=${encodeURIComponent(t)}`)}),c.length>0&&(c=-1!==["GET","PUT","DELETE"].indexOf(s.toUpperCase())?`?${c.slice(1)}`:c.slice(1));let h=a+(-1!==["GET","PUT","DELETE"].indexOf(s.toUpperCase())?c:"");const d={headers:l,method:s};"POST"===s&&(d.body=c),"POST"===s&&r&&"application/json"===r["Content-Type"]&&(d.body=JSON.stringify(o)),"GET"===s&&(-1===h.indexOf("?")?h+=`?_r=${Math.random()}`:h+=`&_r=${Math.random()}`),d.credentials="same-origin",fetch(h,d).then(e=>e.json()).then(t=>{e(t)}).catch(e=>{t(e)})})).then(e=>{var i,a;200===(null===(i=e.meta)||void 0===i?void 0:i.code)?t(e.data):n((null===(a=e.meta)||void 0===a?void 0:a.message)||(null==e?void 0:e.err)||"未知错误")}).catch(n)})}_updateListeners(e,t,n){const i=this.classNative;this.instance.remove(i.EVENT.CLIENTJOIN,e||null),this.instance.remove(i.EVENT.STREAM_ADDED,t||null),this.instance.remove(i.EVENT.CLIENTLEAVE,n||null),e&&this.instance.once(i.EVENT.CLIENTJOIN,e),t&&this.instance.once(i.EVENT.STREAM_ADDED,t),n&&this.instance.once(i.EVENT.CLIENTLEAVE,n)}_createAudioDom(e){if(this.currentAudio&&(this.currentAudio.pause(),this.currentAudio.remove(),this.currentAudio=null,!1===e))return;const t=document.createElement("audio");return t.controls=!0,t.autoplay=!0,Object.assign(t.style,{position:"fixed",top:"-9999px",left:"-9999px",width:"1px",height:"1px",overflow:"hidden",pointerEvents:"none",opacity:"0"}),document.body.appendChild(t),this.currentAudio=t,t}async _setCallTimeout(e,t){if(!1===e)return clearTimeout(this.timeoutId),void(this.timeoutId=null);this.timeoutId=setTimeout(()=>{t&&t()},e)}}var n,i,a;n=t,a={},(i=function(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var i=n.call(e,t);if("object"!=typeof i)return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:t+""}(i="EVENT"))in n?Object.defineProperty(n,i,{value:a,enumerable:!0,configurable:!0,writable:!0}):n[i]=a;export{t as default};
