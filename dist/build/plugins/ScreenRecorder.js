!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?module.exports=r(require("webrtc-adapter")):"function"==typeof define&&define.amd?define(["webrtc-adapter"],r):(e="undefined"!=typeof globalThis?globalThis:e||self).ERTC_WEB_PLUGINS_SCREENRECORDER=r(e.adapter)}(this,function(e){"use strict";function r(e,r,t){return(r=function(e){var r=function(e,r){if("object"!=typeof e||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var n=t.call(e,r);if("object"!=typeof n)return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===r?String:Number)(e)}(e,"string");return"symbol"==typeof r?r:r+""}(r))in e?Object.defineProperty(e,r,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[r]=t,e}const t=[],n={supportExport:!0};let o=0;const i={info:"",log:"background: #4096ff; color: #FFF;",warn:"background: yellow; color: #FFF;",error:"background: red; color: #FFF;"};class a{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};r(this,"_options",{level:"INFO",showTime:!1}),r(this,"_levelNum",3),r(this,"info",this._loggerFactory("info",this._levelNum>=3)),r(this,"log",this._loggerFactory("log",this._levelNum>=2)),r(this,"warn",this._loggerFactory("warn",this._levelNum>=1)),r(this,"error",this._loggerFactory("error",this._levelNum>=0)),r(this,"debug",this._loggerFactory("debug",this._levelNum>=0)),r(this,"trace",this._loggerFactory("trace",this._levelNum>=0)),this.setOptions(e)}setOptions(e){var r,t;this._options=Object.assign({},this._options,e),this._levelNum=this._matchLevel(null!==(r=this._options.level)&&void 0!==r?r:"INFO"),this._nameColor=null!==(t=e.nameColor)&&void 0!==t?t:"background: green;color: #fff",this.info=this._loggerFactory("info",this._levelNum>=3),this.log=this._loggerFactory("log",this._levelNum>=2),this.warn=this._loggerFactory("warn",this._levelNum>=1),this.error=this._loggerFactory("error",this._levelNum>=0)}_matchLevel(e){let r=3;switch(e){case"INFO":r=3;break;case"LOG":r=2;break;case"WARN":r=1;break;case"ERROR":r=0}return r}_loggerFactory(e,r){const t=console[e];if(r&&t){const r=this._options.name?`%c[${this._options.name}]%c %c[${e.toUpperCase()}]`:`%c[${e.toUpperCase()}]`,n=[this._options.name?this._nameColor:null,this._options.name?"":null,i[e]].filter(e=>null!=e);return t.bind(console,r,...n)}return a.noop}getOptions(){return this._options}}function s(e){return(e=+e)<10&&(e=`0${e}`),e+""}r(a,"noop",()=>{});const d=["log","debug","info","warn","error","trace"];var c={proxy:e=>{const r=new a(e);return new Proxy(r,{get(r,i){if(d.includes(i)){const a=function(){const e=new Date(Date.now()),r=e.getFullYear(),t=e.getMonth()+1,n=e.getDate(),o=e.getHours(),i=e.getMinutes(),a=e.getSeconds();return`${r}/${s(t)}/${s(n)} ${s(o)}:${s(i)}:${s(a)}`}();return n.supportExport?function(){r[i].apply(console,arguments);const n=[`[${a}][${e.name} ${i}]：`,...arguments];["log","info","warn","error"].includes(i)&&t.push(n),o+=JSON.stringify(n).length,async function(){const e=524288;if(o>e){let r=0,n=0;for(;n<t.length&&o-r>e;)r+=JSON.stringify(t[n]).length,n++,await new Promise(e=>setTimeout(e,0));t.splice(0,n),o-=r}}()}:r[i].bind(console)}return Reflect.get(r,i)}})},setGlobalConfig(e){Object.assign(n,e)},exportLogs(){function e(r){return r.map(r=>{if(r instanceof Array)return JSON.stringify(e(r));if(r instanceof Error)return r.message;if(r instanceof MediaStreamTrack){const e={id:r.id,enabled:r.enabled,kind:r.kind,label:r.label,muted:r.muted,readyState:r.readyState,remote:r.remote};return JSON.stringify(e)}return JSON.stringify(r)})}const r=t.map(function(r){return e(r).join("")}).join("\r\n\r\n"),n=new Blob([r],{type:"text/plain;charset=utf-8"}),o=URL.createObjectURL(n),i=document.createElement("a");i.href=o,i.download="logs.txt",i.click(),window.URL.revokeObjectURL(o)}};f.sessions={},f.isExtensionEnabled=function(){if(navigator.mediaDevices&&navigator.mediaDevices.getDisplayMedia)return!0;if(window.navigator.userAgent.match("Chrome")){var e=parseInt(window.navigator.userAgent.match(/Chrome\/(.*) /)[1],10),r=33;return window.navigator.userAgent.match("Linux")&&(r=35),e>=26&&e<=r||f.extension.isInstalled()}return!0};var l={extensionId:"hapfgfdkleiggjjpfpenajgdnfckjpaj",isInstalled:function(){return null!==document.querySelector("#janus-extension-installed")},getScreen:function(e){var r=window.setTimeout(function(){var r=new Error("NavigatorUserMediaError");return r.name='The required Chrome extension is not installed: click <a href="#">here</a> to install it. (NOTE: this will need you to refresh the page)',e(r)},1e3);this.cache[r]=e,window.postMessage({type:"janusGetScreen",id:r},"*")},init:function(){var e={};this.cache=e,window.addEventListener("message",function(r){if(r.origin==window.location.origin)if("janusGotScreen"==r.data.type&&e[r.data.id]){var t=e[r.data.id];if(delete e[r.data.id],""===r.data.sourceId){var n=new Error("NavigatorUserMediaError");n.name="You cancelled the request for permission, giving up...",t(n)}else t(null,r.data.sourceId)}else"janusGetScreenPending"==r.data.type&&(f.log("clearing ",r.data.id),window.clearTimeout(r.data.id))})}};f.useDefaultDependencies=function(r){var t=r&&r.fetch||fetch,n=r&&r.Promise||Promise,o=r&&r.WebSocket||WebSocket;return{newWebSocket:function(e,r){return new o(e,r)},extension:r&&r.extension||l,isArray:function(e){return Array.isArray(e)},webRTCAdapter:r&&r.adapter||e,httpAPICall:function(e,r){var o={method:r.verb,headers:{Accept:"application/json, text/plain, */*"},cache:"no-cache"};"POST"===r.verb&&(o.headers["Content-Type"]="application/json"),void 0!==r.withCredentials&&(o.credentials=!0===r.withCredentials?"include":r.withCredentials?r.withCredentials:"omit"),void 0!==r.body&&(o.body=JSON.stringify(r.body));var i=t(e,o).catch(function(e){return n.reject({message:"Probably a network error, is the server down?",error:e})});if(void 0!==r.timeout){var a=new n(function(e,t){var n=setTimeout(function(){return clearTimeout(n),t({message:"Request timed out",timeout:r.timeout})},r.timeout)});i=n.race([i,a])}return i.then(function(e){return e.ok?typeof r.success==typeof f.noop?e.json().then(function(e){r.success(e)}).catch(function(r){return n.reject({message:"Failed to parse response body",error:r,response:e})}):void 0:n.reject({message:"API call failed",response:e})}).catch(function(e){typeof r.error==typeof f.noop&&r.error(e.message||"<< internal error >>",e)}),i}}},f.useOldDependencies=function(r){var t=r&&r.jQuery||jQuery,n=r&&r.WebSocket||WebSocket;return{newWebSocket:function(e,r){return new n(e,r)},isArray:function(e){return t.isArray(e)},extension:r&&r.extension||l,webRTCAdapter:r&&r.adapter||e,httpAPICall:function(e,r){var n=void 0!==r.body?{contentType:"application/json",data:JSON.stringify(r.body)}:{},o=void 0!==r.withCredentials?{xhrFields:{withCredentials:r.withCredentials}}:{};return t.ajax(t.extend(n,o,{url:e,type:r.verb,cache:!1,dataType:"json",async:r.async,timeout:r.timeout,success:function(e){typeof r.success==typeof f.noop&&r.success(e)},error:function(e,t,n){typeof r.error==typeof f.noop&&r.error(t,n)}}))}}},f.noop=function(){},f.dataChanDefaultLabel="JanusDataChannel",f.endOfCandidates=null;const u=c.proxy({name:"Janus",nameColor:"color: #fff;background-color:#c7254e;"});function f(e,r){if(void 0===f.initDone)return e.error("Library not initialized"),{};if(!f.isWebrtcSupported())return e.error("WebRTC not supported by this browser"),{};if(f.log("Library initialized: "+f.initDone),(e=e||{}).success="function"==typeof e.success?e.success:f.noop,e.error="function"==typeof e.error?e.error:f.noop,e.destroyed="function"==typeof e.destroyed?e.destroyed:f.noop,null===e.server||void 0===e.server)return e.error("Invalid server url"),{};var t=!1,n=null,o={},i=null,a=null,s=0,d=e.server;f.isArray(d)?(f.log("Multiple servers provided ("+d.length+"), will use the first that works"),d=null,a=e.server,f.debug(a)):0===d.indexOf("ws")?(t=!0,f.log("Using WebSockets to contact Janus: "+d)):(t=!1,f.log("Using REST API to contact Janus: "+d));var c=e.iceServers;null==c&&(c=[{urls:"stun:stun.l.google.com:19302"}]);var l=e.iceTransportPolicy,u=e.bundlePolicy,v=e.ipv6;null==v&&(v=!1);var g=!1;void 0!==e.withCredentials&&null!==e.withCredentials&&(g=!0===e.withCredentials);var p=10;void 0!==e.max_poll_events&&null!==e.max_poll_events&&(p=e.max_poll_events),p<1&&(p=1);var m=null;void 0!==e.token&&null!==e.token&&(m=e.token);var b=null;void 0!==e.apisecret&&null!==e.apisecret&&(b=e.apisecret),this.destroyOnUnload=!0,void 0!==e.destroyOnUnload&&null!==e.destroyOnUnload&&(this.destroyOnUnload=!0===e.destroyOnUnload);var h=25e3;void 0!==e.keepAlivePeriod&&null!==e.keepAlivePeriod&&(h=e.keepAlivePeriod),isNaN(h)&&(h=25e3);var w=6e4;function y(e){var r={high:9e5,medium:3e5,low:1e5};return null!=e&&(e.high&&(r.high=e.high),e.medium&&(r.medium=e.medium),e.high&&e.high<e.medium&&(r.medium=e.high),e.low&&(r.low=e.low)),r}void 0!==e.longPollTimeout&&null!==e.longPollTimeout&&(w=e.longPollTimeout),isNaN(w)&&(w=6e4);var S=!1,k=null,T={},C=this,A=0,D={};function R(){if(null!=k)if(f.debug("Long poll..."),S){var r=d+"/"+k+"?rid="+(new Date).getTime();null!=p&&(r=r+"&maxev="+p),null!=m&&(r=r+"&token="+encodeURIComponent(m)),null!=b&&(r=r+"&apisecret="+encodeURIComponent(b)),f.httpAPICall(r,{verb:"GET",withCredentials:g,success:I,timeout:w,error:function(r,t){if(f.error(r+":",t),++A>3)return S=!1,void e.error("Lost connection to the server (is it down?)");R()}})}else f.warn("Is the server down? (connected=false)")}function I(e,r){if(A=0,t||null==k||!0===r||R(),t||!f.isArray(e))if("keepalive"!==e.rtcgw)if("ack"!==e.rtcgw)if("success"!==e.rtcgw)if("trickle"===e.rtcgw){if(null==(d=e.sender))return void f.warn("Missing sender...");if(null==(l=T[d]))return void f.debug("This handle is not attached to this session");var o=e.candidate;f.debug("Got a trickled candidate on session "+k),f.debug(o);var i=l.webrtcStuff;i.pc&&i.remoteSdp?(f.log("Adding remote candidate:",o),o&&!0!==o.completed?i.pc.addIceCandidate(o):i.pc.addIceCandidate(f.endOfCandidates)):(f.debug("We didn't do setRemoteDescription (trickle got here before the offer?), caching candidate"),i.candidates||(i.candidates=[]),i.candidates.push(o),f.debug(i.candidates))}else{if("webrtcup"===e.rtcgw)return f.debug("Got a webrtcup event on session "+k),f.debug(e),null==(d=e.sender)?void f.warn("Missing sender..."):null==(l=T[d])?void f.debug("This handle is not attached to this session"):void l.webrtcState(!0);if("hangup"===e.rtcgw){if(f.debug("Got a hangup event on session "+k),f.debug(e),null==(d=e.sender))return void f.warn("Missing sender...");if(null==(l=T[d]))return void f.debug("This handle is not attached to this session");l.webrtcState(!1,e.reason),l.hangup()}else if("detached"===e.rtcgw){if(f.debug("Got a detached event on session "+k),f.debug(e),null==(d=e.sender))return void f.warn("Missing sender...");if(null==(l=T[d]))return;l.detached=!0,l.ondetached(),l.detach()}else if("media"===e.rtcgw){if(f.debug("Got a media event on session "+k),f.debug(e),null==(d=e.sender))return void f.warn("Missing sender...");if(null==(l=T[d]))return void f.debug("This handle is not attached to this session");l.mediaState(e.type,e.receiving)}else if("slowlink"===e.rtcgw){if(f.debug("Got a slowlink event on session "+k),null==(d=e.sender))return void f.warn("Missing sender...");if(null==(l=T[d]))return void f.debug("This handle is not attached to this session");l.slowLink(e.uplink,e.lost)}else{if("error"===e.rtcgw){var a,s;if(f.error("Ooops: "+e.error.code+" "+e.error.reason),f.debug(e),null!=(a=e.transaction))null!=(s=D[a])&&s(e),delete D[a];return}if("event"===e.rtcgw){var d;if(f.debug("Got a plugin event on session "+k),f.debug(e),null==(d=e.sender))return void f.warn("Missing sender...");var c=e.plugindata;if(null==c)return void f.warn("Missing plugindata...");f.debug("  -- Event is coming from "+d+" ("+c.plugin+")");var l,u=c.data;if(f.debug(u),null==(l=T[d]))return void f.warn("This handle is not attached to this session");var v=e.jsep;null!=v&&(f.debug("Handling SDP as well..."),f.debug(v));var g=l.onmessage;null!=g?(f.debug("Notifying application..."),g(u,v)):f.debug("No provided notification callback")}else{if("timeout"===e.rtcgw)return f.error("Timeout on session "+k),f.debug(e),void(t&&n.close(3504,"Gateway timeout"));f.warn("Unknown message/event  '"+e.rtcgw+"' on session "+k),f.debug(e)}}}else f.debug("Got a success on session "+k),f.debug(e),null!=(a=e.transaction)&&(null!=(s=D[a])&&s(e),delete D[a]);else f.debug("Got an ack on session "+k),f.debug(e),null!=(a=e.transaction)&&(null!=(s=D[a])&&s(e),delete D[a]);else f.vdebug("Got a keepalive on session "+k);else for(var p=0;p<e.length;p++)I(e[p],!0)}function V(){if(null!==d&&t&&S){i=setTimeout(V,h);var e={rtcgw:"keepalive",session_id:k,transaction:f.randomString(12)};null!=m&&(e.token=m),null!=b&&(e.apisecret=b),n.send(JSON.stringify(e))}}function P(c){var l=f.randomString(12),u={rtcgw:"create",transaction:l,token:"testtoken"};if(u=Object.assign({},u,r),c.reconnect&&(S=!1,u.rtcgw="claim",u.session_id=k,n&&(n.onopen=null,n.onerror=null,n.onclose=null,i&&(clearTimeout(i),i=null))),null!=m&&(u.token=m),null!=b&&(u.apisecret=b),null===d&&f.isArray(a)&&(0===(d=a[s]).indexOf("ws")?(t=!0,f.log("Server #"+(s+1)+": trying WebSockets to contact Janus ("+d+")")):(t=!1,f.log("Server #"+(s+1)+": trying REST API to contact Janus ("+d+")"))),t)for(var v in n=f.newWebSocket(d,"rtcgw-protocol"),o={error:function(){if(f.error("Error connecting to the Janus WebSockets server... "+d),f.isArray(a)&&!c.reconnect)return++s==a.length?void c.error("Error connecting to any of the provided Janus servers: Is the server down?"):(d=null,void setTimeout(function(){P(c)},200));c.error("Error connecting to the Janus WebSockets server: Is the server down?")},open:function(){D[l]=function(e){if(f.debug(e),"success"!==e.rtcgw)return f.error("Ooops: "+e.error.code+" "+e.error.reason),void c.error(e.error.reason);i=setTimeout(V,h),S=!0,k=e.session_id?e.session_id:e.data.id,c.reconnect?f.log("Claimed session: "+k):f.log("Created session: "+k),f.sessions[k]=C,c.success(k)},n.send(JSON.stringify(u))},message:function(e){I(JSON.parse(e.data))},close:function(){null!==d&&S&&(S=!1,e.error("Lost connection to the server"))}})n.addEventListener(v,o[v]);else f.httpAPICall(d,{verb:"POST",withCredentials:g,body:u,success:function(e){if(f.debug(e),"success"!==e.rtcgw)return f.error("Ooops: "+e.error.code+" "+e.error.reason),void c.error(e.error.reason);S=!0,k=e.session_id?e.session_id:e.data.id,c.reconnect?f.log("Claimed session: "+k):f.log("Created session: "+k),f.sessions[k]=C,R(),c.success()},error:function(e,r){if(f.error(e+":",r),f.isArray(a)&&!c.reconnect)return++s==a.length?void c.error("Error connecting to any of the provided Janus servers: Is the server down?"):(d=null,void setTimeout(function(){P(c)},200));""===r?c.error(e+": Is the server down?"):c.error(e+": "+r)}})}function O(e,r){if((r=r||{}).success="function"==typeof r.success?r.success:f.noop,r.error="function"==typeof r.error?r.error:f.noop,!S)return f.warn("Is the server down? (connected=false)"),void r.error("Is the server down? (connected=false)");var o=T[e];if(null==o||null===o.webrtcStuff||void 0===o.webrtcStuff)return f.warn("Invalid handle"),void r.error("Invalid handle");var i=r.message,a=r.jsep,s=f.randomString(12),c={rtcgw:"message",body:i,transaction:s};if(null!==o.token&&void 0!==o.token&&(c.token=o.token),null!=b&&(c.apisecret=b),null!=a&&(c.jsep=a),f.debug("Sending message to plugin (handle="+e+"):"),f.debug(c),t)return c.session_id=k,c.handle_id=e,D[s]=function(e){if(f.debug("Message sent!"),f.debug(e),"success"===e.rtcgw){var t=e.plugindata;if(null==t)return f.warn("Request succeeded, but missing plugindata..."),void r.success();f.log("Synchronous transaction successful ("+t.plugin+")");var n=t.data;return f.debug(n),void r.success(n)}"ack"===e.rtcgw?r.success():void 0!==e.error&&null!==e.error?(f.error("Ooops: "+e.error.code+" "+e.error.reason),r.error(e.error.code+" "+e.error.reason)):(f.error("Unknown error"),r.error("Unknown error"))},void n.send(JSON.stringify(c));f.httpAPICall(d+"/"+k+"/"+e,{verb:"POST",withCredentials:g,body:c,success:function(e){if(f.debug("Message sent!"),f.debug(e),"success"===e.rtcgw){var t=e.plugindata;if(null==t)return f.warn("Request succeeded, but missing plugindata..."),void r.success();f.log("Synchronous transaction successful ("+t.plugin+")");var n=t.data;return f.debug(n),void r.success(n)}"ack"===e.rtcgw?r.success():void 0!==e.error&&null!==e.error?(f.error("Ooops: "+e.error.code+" "+e.error.reason),r.error(e.error.code+" "+e.error.reason)):(f.error("Unknown error"),r.error("Unknown error"))},error:function(e,t){f.error(e+":",t),r.error(e+": "+t)}})}function E(e,r){if(S){var o=T[e];if(null!=o&&null!==o.webrtcStuff&&void 0!==o.webrtcStuff){var i={rtcgw:"trickle",candidate:r,transaction:f.randomString(12)};if(null!==o.token&&void 0!==o.token&&(i.token=o.token),null!=b&&(i.apisecret=b),f.vdebug("Sending trickle candidate (handle="+e+"):"),f.vdebug(i),t)return i.session_id=k,i.handle_id=e,void n.send(JSON.stringify(i));f.httpAPICall(d+"/"+k+"/"+e,{verb:"POST",withCredentials:g,body:i,success:function(e){f.vdebug("Candidate sent!"),f.vdebug(e),"ack"===e.rtcgw||f.error("Ooops: "+e.error.code+" "+e.error.reason)},error:function(e,r){f.error(e+":",r)}})}else f.warn("Invalid handle")}else f.warn("Is the server down? (connected=false)")}function x(e,r,t,n){var o=T[e];if(null!=o&&null!==o.webrtcStuff&&void 0!==o.webrtcStuff){var i=o.webrtcStuff,a=function(e){f.log("Received state change on data channel:",e);var r=e.target.label,t=i.dataChannel[r]?i.dataChannel[r].readyState:"null";if(f.log("State change on <"+r+"> data channel: "+t),"open"===t){if(i.dataChannel[r].pending&&i.dataChannel[r].pending.length>0){for(var n in f.log("Sending pending messages on <"+r+">:",i.dataChannel[r].pending.length),i.dataChannel[r].pending){var a=i.dataChannel[r].pending[n];f.log("Sending string on data channel <"+r+">: "+a),i.dataChannel[r].send(a)}i.dataChannel[r].pending=[]}o.ondataopen(r)}};i.dataChannel[r]=t||i.pc.createDataChannel(r,{ordered:!1}),i.dataChannel[r].onmessage=function(e){f.log("Received message on data channel:",e);var r=e.target.label;o.ondata(e.data,r)},i.dataChannel[r].onopen=a,i.dataChannel[r].onclose=a,i.dataChannel[r].onerror=function(e){f.error("Got error on data channel:",e)},i.dataChannel[r].pending=[],n&&i.dataChannel[r].pending.push(n)}else f.warn("Invalid handle")}function N(e,r){(r=r||{}).success="function"==typeof r.success?r.success:f.noop,r.error="function"==typeof r.error?r.error:f.noop;var t=T[e];if(null==t||null===t.webrtcStuff||void 0===t.webrtcStuff)return f.warn("Invalid handle"),void r.error("Invalid handle");var n=t.webrtcStuff,o=r.text;if(null==o)return f.warn("Invalid text"),void r.error("Invalid text");var i=r.label?r.label:f.dataChanDefaultLabel;return n.dataChannel[i]?"open"!==n.dataChannel[i].readyState?(n.dataChannel[i].pending.push(o),void r.success()):(f.log("Sending string on data channel <"+i+">: "+o),n.dataChannel[i].send(o),void r.success()):(x(e,i,!1,o),void r.success())}function M(e,r){(r=r||{}).success="function"==typeof r.success?r.success:f.noop,r.error="function"==typeof r.error?r.error:f.noop;var t=T[e];if(null==t||null===t.webrtcStuff||void 0===t.webrtcStuff)return f.warn("Invalid handle"),void r.error("Invalid handle");var n=t.webrtcStuff;if(null===n.dtmfSender||void 0===n.dtmfSender){if(void 0!==n.pc&&null!==n.pc){var o=n.pc.getSenders().find(function(e){return e.track&&"audio"===e.track.kind});if(!o)return f.warn("Invalid DTMF configuration (no audio track)"),void r.error("Invalid DTMF configuration (no audio track)");n.dtmfSender=o.dtmf,n.dtmfSender&&(f.log("Created DTMF Sender"),n.dtmfSender.ontonechange=function(e){f.debug("Sent DTMF tone: "+e.tone)})}if(null===n.dtmfSender||void 0===n.dtmfSender)return f.warn("Invalid DTMF configuration"),void r.error("Invalid DTMF configuration")}var i=r.dtmf;if(null==i)return f.warn("Invalid DTMF parameters"),void r.error("Invalid DTMF parameters");var a=i.tones;if(null==a)return f.warn("Invalid DTMF string"),void r.error("Invalid DTMF string");var s=i.duration;null==s&&(s=500);var d=i.gap;null==d&&(d=50),f.debug("Sending DTMF string "+a+" (duration "+s+"ms, gap "+d+"ms)"),n.dtmfSender.insertDTMF(a,s,d),r.success()}function L(e,r){(r=r||{}).success="function"==typeof r.success?r.success:f.noop,r.error="function"==typeof r.error?r.error:f.noop;var o=!0;void 0!==r.asyncRequest&&null!==r.asyncRequest&&(o=!0===r.asyncRequest);let i=!0===r.noRequest;void 0!==r.noRequest&&null!==r.noRequest&&(i=!0===r.noRequest),f.log("Destroying handle "+e+" (async="+o+")"),H(e);var a=T[e];if(null==a||a.detached)return delete T[e],void r.success();if(i)return delete T[e],void r.success();if(!S)return f.warn("Is the server down? (connected=false)"),void r.error("Is the server down? (connected=false)");var s={rtcgw:"detach",transaction:f.randomString(12)};if(null!==a.token&&void 0!==a.token&&(s.token=a.token),null!=b&&(s.apisecret=b),t)return s.session_id=k,s.handle_id=e,n.send(JSON.stringify(s)),delete T[e],void r.success();f.httpAPICall(d+"/"+k+"/"+e,{verb:"POST",async:o,withCredentials:g,body:s,success:function(t){f.log("Destroyed handle:"),f.debug(t),"success"!==t.rtcgw&&f.error("Ooops: "+t.error.code+" "+t.error.reason),delete T[e],r.success()},error:function(t,n){f.error(t+":",n),delete T[e],r.success()}})}async function _(e,r,t,o,i){f.debug("进入streamsDone函数");var a=T[e];if(null==a||null===a.webrtcStuff||void 0===a.webrtcStuff)return f.warn("Invalid handle"),void o.error("Invalid handle");var s=a.webrtcStuff;i&&(f.log("  -- Audio tracks:",i.getAudioTracks()),f.log("  -- Video tracks:",i.getVideoTracks()));var d=!1,g=!0===o.simulcast;const p=y(o.simulcastMaxBitrates),m={active:!0,scaleResolutionDownBy:1};o.bitrate&&(m.maxBitrate=o.bitrate),o.frameRate&&(m.maxFramerate=o.frameRate);const b=g?[{...m,rid:"h",priority:"high",maxBitrate:p.high},{...m,rid:"l",priority:"low",maxBitrate:p.low,scaleResolutionDownBy:4}]:[m];if(s.myStream&&t.update&&!s.streamExternal){if((!t.update&&Y(t)||t.update&&(t.addAudio||t.replaceAudio))&&i.getAudioTracks()&&i.getAudioTracks().length)if(s.myStream.addTrack(i.getAudioTracks()[0]),f.unifiedPlan){f.log((t.replaceAudio?"Replacing":"Adding")+" audio track:",i.getAudioTracks()[0]);var h=null;if((D=s.pc.getTransceivers())&&D.length>0)for(var w in D){if((I=D[w]).sender&&I.sender.track&&"audio"===I.sender.track.kind||I.receiver&&I.receiver.track&&"audio"===I.receiver.track.kind){h=I;break}}let e=null;try{e=await o.customizeAudioTrack(i)}catch(e){o.error(e)}var S,k,C,A;if(h&&h.sender)h.sender.replaceTrack((null===(S=e)||void 0===S||null===(k=S.getAudioTracks)||void 0===k||null===(k=k.call(S))||void 0===k?void 0:k[0])||i.getAudioTracks()[0]);else s.pc.addTrack((null===(C=e)||void 0===C||null===(A=C.getAudioTracks)||void 0===A||null===(A=A.call(C))||void 0===A?void 0:A[0])||i.getAudioTracks()[0],e||i)}else f.log((t.replaceAudio?"Replacing":"Adding")+" audio track:",i.getAudioTracks()[0]),s.pc.addTrack(i.getAudioTracks()[0],i);if((!t.update&&K(t)||t.update&&(t.addVideo||t.replaceVideo))&&i.getVideoTracks()&&i.getVideoTracks().length)if(s.myStream.addTrack(i.getVideoTracks()[0]),f.unifiedPlan){f.log((t.replaceVideo?"Replacing":"Adding")+" video track:",i.getVideoTracks()[0]);var D,R=null;if((D=s.pc.getTransceivers())&&D.length>0)for(var w in D){var I;if((I=D[w]).sender&&I.sender.track&&"video"===I.sender.track.kind||I.receiver&&I.receiver.track&&"video"===I.receiver.track.kind){R=I;break}}R&&R.sender?R.sender.replaceTrack(i.getVideoTracks()[0]):s.pc.addTransceiver(i.getVideoTracks()[0],{direction:"sendrecv",streams:[i],sendEncodings:b})}else f.log((t.replaceVideo?"Replacing":"Adding")+" video track:",i.getVideoTracks()[0]),s.pc.addTrack(i.getVideoTracks()[0],i)}else s.myStream=i,d=!0;if(!s.pc){var V={iceServers:c,iceTransportPolicy:l,bundlePolicy:u};"chrome"===f.webRTCAdapter.browserDetails.browser&&(V.sdpSemantics=f.webRTCAdapter.browserDetails.version<72?"plan-b":"unified-plan");var P={optional:[{DtlsSrtpKeyAgreement:!0}]};if(!0===v&&P.optional.push({googIPv6:!0}),o.rtcConstraints&&"object"==typeof o.rtcConstraints)for(var w in f.debug("Adding custom PeerConnection constraints:",o.rtcConstraints),o.rtcConstraints)P.optional.push(o.rtcConstraints[w]);"edge"===f.webRTCAdapter.browserDetails.browser&&(V.bundlePolicy="max-bundle"),f.log("创建PeerConnection实例"),s.pc=new RTCPeerConnection(V,P),f.debug(s.pc),s.pc.getStats&&(s.volume={},s.bitrate.value="0 kbits/sec"),f.log("Preparing local SDP and gathering candidates (trickle="+s.trickle+")"),s.pc.oniceconnectionstatechange=function(e){s.pc&&a.iceState(s.pc.iceConnectionState,n)},s.pc.onicecandidate=function(r){if(null==r.candidate||"edge"===f.webRTCAdapter.browserDetails.browser&&r.candidate.candidate.indexOf("endOfCandidates")>0)f.log("End of candidates."),s.iceDone=!0,!0===s.trickle?E(e,{completed:!0}):function(e,r){r=r||{},r.success="function"==typeof r.success?r.success:f.noop,r.error="function"==typeof r.error?r.error:f.noop;var t=T[e];if(null==t||null===t.webrtcStuff||void 0===t.webrtcStuff)return void f.warn("Invalid handle, not sending anything");var n=t.webrtcStuff;if(f.log("Sending offer/answer SDP..."),null===n.mySdp||void 0===n.mySdp)return void f.warn("Local SDP instance is invalid, not sending anything...");n.mySdp={type:n.pc.localDescription.type,sdp:n.pc.localDescription.sdp},!1===n.trickle&&(n.mySdp.trickle=!1);f.debug(r),n.sdpSent=!0,r.success(n.mySdp)}(e,o);else{var t={candidate:r.candidate.candidate,sdpMid:r.candidate.sdpMid,sdpMLineIndex:r.candidate.sdpMLineIndex};!0===s.trickle&&E(e,t)}},s.pc.ontrack=function(e){f.debug("进入peerConnection的ontrack事件"),f.log("监听到peerConnection连接，添加了新的RTCRtpReceiver:",e);let r=null;e.streams&&(s.remoteStream=e.streams[0],a.onremotestream(s.remoteStream),e.track.onended||(e.track.onended=function(e){f.log("流媒体轨道 关闭:",e),clearTimeout(r),r=null,s.remoteStream&&(s.remoteStream.removeTrack(e.target),a.onremotestream(s.remoteStream))},e.track.onmute=function(e){f.debug("Remote track muted:",e),r||(r=setTimeout(function(){try{f.log("流媒体轨道 移除：",e),s.remoteStream&&(s.remoteStream.removeTrack(e.target),a.onremotestream(s.remoteStream))}catch(e){f.error("流媒体轨道 移除失败，原因：",e)}r=null},2520))},e.track.onunmute=function(e){if(f.debug("Remote track flowing again:",e),null!=r)clearTimeout(r),r=null;else try{f.log("流媒体轨道 添加：",e),s.remoteStream.addTrack(e.target),a.onremotestream(s.remoteStream)}catch(e){f.errpr("流媒体轨道添加失败，原因：",e)}}))}}try{if(d&&null!=i)if(f.log("Adding local stream"),"screen"==o.media.video)i.getTracks().forEach(function(e){f.log("Adding local track:",e),"audio"===e.kind?s.pc.addTrack(e,i):s.pc.addTransceiver(e,{direction:"sendrecv",streams:[i],sendEncodings:[m]})});else{var O=i.getTracks();for(let e=0;e<O.length;e++){const r=O[e];if(f.log("Adding local track:",r),f.log("Adding local track settings:",r.getSettings()),"audio"===r.kind){var N,M;let e=null;try{e=await o.customizeAudioTrack(i)}catch(e){o.error(e)}s.pc.addTrack((null===(N=e)||void 0===N||null===(M=N.getAudioTracks)||void 0===M||null===(M=M.call(N))||void 0===M?void 0:M[0])||r,e||i)}else s.pc.addTransceiver(r,{direction:"sendrecv",streams:[i],sendEncodings:b})}}}catch(e){o.error(e)}(function(e){if(f.debug("isDataEnabled:",e),"edge"==f.webRTCAdapter.browserDetails.browser)return f.warn("Edge doesn't support data channels yet"),!1;return null!=e&&!0===e.data})(t)&&!s.dataChannel[f.dataChanDefaultLabel]&&(f.log("Creating data channel"),x(e,f.dataChanDefaultLabel,!1),s.pc.ondatachannel=function(r){f.log("Data channel created by Janus:",r),x(e,r.channel.label,r.channel)}),s.myStream&&a.onlocalstream(s.myStream),null==r?function(e,r,t){f.debug("进入createOffer函数"),t=t||{},t.success="function"==typeof t.success?t.success:f.noop,t.error="function"==typeof t.error?t.error:f.noop;var n=T[e];if(null==n||null===n.webrtcStuff||void 0===n.webrtcStuff)return f.warn("Invalid handle"),void t.error("Invalid handle");var o=n.webrtcStuff,i=!0===t.simulcast;i?f.log("Creating offer (iceDone="+o.iceDone+", simulcast="+i+")"):f.log("Creating offer (iceDone="+o.iceDone+")");var a={};if(f.unifiedPlan){var s=null,d=null,c=o.pc.getTransceivers();if(c&&c.length>0)for(var l in c){var u=c[l];u.sender&&u.sender.track&&"audio"===u.sender.track.kind||u.receiver&&u.receiver.track&&"audio"===u.receiver.track.kind?s||(s=u):(u.sender&&u.sender.track&&"video"===u.sender.track.kind||u.receiver&&u.receiver.track&&"video"===u.receiver.track.kind)&&(d||(d=u))}var v=Y(r),g=Q(r);v||g?v&&g?s&&(s.setDirection?s.setDirection("sendrecv"):s.direction="sendrecv",f.log("Setting audio transceiver to sendrecv:",s)):v&&!g?s&&(s.setDirection?s.setDirection("sendonly"):s.direction="sendonly",f.log("Setting audio transceiver to sendonly:",s)):!v&&g&&(s?(s.setDirection?s.setDirection("recvonly"):s.direction="recvonly",f.log("Setting audio transceiver to recvonly:",s)):(s=o.pc.addTransceiver("audio",{direction:"recvonly"}),f.log("Adding recvonly audio transceiver:",s))):r.removeAudio&&s&&(s.setDirection?s.setDirection("inactive"):s.direction="inactive",f.log("Setting audio transceiver to inactive:",s));var p=K(r),m=X(r);p||m?p&&m?d&&(d.setDirection?d.setDirection("sendrecv"):d.direction="sendrecv",f.log("Setting video transceiver to sendrecv:",d)):p&&!m?d&&(d.setDirection?d.setDirection("sendonly"):d.direction="sendonly",f.log("Setting video transceiver to sendonly:",d)):!p&&m&&(d?(d.setDirection?d.setDirection("recvonly"):d.direction="recvonly",f.log("Setting video transceiver to recvonly:",d)):(d=o.pc.addTransceiver("video",{direction:"recvonly"}),f.log("Adding recvonly video transceiver:",d))):r.removeVideo&&d&&(d.setDirection?d.setDirection("inactive"):d.direction="inactive",f.log("Setting video transceiver to inactive:",d))}else a.offerToReceiveAudio=Q(r),a.offerToReceiveVideo=X(r);var b=!0===t.iceRestart;b&&(a.iceRestart=!0);f.debug(a);var h=K(r);f.log("执行peerConnection.createOffer，生成sdp信息"),o.pc.createOffer(a).then(async function(e){f.debug(e);var r={type:e.type,sdp:e.sdp};return t.customizeSdp(r),e.sdp=r.sdp,h&&i&&("chrome"===f.webRTCAdapter.browserDetails.browser||"safari"===f.webRTCAdapter.browserDetails.browser?f.log("Enabling Simulcasting for Chrome (SDP munging)"):"firefox"!==f.webRTCAdapter.browserDetails.browser&&f.warn("simulcast=true, but this is not Chrome nor Firefox, ignoring")),o.mySdp=e.sdp,f.log("设置local sdp信息：",e),"firefox"===f.webRTCAdapter.browserDetails.browser?(await o.pc.setLocalDescription(e),f.log("火狐执行 setLocalDescription 完毕")):o.pc.setLocalDescription(e).catch(t.error),e}).then(e=>{o.mediaConstraints=a,o.iceDone||o.trickle?(f.log("Offer ready"),t.success(e)):f.log("Waiting for all candidates...")}).catch(t.error)}(e,t,o):s.pc.setRemoteDescription(r).then(function(){if(f.log("Remote description accepted!"),s.remoteSdp=r.sdp,s.candidates&&s.candidates.length>0){for(var n=0;n<s.candidates.length;n++){var i=s.candidates[n];f.log("Adding remote candidate:",i),i&&!0!==i.completed?s.pc.addIceCandidate(i):s.pc.addIceCandidate(f.endOfCandidates)}s.candidates=[]}!function(e,r,t){f.log("进入createAnswer函数"),t=t||{},t.success="function"==typeof t.success?t.success:f.noop,t.error="function"==typeof t.error?t.error:f.noop,t.customizeSdp="function"==typeof t.customizeSdp?t.customizeSdp:f.noop;var n=T[e];if(null==n||null===n.webrtcStuff||void 0===n.webrtcStuff)return f.warn("Invalid handle"),void t.error("Invalid handle");var o=n.webrtcStuff,i=!0===t.simulcast;i?f.log("Creating answer (iceDone="+o.iceDone+", simulcast="+i+")"):f.log("Creating answer (iceDone="+o.iceDone+")");var a=null;if(f.unifiedPlan){a={};var s=null,d=null,c=o.pc.getTransceivers();if(c&&c.length>0)for(var l in c){var u=c[l];u.sender&&u.sender.track&&"audio"===u.sender.track.kind||u.receiver&&u.receiver.track&&"audio"===u.receiver.track.kind?s||(s=u):(u.sender&&u.sender.track&&"video"===u.sender.track.kind||u.receiver&&u.receiver.track&&"video"===u.receiver.track.kind)&&(d||(d=u))}var v=Y(r),g=Q(r);if(v||g){if(v&&g){if(s)try{s.setDirection?s.setDirection("sendrecv"):s.direction="sendrecv",f.log("Setting audio transceiver to sendrecv:",s)}catch(e){f.error(e)}}else if(v&&!g)try{s&&(s.setDirection?s.setDirection("sendonly"):s.direction="sendonly",f.log("Setting audio transceiver to sendonly:",s))}catch(e){f.error(e)}else if(!v&&g)if(s)try{s.setDirection?s.setDirection("recvonly"):s.direction="recvonly",f.log("Setting audio transceiver to recvonly:",s)}catch(e){f.error(e)}else s=o.pc.addTransceiver("audio",{direction:"recvonly"}),f.log("Adding recvonly audio transceiver:",s)}else if(r.removeAudio&&s)try{s.setDirection?s.setDirection("inactive"):s.direction="inactive",f.log("Setting audio transceiver to inactive:",s)}catch(e){f.error(e)}var p=K(r),m=X(r);if(p||m){if(p&&m){if(d)try{d.setDirection?d.setDirection("sendrecv"):d.direction="sendrecv",f.log("Setting video transceiver to sendrecv:",d)}catch(e){f.error(e)}}else if(p&&!m){if(d)try{d.setDirection?d.setDirection("sendonly"):d.direction="sendonly",f.log("Setting video transceiver to sendonly:",d)}catch(e){f.error(e)}}else if(!p&&m)if(d)try{d.setDirection?d.setDirection("recvonly"):d.direction="recvonly",f.log("Setting video transceiver to recvonly:",d)}catch(e){f.error(e)}else d=o.pc.addTransceiver("video",{direction:"recvonly"}),f.log("Adding recvonly video transceiver:",d)}else if(r.removeVideo&&d)try{d.setDirection?d.setDirection("inactive"):d.direction="inactive",f.log("Setting video transceiver to inactive:",d)}catch(e){f.error(e)}}else a="firefox"==f.webRTCAdapter.browserDetails.browser||"edge"==f.webRTCAdapter.browserDetails.browser?{offerToReceiveAudio:Q(r),offerToReceiveVideo:X(r)}:{mandatory:{OfferToReceiveAudio:Q(r),OfferToReceiveVideo:X(r)}};f.debug(a);var b=K(r);if(b&&i&&"firefox"===f.webRTCAdapter.browserDetails.browser){f.log("Enabling Simulcasting for Firefox (RID)");var h=o.pc.getSenders()[1];f.log(h);var w=h.getParameters();f.log(w);const e=y(t.simulcastMaxBitrates);h.setParameters({encodings:[{rid:"high",active:!0,priority:"high",maxBitrate:e.high},{rid:"medium",active:!0,priority:"medium",maxBitrate:e.medium},{rid:"low",active:!0,priority:"low",maxBitrate:e.low}]})}o.pc.createAnswer(a).then(function(e){f.debug(e);var r={type:e.type,sdp:e.sdp};t.customizeSdp(r),e.sdp=r.sdp,f.log("Setting local description"),b&&i&&("chrome"===f.webRTCAdapter.browserDetails.browser?f.warn("simulcast=true, but this is an answer, and video breaks in Chrome if we enable it"):"firefox"!==f.webRTCAdapter.browserDetails.browser&&f.warn("simulcast=true, but this is not Chrome nor Firefox, ignoring")),o.mySdp=e.sdp,o.pc.setLocalDescription(e).catch(t.error),o.mediaConstraints=a,o.iceDone||o.trickle?t.success(e):f.log("Waiting for all candidates...")},t.error)}(e,t,o)},o.error)}function F(e,r,t){f.debug("进入prepareWebrtc函数"),(t=t||{}).success="function"==typeof t.success?t.success:f.noop,t.error="function"==typeof t.error?t.error:$,t.customizeSdp="function"==typeof t.customizeSdp?t.customizeSdp:f.noop,t.customizeAudioTrack="function"==typeof t.customizeAudioTrack?t.customizeAudioTrack:f.noop;var n=t.jsep;if(r&&n)return f.error("Provided a JSEP to a createOffer"),void t.error("Provided a JSEP to a createOffer");if(!(r||n&&n.type&&n.sdp))return f.error("A valid JSEP is required for createAnswer"),void t.error("A valid JSEP is required for createAnswer");t.media=t.media||{audio:!0,video:!0};var o=t.media,i=T[e];if(null==i||null===i.webrtcStuff||void 0===i.webrtcStuff)return f.warn("Invalid handle"),void t.error("Invalid handle");var a,s=i.webrtcStuff;if(s.trickle=(a=t.trickle,f.debug("isTrickleEnabled:",a),null==a||!0===a),void 0===s.pc||null===s.pc)o.update=!1,o.keepAudio=!1,o.keepVideo=!1;else if(void 0!==s.pc&&null!==s.pc){if(f.log("Updating existing media session"),o.update=!0,null!==t.stream&&void 0!==t.stream)t.stream!==s.myStream&&f.log("Renegotiation involves a new external stream");else{if(o.addAudio){if(o.keepAudio=!1,o.replaceAudio=!1,o.removeAudio=!1,o.audioSend=!0,s.myStream&&s.myStream.getAudioTracks()&&s.myStream.getAudioTracks().length)return f.error("Can't add audio stream, there already is one"),void t.error("Can't add audio stream, there already is one")}else o.removeAudio?(o.keepAudio=!1,o.replaceAudio=!1,o.addAudio=!1,o.audioSend=!1):o.replaceAudio&&(o.keepAudio=!1,o.addAudio=!1,o.removeAudio=!1,o.audioSend=!0);if(null===s.myStream||void 0===s.myStream?(o.replaceAudio&&(o.keepAudio=!1,o.replaceAudio=!1,o.addAudio=!0,o.audioSend=!0),Y(o)&&(o.keepAudio=!1,o.addAudio=!0)):null===s.myStream.getAudioTracks()||void 0===s.myStream.getAudioTracks()||0===s.myStream.getAudioTracks().length?(o.replaceAudio&&(o.keepAudio=!1,o.replaceAudio=!1,o.addAudio=!0,o.audioSend=!0),Y(o)&&(o.keepVideo=!1,o.addAudio=!0)):!Y(o)||o.removeAudio||o.replaceAudio||(o.keepAudio=!0),o.addVideo){if(o.keepVideo=!1,o.replaceVideo=!1,o.removeVideo=!1,o.videoSend=!0,s.myStream&&s.myStream.getVideoTracks()&&s.myStream.getVideoTracks().length)return f.error("Can't add video stream, there already is one"),void t.error("Can't add video stream, there already is one")}else o.removeVideo?(o.keepVideo=!1,o.replaceVideo=!1,o.addVideo=!1,o.videoSend=!1):o.replaceVideo&&(o.keepVideo=!1,o.addVideo=!1,o.removeVideo=!1,o.videoSend=!0);null===s.myStream||void 0===s.myStream||null===s.myStream.getVideoTracks()||void 0===s.myStream.getVideoTracks()||0===s.myStream.getVideoTracks().length?(o.replaceVideo&&(o.keepVideo=!1,o.replaceVideo=!1,o.addVideo=!0,o.videoSend=!0),K(o)&&(o.keepVideo=!1,o.addVideo=!0)):!K(o)||o.removeVideo||o.replaceVideo||(o.keepVideo=!0),o.addData&&(o.data=!0)}if(Y(o)&&o.keepAudio&&K(o)&&o.keepVideo)return i.consentDialog(!1),void _(e,n,o,t,s.myStream)}if(o.update&&!s.streamExternal){if(o.removeAudio||o.replaceAudio){if(s.myStream&&s.myStream.getAudioTracks()&&s.myStream.getAudioTracks().length){var d=s.myStream.getAudioTracks()[0];f.log("Removing audio track:",d);try{d.stop(),s.myStream.removeTrack(d)}catch(D){}}if(s.pc.getSenders()&&s.pc.getSenders().length){var c=!0;if(o.replaceAudio&&f.unifiedPlan&&(c=!1),c)for(var l in s.pc.getSenders()){(d=s.pc.getSenders()[l])&&d.track&&"audio"===d.track.kind&&(f.log("Removing audio sender:",d),s.pc.removeTrack(d))}}}if(o.removeVideo||o.replaceVideo){if(s.myStream&&s.myStream.getVideoTracks()&&s.myStream.getVideoTracks().length){d=s.myStream.getVideoTracks()[0];f.log("Removing video track:",d);try{d.stop(),s.myStream.removeTrack(d)}catch(R){}}if(s.pc.getSenders()&&s.pc.getSenders().length){var u=!0;if(o.replaceVideo&&f.unifiedPlan&&(u=!1),u)for(var l in s.pc.getSenders()){(d=s.pc.getSenders()[l])&&d.track&&"video"===d.track.kind&&(f.log("Removing video sender:",d),s.pc.removeTrack(d))}}}}if(null!==t.stream&&void 0!==t.stream){var v=t.stream;if(f.log("MediaStream provided by the application"),f.debug(v),o.update&&s.myStream&&s.myStream!==t.stream&&!s.streamExternal){try{var g=s.myStream.getTracks();for(var p in g){var m=g[p];f.log(m),null!=m&&m.stop()}}catch(I){}s.myStream=null}return s.streamExternal=!0,i.consentDialog(!1),void _(e,n,o,t,v)}if(Y(o)||K(o)){if(!f.isGetUserMediaAvailable())return void t.error("getUserMedia not available");var b={mandatory:{},optional:[]};i.consentDialog(!0);var h=Y(o);!0===h&&null!=o&&null!=o&&"object"==typeof o.audio&&(h=o.audio);var w=K(o);if(!0===w&&null!=o&&null!=o)if(!(!0===t.simulcast)||n||void 0!==o.video&&!1!==o.video||(o.video="hires"),o.video&&"screen"!=o.video&&"window"!=o.video)if("object"==typeof o.video)w=o.video;else{var y=0,S=0;"lowres"===o.video?(S=240,y=320):"lowres-16:9"===o.video?(S=180,y=320):"hires"===o.video||"hires-16:9"===o.video||"hdres"===o.video?(S=720,y=1280):"fhdres"===o.video?(S=1080,y=1920):"4kres"===o.video?(S=2160,y=3840):"stdres"===o.video?(S=480,y=640):"stdres-16:9"===o.video?(S=360,y=640):(f.log("Default video setting is stdres 4:3"),S=480,y=640),f.log("Adding media constraint:",o.video),w={height:{ideal:S,max:S},width:{ideal:y,max:y}},f.log("Adding video constraint:",w)}else if("screen"===o.video||"window"===o.video){if(o.screenshareFrameRate||(o.screenshareFrameRate=3),navigator.mediaDevices&&navigator.mediaDevices.getDisplayMedia){const O={};t.screenWidth&&(O.width={ideal:t.screenWidth}),t.screenHeight&&(O.height={ideal:t.screenHeight}),t.displaySurface&&(O.displaySurface=t.displaySurface);const E=!(O.width||O.height||O.displaySurface)||O;return f.log("采集屏幕约束条件设置：",E),void navigator.mediaDevices.getDisplayMedia({video:E}).then(function(r){function a(){var a;i.consentDialog(!1),O.frameRate={exact:t.frameRate||15},r.getVideoTracks()[0].applyConstraints(O),(null===(a=r.getVideoTracks()[0])||void 0===a?void 0:a.getCapabilities)&&f.log("采集到的屏幕约束条件范围：",r.getVideoTracks()[0].getCapabilities()),f.log("采集到的屏幕约束条件：",r.getVideoTracks()[0].getSettings()),Y(o)&&!o.keepAudio?navigator.mediaDevices.getUserMedia({audio:!0,video:!1}).then(function(i){r.addTrack(i.getAudioTracks()[0]),_(e,n,o,t,r)}):_(e,n,o,t,r)}"safari"===f.webRTCAdapter.browserDetails.browser?setTimeout(a,1500):a()}).catch(e=>{i.consentDialog(!1),t.error(e)})}function V(r,a){i.consentDialog(!1),r?t.error(r):_(e,n,o,t,a)}function P(e,r,t){f.log("Adding media constraint (screen capture)"),f.debug(e),navigator.mediaDevices.getUserMedia(e).then(function(e){t?navigator.mediaDevices.getUserMedia({audio:!0,video:!1}).then(function(t){e.addTrack(t.getAudioTracks()[0]),r(null,e)}):r(null,e)}).catch(function(e){i.consentDialog(!1),r(e)})}if("chrome"===f.webRTCAdapter.browserDetails.browser){var k=f.webRTCAdapter.browserDetails.version,C=33;window.navigator.userAgent.match("Linux")&&(C=35),k>=26&&k<=C?P(b={video:{mandatory:{googLeakyBucket:!0,maxWidth:window.screen.width,maxHeight:window.screen.height,minFrameRate:o.screenshareFrameRate,maxFrameRate:o.screenshareFrameRate,chromeMediaSource:"screen"}},audio:Y(o)&&!o.keepAudio},V):f.extension.getScreen(function(e,r){if(e)return i.consentDialog(!1),t.error(e);(b={audio:!1,video:{mandatory:{chromeMediaSource:"desktop",maxWidth:window.screen.width,maxHeight:window.screen.height,minFrameRate:o.screenshareFrameRate,maxFrameRate:o.screenshareFrameRate},optional:[{googLeakyBucket:!0},{googTemporalLayeredScreencast:!0}]}}).video.mandatory.chromeMediaSourceId=r,P(b,V,Y(o)&&!o.keepAudio)})}else if("firefox"===f.webRTCAdapter.browserDetails.browser){if(!(f.webRTCAdapter.browserDetails.version>=33)){var A=new Error("NavigatorUserMediaError");return A.name="Your version of Firefox does not support screen sharing, please install Firefox 33 (or more recent versions)",i.consentDialog(!1),void t.error(A)}P(b={video:{mozMediaSource:o.video,mediaSource:o.video},audio:Y(o)&&!o.keepAudio},function(e,r){if(V(e,r),!e)var t=r.currentTime,n=window.setInterval(function(){r||window.clearInterval(n),r.currentTime==t&&(window.clearInterval(n),r.onended&&r.onended()),t=r.currentTime},500)})}return}null!=o&&"screen"===o.video||navigator.mediaDevices.enumerateDevices().then(function(r){var a=r.some(function(e){return"audioinput"===e.kind}),s=function(e){if(f.debug("isScreenSendEnabled:",e),null==e)return!1;if("object"!=typeof e.video||"object"!=typeof e.video.mandatory)return!1;var r=e.video.mandatory;if(r.chromeMediaSource)return"desktop"===r.chromeMediaSource||"screen"===r.chromeMediaSource;if(r.mozMediaSource)return"window"===r.mozMediaSource||"screen"===r.mozMediaSource;if(r.mediaSource)return"window"===r.mediaSource||"screen"===r.mediaSource;return!1}(o)||r.some(function(e){return"videoinput"===e.kind}),d=Y(o),c=K(o),l=function(e){return f.debug("isAudioSendRequired:",e),null!=e&&(!1!==e.audio&&!1!==e.audioSend&&(void 0!==e.failIfNoAudio&&null!==e.failIfNoAudio&&!0===e.failIfNoAudio))}(o),u=function(e){return f.debug("isVideoSendRequired:",e),null!=e&&(!1!==e.video&&!1!==e.videoSend&&(void 0!==e.failIfNoVideo&&null!==e.failIfNoVideo&&!0===e.failIfNoVideo))}(o);if(d||c||l||u){var g=!!d&&a,p=!!c&&s;if(!g&&!p)return i.consentDialog(!1),t.error("No capture device found"),!1;if(!g&&l)return i.consentDialog(!1),t.error("Audio capture is required, but no capture device found"),!1;if(!p&&u)return i.consentDialog(!1),t.error("Video capture is required, but no capture device found"),!1}let m={audio:!(!a||o.keepAudio)&&h,video:!(!s||o.keepVideo)&&w};if(o.encodings&&(m=o.encodings),f.log("采集音视频约束条件设置：",m),m.audio||m.video){const r=3,a=function(s){let d=!1,c=window.setTimeout(()=>{f.log(`getUserMedia重试次数：${s}`),d=!0,c=null,s>=r?t.error("getUserMedia timeout"):a(++s)},3e3);navigator.mediaDevices.getUserMedia(o.encodings?o.encodings:m).then(async function(r){var a;if(d)return void r.getTracks().forEach(e=>{e.stop()});i.consentDialog(!1);const s=null===(a=r.getVideoTracks())||void 0===a?void 0:a[0],c={...m.video,frameRate:{ideal:t.frameRate,max:t.frameRate}};var l;s&&(s.applyConstraints(c),(null===(l=r.getVideoTracks()[0])||void 0===l?void 0:l.getCapabilities)&&f.log("摄像头采集后，约束条件范围：",r.getVideoTracks()[0].getCapabilities()),f.log("摄像头采集后，约束条件：",r.getVideoTracks()[0].getSettings()));_(e,n,o,t,r)}).catch(function(e){i.consentDialog(!1),t.error({code:e.code,name:e.name,message:e.message})}).finally(()=>{window.clearTimeout(c),c=null})};a(1)}else i.consentDialog(!1),_(e,n,o,t,v)}).catch(function(e){i.consentDialog(!1),t.error(`enumerateDevices error：${e}`)})}else _(e,n,o,t)}function j(e,r){(r=r||{}).success="function"==typeof r.success?r.success:f.noop,r.error="function"==typeof r.error?r.error:$;var t=r.jsep,n=T[e];if(null==n||null===n.webrtcStuff||void 0===n.webrtcStuff)return f.warn("Invalid handle"),void r.error("Invalid handle");var o=n.webrtcStuff;if(null!=t){if(null===o.pc)return f.warn("Wait, no PeerConnection?? if this is an answer, use createAnswer and not handleRemoteJsep"),void r.error("No PeerConnection: if this is an answer, use createAnswer and not handleRemoteJsep");o.pc.setRemoteDescription(t).then(function(){if(f.log("设置remote sdp成功"),o.remoteSdp=t.sdp,o.candidates&&o.candidates.length>0){for(var e=0;e<o.candidates.length;e++){var n=o.candidates[e];f.log("Adding remote candidate:",n),n&&!0!==n.completed?o.pc.addIceCandidate(n):o.pc.addIceCandidate(f.endOfCandidates)}o.candidates=[]}r.success()},r.error)}else r.error("Invalid JSEP")}function U(e,r){var t=T[e];if(null==t||null===t.webrtcStuff||void 0===t.webrtcStuff)return f.warn("Invalid handle"),0;var n=r?"remote":"local",o=t.webrtcStuff;return o.volume[n]||(o.volume[n]={value:0}),o.pc.getStats&&"chrome"===f.webRTCAdapter.browserDetails.browser?!r||null!==o.remoteStream&&void 0!==o.remoteStream?r||null!==o.myStream&&void 0!==o.myStream?null===o.volume[n].timer||void 0===o.volume[n].timer?(f.log("Starting "+n+" volume monitor"),o.volume[n].timer=setInterval(function(){o.pc.getStats(function(e){for(var t=e.result(),i=0;i<t.length;i++){var a=t[i];"ssrc"==a.type&&(r&&a.stat("audioOutputLevel")?o.volume[n].value=parseInt(a.stat("audioOutputLevel")):!r&&a.stat("audioInputLevel")&&(o.volume[n].value=parseInt(a.stat("audioInputLevel"))))}})},200),0):o.volume[n].value:(f.warn("Local stream unavailable"),0):(f.warn("Remote stream unavailable"),0):(f.warn("Getting the "+n+" volume unsupported by browser"),0)}function J(e,r){var t=T[e];if(null==t||null===t.webrtcStuff||void 0===t.webrtcStuff)return f.warn("Invalid handle"),!0;var n=t.webrtcStuff;return null===n.pc||void 0===n.pc?(f.warn("Invalid PeerConnection"),!0):void 0===n.myStream||null===n.myStream?(f.warn("Invalid local MediaStream"),!0):r?null===n.myStream.getVideoTracks()||void 0===n.myStream.getVideoTracks()||0===n.myStream.getVideoTracks().length?(f.warn("No video track"),!0):!n.myStream.getVideoTracks()[0].enabled:null===n.myStream.getAudioTracks()||void 0===n.myStream.getAudioTracks()||0===n.myStream.getAudioTracks().length?(f.warn("No audio track"),!0):!n.myStream.getAudioTracks()[0].enabled}function W(e,r,t){var n=T[e];if(null==n||null===n.webrtcStuff||void 0===n.webrtcStuff)return f.warn("Invalid handle"),!1;var o=n.webrtcStuff;return null===o.pc||void 0===o.pc?(f.warn("Invalid PeerConnection"),!1):void 0===o.myStream||null===o.myStream?(f.warn("Invalid local MediaStream"),!1):r?null===o.myStream.getVideoTracks()||void 0===o.myStream.getVideoTracks()||0===o.myStream.getVideoTracks().length?(f.warn("No video track"),!1):(o.myStream.getVideoTracks()[0].enabled=!t,!0):null===o.myStream.getAudioTracks()||void 0===o.myStream.getAudioTracks()||0===o.myStream.getAudioTracks().length?(f.warn("No audio track"),!1):(o.myStream.getAudioTracks()[0].enabled=!t,!0)}function q(e,r){var t=T[e];if(null==t||null===t.webrtcStuff||void 0===t.webrtcStuff)return f.warn("Invalid handle"),"Invalid handle";var n=t.webrtcStuff;return null===n.pc||void 0===n.pc?"Invalid PeerConnection":n.pc.getStats?void n.pc.getStats().then(function(e){const t={};e.forEach(function(e){if(!e)return;let r=!1;if(t[e.type]=e,("inbound-rtp"===e.type||"outbound-rtp"===e.type)&&e.id.indexOf("rtcp")<0?r=!0:("ssrc"!=e.type||!e.bytesReceived||"VP8"!==e.googCodecName&&""!==e.googCodecName)&&("ssrc"!=e.type||!e.bytesSent||"VP8"!==e.googCodecName&&""!==e.googCodecName)||(r=!0),r)if(n.bitrate.bsnow=e.bytesReceived,n.bitrate.tsnow=e.timestamp,null===n.bitrate.bsbefore||null===n.bitrate.tsbefore)n.bitrate.bsbefore=n.bitrate.bsnow,n.bitrate.tsbefore=n.bitrate.tsnow;else{var o=n.bitrate.tsnow-n.bitrate.tsbefore;"safari"==f.webRTCAdapter.browserDetails.browser&&(o/=1e3);var i=Math.round(8*(n.bitrate.bsnow-n.bitrate.bsbefore)/o);"safari"===f.webRTCAdapter.browserDetails.browser&&(i=parseInt(i/1e3)),n.bitrate.value=i+" kbits/sec",n.bitrate.bsbefore=n.bitrate.bsnow,n.bitrate.tsbefore=n.bitrate.tsnow}}),r&&r(t)}):(f.warn("Getting the video bitrate unsupported by browser"),"Feature unsupported by browser")}function G(e,r,t){const n=T[e];n.listenList[r]||(n.listenList[r]=[]);for(var o=0;o<n.listenList[r].length;o++)if(n.listenList[r][o].fn===t)return;n.listenList[r].push({time:(new Date).getTime(),fn:t})}function z(e,r,t){const n=T[e],o=n.listenList[r];if(!o||0===o.length)return!1;(new Date).getTime();for(let e=0;e<o.length;e++){o[e].fn.call(n,t)}n.listenList[r]=null}function B(e){var r=T[e];if(null==r||null===r.webrtcStuff||void 0===r.webrtcStuff)return f.warn("Invalid handle"),"Invalid handle";var t=r.webrtcStuff;return null===t.pc||void 0===t.pc?"Invalid PeerConnection":t.pc.getStats?null===t.bitrate.timer||void 0===t.bitrate.timer?(f.log("Starting bitrate timer (via getStats)"),t.bitrate.timer=setInterval(function(){t.pc.getStats().then(function(e){e.forEach(function(e){if(e){var r=!1;if(("video"===e.mediaType||e.id.toLowerCase().indexOf("video")>-1)&&"inbound-rtp"===e.type&&e.id.indexOf("rtcp")<0?r=!0:"ssrc"!=e.type||!e.bytesReceived||"VP8"!==e.googCodecName&&""!==e.googCodecName||(r=!0),r)if(t.bitrate.bsnow=e.bytesReceived,t.bitrate.tsnow=e.timestamp,null===t.bitrate.bsbefore||null===t.bitrate.tsbefore)t.bitrate.bsbefore=t.bitrate.bsnow,t.bitrate.tsbefore=t.bitrate.tsnow;else{var n=t.bitrate.tsnow-t.bitrate.tsbefore;"safari"==f.webRTCAdapter.browserDetails.browser&&(n/=1e3);var o=Math.round(8*(t.bitrate.bsnow-t.bitrate.bsbefore)/n);"safari"===f.webRTCAdapter.browserDetails.browser&&(o=parseInt(o/1e3)),t.bitrate.value=o+" kbits/sec",t.bitrate.bsbefore=t.bitrate.bsnow,t.bitrate.tsbefore=t.bitrate.tsnow}}})})},1e3),"0 kbits/sec"):t.bitrate.value:(f.warn("Getting the video bitrate unsupported by browser"),"Feature unsupported by browser")}function $(e){f.error("WebRTC error:",e)}function H(e,r){f.log("Cleaning WebRTC stuff");var o=T[e];if(null!=o){var i=o.webrtcStuff;if(null!=i){if(!0===r){var a={rtcgw:"hangup",transaction:f.randomString(12)};null!==o.token&&void 0!==o.token&&(a.token=o.token),null!=b&&(a.apisecret=b),f.debug("Sending hangup request (handle="+e+"):"),f.debug(a),t?(a.session_id=k,a.handle_id=e,n.send(JSON.stringify(a))):f.httpAPICall(d+"/"+k+"/"+e,{verb:"POST",withCredentials:g,body:a})}i.remoteStream=null,i.volume&&(i.volume.local&&i.volume.local.timer&&clearInterval(i.volume.local.timer),i.volume.remote&&i.volume.remote.timer&&clearInterval(i.volume.remote.timer)),i.volume={},i.bitrate.timer&&clearInterval(i.bitrate.timer),i.bitrate.timer=null,i.bitrate.bsnow=null,i.bitrate.bsbefore=null,i.bitrate.tsnow=null,i.bitrate.tsbefore=null,i.bitrate.value=null;try{if(!i.streamExternal&&null!==i.myStream&&void 0!==i.myStream){f.log("Stopping local stream tracks");var s=i.myStream.getTracks();for(var c in s){var l=s[c];f.log(l),null!=l&&l.stop()}}}catch(e){}i.streamExternal=!1,i.myStream=null;try{f.log("关闭peerConnection"),i.pc.close()}catch(e){}i.pc=null,i.candidates=null,i.mySdp=null,i.remoteSdp=null,i.iceDone=!1,i.dataChannel={},i.dtmfSender=null}o.oncleanup()}}function Y(e){return f.debug("isAudioSendEnabled:",e),null==e||!1!==e.audio&&(void 0===e.audioSend||null===e.audioSend||!0===e.audioSend)}function Q(e){return f.debug("isAudioRecvEnabled:",e),null==e||!1!==e.audio&&(void 0===e.audioRecv||null===e.audioRecv||!0===e.audioRecv)}function K(e){return f.debug("isVideoSendEnabled:",e),null==e||!1!==e.video&&(void 0===e.videoSend||null===e.videoSend||!0===e.videoSend)}function X(e){return f.debug("isVideoRecvEnabled:",e),null==e||!1!==e.video&&(void 0===e.videoRecv||null===e.videoRecv||!0===e.videoRecv)}P(e),this.getServer=function(){return d},this.isConnected=function(){return S},this.reconnect=function(e){(e=e||{}).success="function"==typeof e.success?e.success:f.noop,e.error="function"==typeof e.error?e.error:f.noop,e.reconnect=!0,P(e)},this.getSessionId=function(){return k},this.destroy=function(r){!function(r){r=r||{},r.success="function"==typeof r.success?r.success:f.noop;var a=!0;void 0!==r.asyncRequest&&null!==r.asyncRequest&&(a=!0===r.asyncRequest);var s=!0;void 0!==r.notifyDestroyed&&null!==r.notifyDestroyed&&(s=!0===r.notifyDestroyed);var c=!1;void 0!==r.cleanupHandles&&null!==r.cleanupHandles&&(c=!0===r.cleanupHandles);if(f.log("Destroying session "+k+" (async="+a+")"),!S)return f.warn("Is the server down? (connected=false)"),void r.success();if(null==k)return f.warn("No session to destroy"),r.success(),void(s&&e.destroyed());if(c)for(var l in T)L(l,{noRequest:!0});var u={rtcgw:"destroy",transaction:f.randomString(12)};null!=m&&(u.token=m);null!=b&&(u.apisecret=b);if(t){u.session_id=k;var v=function(){for(var e in o)n.removeEventListener(e,o[e]);n.removeEventListener("message",p),n.removeEventListener("error",h),i&&clearTimeout(i),n.close()},p=function(t){var n=JSON.parse(t.data);n.session_id==u.session_id&&n.transaction==u.transaction&&(v(),r.success(),s&&e.destroyed())},h=function(t){v(),r.error("Failed to destroy the server: Is the server down?"),s&&e.destroyed()};return n.addEventListener("message",p),n.addEventListener("error",h),void n.send(JSON.stringify(u))}f.httpAPICall(d+"/"+k,{verb:"POST",async:a,withCredentials:g,body:u,success:function(t){f.log("Destroyed session:"),f.debug(t),k=null,S=!1,"success"!==t.rtcgw&&f.error("Ooops: "+t.error.code+" "+t.error.reason),r.success(),s&&e.destroyed()},error:function(t,n){f.error(t+":",n),k=null,S=!1,r.success(),s&&e.destroyed(),pluginHandlesp}})}(r)},this.attach=function(e){!function(e){if(e=e||{},e.success="function"==typeof e.success?e.success:f.noop,e.error="function"==typeof e.error?e.error:f.noop,e.consentDialog="function"==typeof e.consentDialog?e.consentDialog:f.noop,e.iceState="function"==typeof e.iceState?e.iceState:f.noop,e.mediaState="function"==typeof e.mediaState?e.mediaState:f.noop,e.webrtcState="function"==typeof e.webrtcState?e.webrtcState:f.noop,e.slowLink="function"==typeof e.slowLink?e.slowLink:f.noop,e.onmessage="function"==typeof e.onmessage?e.onmessage:f.noop,e.onlocalstream="function"==typeof e.onlocalstream?e.onlocalstream:f.noop,e.onremotestream="function"==typeof e.onremotestream?e.onremotestream:f.noop,e.ondata="function"==typeof e.ondata?e.ondata:f.noop,e.ondataopen="function"==typeof e.ondataopen?e.ondataopen:f.noop,e.oncleanup="function"==typeof e.oncleanup?e.oncleanup:f.noop,e.ondetached="function"==typeof e.ondetached?e.ondetached:f.noop,!S)return f.warn("Is the server down? (connected=false)"),void e.error("Is the server down? (connected=false)");var r=e.plugin;if(null==r)return f.error("Invalid plugin"),void e.error("Invalid plugin");var o=e.opaqueId,i=e.token?e.token:m,a=f.randomString(12),s={rtcgw:"attach",plugin:r,opaque_id:o,transaction:a};null!=i&&(s.token=i);null!=b&&(s.apisecret=b);if(t)return D[a]=function(t){if(f.debug(t),"success"!==t.rtcgw)return f.error("Ooops: "+t.error.code+" "+t.error.reason),void e.error("Ooops: "+t.error.code+" "+t.error.reason);var n=t.data.id;f.log("Created handle: "+n);var o={session:C,plugin:r,id:n,token:i,detached:!1,webrtcStuff:{started:!1,myStream:null,streamExternal:!1,remoteStream:null,mySdp:null,mediaConstraints:null,pc:null,dataChannel:{},dtmfSender:null,trickle:!0,iceDone:!1,volume:{value:null,timer:null},bitrate:{value:null,bsnow:null,bsbefore:null,tsnow:null,tsbefore:null,timer:null}},listenList:[],getId:function(){return n},getPlugin:function(){return r},getVolume:function(){return U(n,!0)},getRemoteVolume:function(){return U(n,!0)},getLocalVolume:function(){return U(n,!1)},isAudioMuted:function(){return J(n,!1)},muteAudio:function(){return W(n,!1,!0)},unmuteAudio:function(){return W(n,!1,!1)},isVideoMuted:function(){return J(n,!0)},muteVideo:function(){return W(n,!0,!0)},unmuteVideo:function(){return W(n,!0,!1)},getBitrate:function(){return B(n)},getNetworkQuality:function(e,r){q(e,r)},messageListen:function(e,r){G(n,e,r)},messageTrigger:function(e,r){z(n,e,r)},send:function(e){O(n,e)},data:function(e){N(n,e)},dtmf:function(e){M(n,e)},consentDialog:e.consentDialog,iceState:e.iceState,mediaState:e.mediaState,webrtcState:e.webrtcState,slowLink:e.slowLink,onmessage:e.onmessage,createOffer:function(e){F(n,!0,e)},createAnswer:function(e){F(n,!1,e)},handleRemoteJsep:function(e){j(n,e)},onlocalstream:e.onlocalstream,onremotestream:e.onremotestream,ondata:e.ondata,ondataopen:e.ondataopen,oncleanup:e.oncleanup,ondetached:e.ondetached,hangup:function(e){H(n,!0===e)},detach:function(e){L(n,e)}};T[n]=o,e.success(o)},s.session_id=k,void n.send(JSON.stringify(s));f.httpAPICall(d+"/"+k,{verb:"POST",withCredentials:g,body:s,success:function(t){if(f.debug(t),"success"!==t.rtcgw)return f.error("Ooops: "+t.error.code+" "+t.error.reason),void e.error("Ooops: "+t.error.code+" "+t.error.reason);var n=t.data.id;f.log("Created handle: "+n);var o={session:C,plugin:r,id:n,token:i,detached:!1,webrtcStuff:{started:!1,myStream:null,streamExternal:!1,remoteStream:null,mySdp:null,mediaConstraints:null,pc:null,dataChannel:{},dtmfSender:null,trickle:!0,iceDone:!1,volume:{value:null,timer:null},bitrate:{value:null,bsnow:null,bsbefore:null,tsnow:null,tsbefore:null,timer:null}},listenList:[],getId:function(){return n},getPlugin:function(){return r},getVolume:function(){return U(n,!0)},getRemoteVolume:function(){return U(n,!0)},getLocalVolume:function(){return U(n,!1)},isAudioMuted:function(){return J(n,!1)},muteAudio:function(){return W(n,!1,!0)},unmuteAudio:function(){return W(n,!1,!1)},isVideoMuted:function(){return J(n,!0)},muteVideo:function(){return W(n,!0,!0)},unmuteVideo:function(){return W(n,!0,!1)},getBitrate:function(){return B(n)},getNetworkQuality:function(e){q(n,e)},messageListen:function(e,r){G(n,e,r)},messageTrigger:function(e,r){z(n,e,r)},send:function(e){O(n,e)},data:function(e){N(n,e)},dtmf:function(e){M(n,e)},consentDialog:e.consentDialog,iceState:e.iceState,mediaState:e.mediaState,webrtcState:e.webrtcState,slowLink:e.slowLink,onmessage:e.onmessage,createOffer:function(e){F(n,!0,e)},createAnswer:function(e){F(n,!1,e)},handleRemoteJsep:function(e){j(n,e)},onlocalstream:e.onlocalstream,onremotestream:e.onremotestream,ondata:e.ondata,ondataopen:e.ondataopen,oncleanup:e.oncleanup,ondetached:e.ondetached,hangup:function(e){H(n,!0===e)},detach:function(e){L(n,e)}};T[n]=o,e.success(o)},error:function(e,r){f.error(e+":",r)}})}(e)}}f.init=function(e){if((e=e||{}).callback="function"==typeof e.callback?e.callback:f.noop,!0===f.initDone)e.callback();else{"undefined"!=typeof console&&void 0!==console.log||(console={log:function(){}}),f.trace=f.noop,f.debug=f.noop,f.vdebug=f.noop,f.log=f.noop,f.warn=f.noop,f.error=f.noop,["log","debug","vdebug","info","warn","error","trace"].forEach(r=>{(Array.isArray(e.debug)&&e.debug.includes(r)||!0===e.debug||"all"===e.debug)&&Object.defineProperty(f,r,{get:function(){return u[r]},set:function(e){u[r]=e}})}),f.log("Initializing library");var r=e.dependencies||f.useDefaultDependencies();f.isArray=r.isArray,f.webRTCAdapter=r.webRTCAdapter,f.httpAPICall=r.httpAPICall,f.newWebSocket=r.newWebSocket,f.extension=r.extension,f.extension.init(),f.listDevices=function(e,r){e="function"==typeof e?e:f.noop,null==r&&(r={audio:!0,video:!0}),f.isGetUserMediaAvailable()?navigator.mediaDevices.getUserMedia(r).then(function(r){navigator.mediaDevices.enumerateDevices().then(function(t){f.debug(t),e(t);try{var n=r.getTracks();for(var o in n){var i=n[o];null!=i&&i.stop()}}catch(e){}})}).catch(function(r){f.error(r),e([])}):(f.warn("navigator.mediaDevices unavailable"),e([]))},f.attachMediaStream=function(e,r){try{"srcObject"in e?e.srcObject=r:e.src=URL.createObjectURL(r)}catch(e){f.error("Error attaching stream to element")}},f.reattachMediaStream=function(e,r){"chrome"===f.webRTCAdapter.browserDetails.browser?f.webRTCAdapter.browserDetails.version>=52?e.srcObject=r.srcObject:void 0!==e.src?e.src=r.src:f.error("Error reattaching stream to element"):e.srcObject=r.srcObject};var t=["iPad","iPhone","iPod"].indexOf(navigator.platform)>=0?"pagehide":"beforeunload",n=window["on"+t];if(window.addEventListener(t,function(e){for(var r in f.log("Closing window"),f.sessions)null!==f.sessions[r]&&void 0!==f.sessions[r]&&f.sessions[r].destroyOnUnload&&(f.log("Destroying session "+r),f.sessions[r].destroy({asyncRequest:!1,notifyDestroyed:!1}));n&&"function"==typeof n&&n()}),f.safariVp8=!1,"safari"===f.webRTCAdapter.browserDetails.browser&&f.webRTCAdapter.browserDetails.version>=605)if(RTCRtpSender&&RTCRtpSender.getCapabilities&&RTCRtpSender.getCapabilities("video")&&RTCRtpSender.getCapabilities("video").codecs&&RTCRtpSender.getCapabilities("video").codecs.length){for(var o in RTCRtpSender.getCapabilities("video").codecs){var i=RTCRtpSender.getCapabilities("video").codecs[o];if(i&&i.mimeType&&"video/vp8"===i.mimeType.toLowerCase()){f.safariVp8=!0;break}}f.safariVp8?f.log("This version of Safari supports VP8"):f.warn("This version of Safari does NOT support VP8: if you're using a Technology Preview, try enabling the 'WebRTC VP8 codec' setting in the 'Experimental Features' Develop menu")}else{var a=new RTCPeerConnection({},{});a.createOffer({offerToReceiveVideo:!0}).then(function(e){f.safariVp8=-1!==e.sdp.indexOf("VP8"),f.safariVp8?f.log("This version of Safari supports VP8"):f.warn("This version of Safari does NOT support VP8: if you're using a Technology Preview, try enabling the 'WebRTC VP8 codec' setting in the 'Experimental Features' Develop menu"),a.close(),a=null})}if(f.unifiedPlan=!1,"firefox"===f.webRTCAdapter.browserDetails.browser&&f.webRTCAdapter.browserDetails.version>=59)f.unifiedPlan=!0;else if("chrome"===f.webRTCAdapter.browserDetails.browser&&f.webRTCAdapter.browserDetails.version<72)f.unifiedPlan=!1;else if("currentDirection"in RTCRtpTransceiver.prototype){const e=new RTCPeerConnection;try{e.addTransceiver("audio"),f.unifiedPlan=!0}catch(e){}e.close()}else f.unifiedPlan=!1;f.initDone=!0,e.callback()}},f.isWebrtcSupported=function(){return void 0!==window.RTCPeerConnection&&null!==window.RTCPeerConnection},f.isGetUserMediaAvailable=function(){return void 0!==navigator.mediaDevices&&null!==navigator.mediaDevices&&void 0!==navigator.mediaDevices.getUserMedia&&null!==navigator.mediaDevices.getUserMedia},f.randomString=function(e){for(var r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",t="",n=0;n<e;n++){var o=Math.floor(62*Math.random());t+=r.substring(o,o+1)}return t};class v{constructor(){this.pluginName="ScreenRecorder",this.instance=null,this.classNative=null,this.ertc=null}exec(e){let{instance:r,classNative:t}=e;console.log("screenRecorder plugin exec"),this.instance=r,this.classNative=t,r.screenRecorderStart=this.screenRecorderStart.bind(this),r.screenRecorderStop=this.screenRecorderStop.bind(this)}destroy(){}async screenRecorderStart(e){return new Promise(async(r,t)=>{var n;const o=this.classNative,i=new o(this.instance.params||{});this.ertc=i,i.on(o.EVENT.ERROR,e=>{this.instance.trigger(o.EVENT.ERROR,e)}),i.on(o.EVENT.UNPUBLISHLOCALSTREAMACK,e=>{i.leaveRoom(),this.instance.trigger(o.EVENT.UNPUBLISHLOCALSTREAMACK,e)});const a=await i.enterRoom(e);function s(){setTimeout(async()=>{try{const e=await i.publishStream({type:o.STREAM_TYPE.SCREEN,displaySurface:"monitor"});r(e)}catch(e){t(e)}},500)}0===a.code?"safari"===(null===(n=f.webRTCAdapter)||void 0===n||null===(n=n.browserDetails)||void 0===n?void 0:n.browser)?e.onSafari(s):s():r(a)}).catch(e=>reject(e))}async screenRecorderStop(){this.ertc.unpublishStream({type:this.classNative.STREAM_TYPE.SCREEN})}}return r(v,"EVENT",{}),v});
