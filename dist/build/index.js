/*!
* ertc-web v2.1.3-alpha.15
* (c) Mon Jan 05 2026 16:12:27 GMT+0800 (中国标准时间)
*/
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("webrtc-adapter"),require("lodash-es"),require("dingrtc"),require("uuid")):"function"==typeof define&&define.amd?define(["exports","webrtc-adapter","lodash-es","dingrtc","uuid"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).EzRTCWeb={},e.adapter,e.lodashEs,e.DingRTC,e.uuid)}(this,function(e,t,n,r,s){"use strict";function o(e,t,n){if("function"==typeof e?e===t:e.has(t))return arguments.length<3?t:n;throw new TypeError("Private element is not present on this object")}function i(e,t){return e.get(o(e,t))}function a(e,t,n){(function(e,t){if(t.has(e))throw new TypeError("Cannot initialize the same private elements twice on an object")})(e,t),t.set(e,n)}function c(e,t,n){return e.set(o(e,t),n),n}function d(e,t,n){return(t=h(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function l(e){return e}function u(e,t,n){"symbol"==typeof t&&(t=(t=t.description)?"["+t+"]":"");try{Object.defineProperty(e,"name",{configurable:!0,value:n?n+" "+t:t})}catch(e){}return e}function h(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var r=n.call(e,t);if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:t+""}const m=[],g={supportExport:!0};let v=0;const p={info:"",log:"background: #4096ff; color: #FFF;",warn:"background: yellow; color: #FFF;",error:"background: red; color: #FFF;"};class f{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};d(this,"_options",{level:"INFO",showTime:!1}),d(this,"_levelNum",3),d(this,"info",this._loggerFactory("info",this._levelNum>=3)),d(this,"log",this._loggerFactory("log",this._levelNum>=2)),d(this,"warn",this._loggerFactory("warn",this._levelNum>=1)),d(this,"error",this._loggerFactory("error",this._levelNum>=0)),d(this,"debug",this._loggerFactory("debug",this._levelNum>=0)),d(this,"trace",this._loggerFactory("trace",this._levelNum>=0)),this.setOptions(e)}setOptions(e){var t,n;this._options=Object.assign({},this._options,e),this._levelNum=this._matchLevel(null!==(t=this._options.level)&&void 0!==t?t:"INFO"),this._nameColor=null!==(n=e.nameColor)&&void 0!==n?n:"background: green;color: #fff",this.info=this._loggerFactory("info",this._levelNum>=3),this.log=this._loggerFactory("log",this._levelNum>=2),this.warn=this._loggerFactory("warn",this._levelNum>=1),this.error=this._loggerFactory("error",this._levelNum>=0)}_matchLevel(e){let t=3;switch(e){case"INFO":t=3;break;case"LOG":t=2;break;case"WARN":t=1;break;case"ERROR":t=0}return t}_loggerFactory(e,t){const n=console[e];if(t&&n){const t=this._options.name?`%c[${this._options.name}]%c %c[${e.toUpperCase()}]`:`%c[${e.toUpperCase()}]`,r=[this._options.name?this._nameColor:null,this._options.name?"":null,p[e]].filter(e=>null!=e);return n.bind(console,t,...r)}return f.noop}getOptions(){return this._options}}function _(e){return(e=+e)<10&&(e=`0${e}`),e+""}d(f,"noop",()=>{});const S=["log","debug","info","warn","error","trace"];var T={proxy:e=>{const t=new f(e);return new Proxy(t,{get(t,n){if(S.includes(n)){const r=function(){const e=new Date(Date.now()),t=e.getFullYear(),n=e.getMonth()+1,r=e.getDate(),s=e.getHours(),o=e.getMinutes(),i=e.getSeconds();return`${t}/${_(n)}/${_(r)} ${_(s)}:${_(o)}:${_(i)}`}();return g.supportExport?function(){t[n].apply(console,arguments);const s=[`[${r}][${e.name} ${n}]：`,...arguments];["log","info","warn","error"].includes(n)&&m.push(s),v+=JSON.stringify(s).length,async function(){const e=524288;if(v>e){let t=0,n=0;for(;n<m.length&&v-t>e;)t+=JSON.stringify(m[n]).length,n++,await new Promise(e=>setTimeout(e,0));m.splice(0,n),v-=t}}()}:t[n].bind(console)}return Reflect.get(t,n)}})},setGlobalConfig(e){Object.assign(g,e)},exportLogs(){function e(t){return t.map(t=>{if(t instanceof Array)return JSON.stringify(e(t));if(t instanceof Error)return t.message;if(t instanceof MediaStreamTrack){const e={id:t.id,enabled:t.enabled,kind:t.kind,label:t.label,muted:t.muted,readyState:t.readyState,remote:t.remote};return JSON.stringify(e)}return JSON.stringify(t)})}const t=m.map(function(t){return e(t).join("")}).join("\r\n\r\n"),n=new Blob([t],{type:"text/plain;charset=utf-8"}),r=URL.createObjectURL(n),s=document.createElement("a");s.href=r,s.download="logs.txt",s.click(),window.URL.revokeObjectURL(r)}};b.sessions={},b.isExtensionEnabled=function(){if(navigator.mediaDevices&&navigator.mediaDevices.getDisplayMedia)return!0;if(window.navigator.userAgent.match("Chrome")){var e=parseInt(window.navigator.userAgent.match(/Chrome\/(.*) /)[1],10),t=33;return window.navigator.userAgent.match("Linux")&&(t=35),e>=26&&e<=t||b.extension.isInstalled()}return!0};var I={extensionId:"hapfgfdkleiggjjpfpenajgdnfckjpaj",isInstalled:function(){return null!==document.querySelector("#janus-extension-installed")},getScreen:function(e){var t=window.setTimeout(function(){var t=new Error("NavigatorUserMediaError");return t.name='The required Chrome extension is not installed: click <a href="#">here</a> to install it. (NOTE: this will need you to refresh the page)',e(t)},1e3);this.cache[t]=e,window.postMessage({type:"janusGetScreen",id:t},"*")},init:function(){var e={};this.cache=e,window.addEventListener("message",function(t){if(t.origin==window.location.origin)if("janusGotScreen"==t.data.type&&e[t.data.id]){var n=e[t.data.id];if(delete e[t.data.id],""===t.data.sourceId){var r=new Error("NavigatorUserMediaError");r.name="You cancelled the request for permission, giving up...",n(r)}else n(null,t.data.sourceId)}else"janusGetScreenPending"==t.data.type&&(b.log("clearing ",t.data.id),window.clearTimeout(t.data.id))})}};b.useDefaultDependencies=function(e){var n=e&&e.fetch||fetch,r=e&&e.Promise||Promise,s=e&&e.WebSocket||WebSocket;return{newWebSocket:function(e,t){return new s(e,t)},extension:e&&e.extension||I,isArray:function(e){return Array.isArray(e)},webRTCAdapter:e&&e.adapter||t,httpAPICall:function(e,t){var s={method:t.verb,headers:{Accept:"application/json, text/plain, */*"},cache:"no-cache"};"POST"===t.verb&&(s.headers["Content-Type"]="application/json"),void 0!==t.withCredentials&&(s.credentials=!0===t.withCredentials?"include":t.withCredentials?t.withCredentials:"omit"),void 0!==t.body&&(s.body=JSON.stringify(t.body));var o=n(e,s).catch(function(e){return r.reject({message:"Probably a network error, is the server down?",error:e})});if(void 0!==t.timeout){var i=new r(function(e,n){var r=setTimeout(function(){return clearTimeout(r),n({message:"Request timed out",timeout:t.timeout})},t.timeout)});o=r.race([o,i])}return o.then(function(e){return e.ok?typeof t.success==typeof b.noop?e.json().then(function(e){t.success(e)}).catch(function(t){return r.reject({message:"Failed to parse response body",error:t,response:e})}):void 0:r.reject({message:"API call failed",response:e})}).catch(function(e){typeof t.error==typeof b.noop&&t.error(e.message||"<< internal error >>",e)}),o}}},b.useOldDependencies=function(e){var n=e&&e.jQuery||jQuery,r=e&&e.WebSocket||WebSocket;return{newWebSocket:function(e,t){return new r(e,t)},isArray:function(e){return n.isArray(e)},extension:e&&e.extension||I,webRTCAdapter:e&&e.adapter||t,httpAPICall:function(e,t){var r=void 0!==t.body?{contentType:"application/json",data:JSON.stringify(t.body)}:{},s=void 0!==t.withCredentials?{xhrFields:{withCredentials:t.withCredentials}}:{};return n.ajax(n.extend(r,s,{url:e,type:t.verb,cache:!1,dataType:"json",async:t.async,timeout:t.timeout,success:function(e){typeof t.success==typeof b.noop&&t.success(e)},error:function(e,n,r){typeof t.error==typeof b.noop&&t.error(n,r)}}))}}},b.noop=function(){},b.dataChanDefaultLabel="JanusDataChannel",b.endOfCandidates=null;const E=T.proxy({name:"Janus",nameColor:"color: #fff;background-color:#c7254e;"});function b(e,t){if(void 0===b.initDone)return e.error("Library not initialized"),{};if(!b.isWebrtcSupported())return e.error("WebRTC not supported by this browser"),{};if(b.log("Library initialized: "+b.initDone),(e=e||{}).success="function"==typeof e.success?e.success:b.noop,e.error="function"==typeof e.error?e.error:b.noop,e.destroyed="function"==typeof e.destroyed?e.destroyed:b.noop,null===e.server||void 0===e.server)return e.error("Invalid server url"),{};var n=!1,r=null,s={},o=null,i=null,a=0,c=e.server;b.isArray(c)?(b.log("Multiple servers provided ("+c.length+"), will use the first that works"),c=null,i=e.server,b.debug(i)):0===c.indexOf("ws")?(n=!0,b.log("Using WebSockets to contact Janus: "+c)):(n=!1,b.log("Using REST API to contact Janus: "+c));var d=e.iceServers;null==d&&(d=[{urls:"stun:stun.l.google.com:19302"}]);var l=e.iceTransportPolicy,u=e.bundlePolicy,h=e.ipv6;null==h&&(h=!1);var m=!1;void 0!==e.withCredentials&&null!==e.withCredentials&&(m=!0===e.withCredentials);var g=10;void 0!==e.max_poll_events&&null!==e.max_poll_events&&(g=e.max_poll_events),g<1&&(g=1);var v=null;void 0!==e.token&&null!==e.token&&(v=e.token);var p=null;void 0!==e.apisecret&&null!==e.apisecret&&(p=e.apisecret),this.destroyOnUnload=!0,void 0!==e.destroyOnUnload&&null!==e.destroyOnUnload&&(this.destroyOnUnload=!0===e.destroyOnUnload);var f=25e3;void 0!==e.keepAlivePeriod&&null!==e.keepAlivePeriod&&(f=e.keepAlivePeriod),isNaN(f)&&(f=25e3);var _=6e4;function S(e){var t={high:9e5,medium:3e5,low:1e5};return null!=e&&(e.high&&(t.high=e.high),e.medium&&(t.medium=e.medium),e.high&&e.high<e.medium&&(t.medium=e.high),e.low&&(t.low=e.low)),t}void 0!==e.longPollTimeout&&null!==e.longPollTimeout&&(_=e.longPollTimeout),isNaN(_)&&(_=6e4);var T=!1,I=null,E={},y=this,R=0,A={};function k(){if(null!=I)if(b.debug("Long poll..."),T){var t=c+"/"+I+"?rid="+(new Date).getTime();null!=g&&(t=t+"&maxev="+g),null!=v&&(t=t+"&token="+encodeURIComponent(v)),null!=p&&(t=t+"&apisecret="+encodeURIComponent(p)),b.httpAPICall(t,{verb:"GET",withCredentials:m,success:w,timeout:_,error:function(t,n){if(b.error(t+":",n),++R>3)return T=!1,void e.error("Lost connection to the server (is it down?)");k()}})}else b.warn("Is the server down? (connected=false)")}function w(e,t){if(R=0,n||null==I||!0===t||k(),n||!b.isArray(e))if("keepalive"!==e.rtcgw)if("ack"!==e.rtcgw)if("success"!==e.rtcgw)if("trickle"===e.rtcgw){if(null==(c=e.sender))return void b.warn("Missing sender...");if(null==(l=E[c]))return void b.debug("This handle is not attached to this session");var s=e.candidate;b.debug("Got a trickled candidate on session "+I),b.debug(s);var o=l.webrtcStuff;o.pc&&o.remoteSdp?(b.log("Adding remote candidate:",s),s&&!0!==s.completed?o.pc.addIceCandidate(s):o.pc.addIceCandidate(b.endOfCandidates)):(b.debug("We didn't do setRemoteDescription (trickle got here before the offer?), caching candidate"),o.candidates||(o.candidates=[]),o.candidates.push(s),b.debug(o.candidates))}else{if("webrtcup"===e.rtcgw)return b.debug("Got a webrtcup event on session "+I),b.debug(e),null==(c=e.sender)?void b.warn("Missing sender..."):null==(l=E[c])?void b.debug("This handle is not attached to this session"):void l.webrtcState(!0);if("hangup"===e.rtcgw){if(b.debug("Got a hangup event on session "+I),b.debug(e),null==(c=e.sender))return void b.warn("Missing sender...");if(null==(l=E[c]))return void b.debug("This handle is not attached to this session");l.webrtcState(!1,e.reason),l.hangup()}else if("detached"===e.rtcgw){if(b.debug("Got a detached event on session "+I),b.debug(e),null==(c=e.sender))return void b.warn("Missing sender...");if(null==(l=E[c]))return;l.detached=!0,l.ondetached(),l.detach()}else if("media"===e.rtcgw){if(b.debug("Got a media event on session "+I),b.debug(e),null==(c=e.sender))return void b.warn("Missing sender...");if(null==(l=E[c]))return void b.debug("This handle is not attached to this session");l.mediaState(e.type,e.receiving)}else if("slowlink"===e.rtcgw){if(b.debug("Got a slowlink event on session "+I),null==(c=e.sender))return void b.warn("Missing sender...");if(null==(l=E[c]))return void b.debug("This handle is not attached to this session");l.slowLink(e.uplink,e.lost)}else{if("error"===e.rtcgw){var i,a;if(b.error("Ooops: "+e.error.code+" "+e.error.reason),b.debug(e),null!=(i=e.transaction))null!=(a=A[i])&&a(e),delete A[i];return}if("event"===e.rtcgw){var c;if(b.debug("Got a plugin event on session "+I),b.debug(e),null==(c=e.sender))return void b.warn("Missing sender...");var d=e.plugindata;if(null==d)return void b.warn("Missing plugindata...");b.debug("  -- Event is coming from "+c+" ("+d.plugin+")");var l,u=d.data;if(b.debug(u),null==(l=E[c]))return void b.warn("This handle is not attached to this session");var h=e.jsep;null!=h&&(b.debug("Handling SDP as well..."),b.debug(h));var m=l.onmessage;null!=m?(b.debug("Notifying application..."),m(u,h)):b.debug("No provided notification callback")}else{if("timeout"===e.rtcgw)return b.error("Timeout on session "+I),b.debug(e),void(n&&r.close(3504,"Gateway timeout"));b.warn("Unknown message/event  '"+e.rtcgw+"' on session "+I),b.debug(e)}}}else b.debug("Got a success on session "+I),b.debug(e),null!=(i=e.transaction)&&(null!=(a=A[i])&&a(e),delete A[i]);else b.debug("Got an ack on session "+I),b.debug(e),null!=(i=e.transaction)&&(null!=(a=A[i])&&a(e),delete A[i]);else b.vdebug("Got a keepalive on session "+I);else for(var g=0;g<e.length;g++)w(e[g],!0)}function P(){if(null!==c&&n&&T){o=setTimeout(P,f);var e={rtcgw:"keepalive",session_id:I,transaction:b.randomString(12)};null!=v&&(e.token=v),null!=p&&(e.apisecret=p),r.send(JSON.stringify(e))}}function C(d){var l=b.randomString(12),u={rtcgw:"create",transaction:l,token:"testtoken"};if(u=Object.assign({},u,t),d.reconnect&&(T=!1,u.rtcgw="claim",u.session_id=I,r&&(r.onopen=null,r.onerror=null,r.onclose=null,o&&(clearTimeout(o),o=null))),null!=v&&(u.token=v),null!=p&&(u.apisecret=p),null===c&&b.isArray(i)&&(0===(c=i[a]).indexOf("ws")?(n=!0,b.log("Server #"+(a+1)+": trying WebSockets to contact Janus ("+c+")")):(n=!1,b.log("Server #"+(a+1)+": trying REST API to contact Janus ("+c+")"))),n)for(var h in r=b.newWebSocket(c,"rtcgw-protocol"),s={error:function(){if(b.error("Error connecting to the Janus WebSockets server... "+c),b.isArray(i)&&!d.reconnect)return++a==i.length?void d.error("Error connecting to any of the provided Janus servers: Is the server down?"):(c=null,void setTimeout(function(){C(d)},200));d.error("Error connecting to the Janus WebSockets server: Is the server down?")},open:function(){A[l]=function(e){if(b.debug(e),"success"!==e.rtcgw)return b.error("Ooops: "+e.error.code+" "+e.error.reason),void d.error(e.error.reason);o=setTimeout(P,f),T=!0,I=e.session_id?e.session_id:e.data.id,d.reconnect?b.log("Claimed session: "+I):b.log("Created session: "+I),b.sessions[I]=y,d.success(I)},r.send(JSON.stringify(u))},message:function(e){w(JSON.parse(e.data))},close:function(){null!==c&&T&&(T=!1,e.error("Lost connection to the server"))}})r.addEventListener(h,s[h]);else b.httpAPICall(c,{verb:"POST",withCredentials:m,body:u,success:function(e){if(b.debug(e),"success"!==e.rtcgw)return b.error("Ooops: "+e.error.code+" "+e.error.reason),void d.error(e.error.reason);T=!0,I=e.session_id?e.session_id:e.data.id,d.reconnect?b.log("Claimed session: "+I):b.log("Created session: "+I),b.sessions[I]=y,k(),d.success()},error:function(e,t){if(b.error(e+":",t),b.isArray(i)&&!d.reconnect)return++a==i.length?void d.error("Error connecting to any of the provided Janus servers: Is the server down?"):(c=null,void setTimeout(function(){C(d)},200));""===t?d.error(e+": Is the server down?"):d.error(e+": "+t)}})}function O(e,t){if((t=t||{}).success="function"==typeof t.success?t.success:b.noop,t.error="function"==typeof t.error?t.error:b.noop,!T)return b.warn("Is the server down? (connected=false)"),void t.error("Is the server down? (connected=false)");var s=E[e];if(null==s||null===s.webrtcStuff||void 0===s.webrtcStuff)return b.warn("Invalid handle"),void t.error("Invalid handle");var o=t.message,i=t.jsep,a=b.randomString(12),d={rtcgw:"message",body:o,transaction:a};if(null!==s.token&&void 0!==s.token&&(d.token=s.token),null!=p&&(d.apisecret=p),null!=i&&(d.jsep=i),b.debug("Sending message to plugin (handle="+e+"):"),b.debug(d),n)return d.session_id=I,d.handle_id=e,A[a]=function(e){if(b.debug("Message sent!"),b.debug(e),"success"===e.rtcgw){var n=e.plugindata;if(null==n)return b.warn("Request succeeded, but missing plugindata..."),void t.success();b.log("Synchronous transaction successful ("+n.plugin+")");var r=n.data;return b.debug(r),void t.success(r)}"ack"===e.rtcgw?t.success():void 0!==e.error&&null!==e.error?(b.error("Ooops: "+e.error.code+" "+e.error.reason),t.error(e.error.code+" "+e.error.reason)):(b.error("Unknown error"),t.error("Unknown error"))},void r.send(JSON.stringify(d));b.httpAPICall(c+"/"+I+"/"+e,{verb:"POST",withCredentials:m,body:d,success:function(e){if(b.debug("Message sent!"),b.debug(e),"success"===e.rtcgw){var n=e.plugindata;if(null==n)return b.warn("Request succeeded, but missing plugindata..."),void t.success();b.log("Synchronous transaction successful ("+n.plugin+")");var r=n.data;return b.debug(r),void t.success(r)}"ack"===e.rtcgw?t.success():void 0!==e.error&&null!==e.error?(b.error("Ooops: "+e.error.code+" "+e.error.reason),t.error(e.error.code+" "+e.error.reason)):(b.error("Unknown error"),t.error("Unknown error"))},error:function(e,n){b.error(e+":",n),t.error(e+": "+n)}})}function D(e,t){if(T){var s=E[e];if(null!=s&&null!==s.webrtcStuff&&void 0!==s.webrtcStuff){var o={rtcgw:"trickle",candidate:t,transaction:b.randomString(12)};if(null!==s.token&&void 0!==s.token&&(o.token=s.token),null!=p&&(o.apisecret=p),b.vdebug("Sending trickle candidate (handle="+e+"):"),b.vdebug(o),n)return o.session_id=I,o.handle_id=e,void r.send(JSON.stringify(o));b.httpAPICall(c+"/"+I+"/"+e,{verb:"POST",withCredentials:m,body:o,success:function(e){b.vdebug("Candidate sent!"),b.vdebug(e),"ack"===e.rtcgw||b.error("Ooops: "+e.error.code+" "+e.error.reason)},error:function(e,t){b.error(e+":",t)}})}else b.warn("Invalid handle")}else b.warn("Is the server down? (connected=false)")}function N(e,t,n,r){var s=E[e];if(null!=s&&null!==s.webrtcStuff&&void 0!==s.webrtcStuff){var o=s.webrtcStuff,i=function(e){b.log("Received state change on data channel:",e);var t=e.target.label,n=o.dataChannel[t]?o.dataChannel[t].readyState:"null";if(b.log("State change on <"+t+"> data channel: "+n),"open"===n){if(o.dataChannel[t].pending&&o.dataChannel[t].pending.length>0){for(var r in b.log("Sending pending messages on <"+t+">:",o.dataChannel[t].pending.length),o.dataChannel[t].pending){var i=o.dataChannel[t].pending[r];b.log("Sending string on data channel <"+t+">: "+i),o.dataChannel[t].send(i)}o.dataChannel[t].pending=[]}s.ondataopen(t)}};o.dataChannel[t]=n||o.pc.createDataChannel(t,{ordered:!1}),o.dataChannel[t].onmessage=function(e){b.log("Received message on data channel:",e);var t=e.target.label;s.ondata(e.data,t)},o.dataChannel[t].onopen=i,o.dataChannel[t].onclose=i,o.dataChannel[t].onerror=function(e){b.error("Got error on data channel:",e)},o.dataChannel[t].pending=[],r&&o.dataChannel[t].pending.push(r)}else b.warn("Invalid handle")}function M(e,t){(t=t||{}).success="function"==typeof t.success?t.success:b.noop,t.error="function"==typeof t.error?t.error:b.noop;var n=E[e];if(null==n||null===n.webrtcStuff||void 0===n.webrtcStuff)return b.warn("Invalid handle"),void t.error("Invalid handle");var r=n.webrtcStuff,s=t.text;if(null==s)return b.warn("Invalid text"),void t.error("Invalid text");var o=t.label?t.label:b.dataChanDefaultLabel;return r.dataChannel[o]?"open"!==r.dataChannel[o].readyState?(r.dataChannel[o].pending.push(s),void t.success()):(b.log("Sending string on data channel <"+o+">: "+s),r.dataChannel[o].send(s),void t.success()):(N(e,o,!1,s),void t.success())}function V(e,t){(t=t||{}).success="function"==typeof t.success?t.success:b.noop,t.error="function"==typeof t.error?t.error:b.noop;var n=E[e];if(null==n||null===n.webrtcStuff||void 0===n.webrtcStuff)return b.warn("Invalid handle"),void t.error("Invalid handle");var r=n.webrtcStuff;if(null===r.dtmfSender||void 0===r.dtmfSender){if(void 0!==r.pc&&null!==r.pc){var s=r.pc.getSenders().find(function(e){return e.track&&"audio"===e.track.kind});if(!s)return b.warn("Invalid DTMF configuration (no audio track)"),void t.error("Invalid DTMF configuration (no audio track)");r.dtmfSender=s.dtmf,r.dtmfSender&&(b.log("Created DTMF Sender"),r.dtmfSender.ontonechange=function(e){b.debug("Sent DTMF tone: "+e.tone)})}if(null===r.dtmfSender||void 0===r.dtmfSender)return b.warn("Invalid DTMF configuration"),void t.error("Invalid DTMF configuration")}var o=t.dtmf;if(null==o)return b.warn("Invalid DTMF parameters"),void t.error("Invalid DTMF parameters");var i=o.tones;if(null==i)return b.warn("Invalid DTMF string"),void t.error("Invalid DTMF string");var a=o.duration;null==a&&(a=500);var c=o.gap;null==c&&(c=50),b.debug("Sending DTMF string "+i+" (duration "+a+"ms, gap "+c+"ms)"),r.dtmfSender.insertDTMF(i,a,c),t.success()}function L(e,t){(t=t||{}).success="function"==typeof t.success?t.success:b.noop,t.error="function"==typeof t.error?t.error:b.noop;var s=!0;void 0!==t.asyncRequest&&null!==t.asyncRequest&&(s=!0===t.asyncRequest);let o=!0===t.noRequest;void 0!==t.noRequest&&null!==t.noRequest&&(o=!0===t.noRequest),b.log("Destroying handle "+e+" (async="+s+")"),W(e);var i=E[e];if(null==i||i.detached)return delete E[e],void t.success();if(o)return delete E[e],void t.success();if(!T)return b.warn("Is the server down? (connected=false)"),void t.error("Is the server down? (connected=false)");var a={rtcgw:"detach",transaction:b.randomString(12)};if(null!==i.token&&void 0!==i.token&&(a.token=i.token),null!=p&&(a.apisecret=p),n)return a.session_id=I,a.handle_id=e,r.send(JSON.stringify(a)),delete E[e],void t.success();b.httpAPICall(c+"/"+I+"/"+e,{verb:"POST",async:s,withCredentials:m,body:a,success:function(n){b.log("Destroyed handle:"),b.debug(n),"success"!==n.rtcgw&&b.error("Ooops: "+n.error.code+" "+n.error.reason),delete E[e],t.success()},error:function(n,r){b.error(n+":",r),delete E[e],t.success()}})}async function x(e,t,n,s,o){b.debug("进入streamsDone函数");var i=E[e];if(null==i||null===i.webrtcStuff||void 0===i.webrtcStuff)return b.warn("Invalid handle"),void s.error("Invalid handle");var a=i.webrtcStuff;o&&(b.log("  -- Audio tracks:",o.getAudioTracks()),b.log("  -- Video tracks:",o.getVideoTracks()));var c=!1,m=!0===s.simulcast;const g=S(s.simulcastMaxBitrates),v={active:!0,scaleResolutionDownBy:1};s.bitrate&&(v.maxBitrate=s.bitrate),s.frameRate&&(v.maxFramerate=s.frameRate);const p=m?[{...v,rid:"h",priority:"high",maxBitrate:g.high},{...v,rid:"l",priority:"low",maxBitrate:g.low,scaleResolutionDownBy:4}]:[v];if(a.myStream&&n.update&&!a.streamExternal){if((!n.update&&J(n)||n.update&&(n.addAudio||n.replaceAudio))&&o.getAudioTracks()&&o.getAudioTracks().length)if(a.myStream.addTrack(o.getAudioTracks()[0]),b.unifiedPlan){b.log((n.replaceAudio?"Replacing":"Adding")+" audio track:",o.getAudioTracks()[0]);var f=null;if((A=a.pc.getTransceivers())&&A.length>0)for(var _ in A){if((w=A[_]).sender&&w.sender.track&&"audio"===w.sender.track.kind||w.receiver&&w.receiver.track&&"audio"===w.receiver.track.kind){f=w;break}}let e=null;try{e=await s.customizeAudioTrack(o)}catch(e){s.error(e)}var T,I,y,R;if(f&&f.sender)f.sender.replaceTrack((null===(T=e)||void 0===T||null===(I=T.getAudioTracks)||void 0===I||null===(I=I.call(T))||void 0===I?void 0:I[0])||o.getAudioTracks()[0]);else a.pc.addTrack((null===(y=e)||void 0===y||null===(R=y.getAudioTracks)||void 0===R||null===(R=R.call(y))||void 0===R?void 0:R[0])||o.getAudioTracks()[0],e||o)}else b.log((n.replaceAudio?"Replacing":"Adding")+" audio track:",o.getAudioTracks()[0]),a.pc.addTrack(o.getAudioTracks()[0],o);if((!n.update&&z(n)||n.update&&(n.addVideo||n.replaceVideo))&&o.getVideoTracks()&&o.getVideoTracks().length)if(a.myStream.addTrack(o.getVideoTracks()[0]),b.unifiedPlan){b.log((n.replaceVideo?"Replacing":"Adding")+" video track:",o.getVideoTracks()[0]);var A,k=null;if((A=a.pc.getTransceivers())&&A.length>0)for(var _ in A){var w;if((w=A[_]).sender&&w.sender.track&&"video"===w.sender.track.kind||w.receiver&&w.receiver.track&&"video"===w.receiver.track.kind){k=w;break}}k&&k.sender?k.sender.replaceTrack(o.getVideoTracks()[0]):a.pc.addTransceiver(o.getVideoTracks()[0],{direction:"sendrecv",streams:[o],sendEncodings:p})}else b.log((n.replaceVideo?"Replacing":"Adding")+" video track:",o.getVideoTracks()[0]),a.pc.addTrack(o.getVideoTracks()[0],o)}else a.myStream=o,c=!0;if(!a.pc){var P={iceServers:d,iceTransportPolicy:l,bundlePolicy:u};"chrome"===b.webRTCAdapter.browserDetails.browser&&(P.sdpSemantics=b.webRTCAdapter.browserDetails.version<72?"plan-b":"unified-plan");var C={optional:[{DtlsSrtpKeyAgreement:!0}]};if(!0===h&&C.optional.push({googIPv6:!0}),s.rtcConstraints&&"object"==typeof s.rtcConstraints)for(var _ in b.debug("Adding custom PeerConnection constraints:",s.rtcConstraints),s.rtcConstraints)C.optional.push(s.rtcConstraints[_]);"edge"===b.webRTCAdapter.browserDetails.browser&&(P.bundlePolicy="max-bundle"),b.log("创建PeerConnection实例"),a.pc=new RTCPeerConnection(P,C),b.debug(a.pc),a.pc.getStats&&(a.volume={},a.bitrate.value="0 kbits/sec"),b.log("Preparing local SDP and gathering candidates (trickle="+a.trickle+")"),a.pc.oniceconnectionstatechange=function(e){a.pc&&i.iceState(a.pc.iceConnectionState,r)},a.pc.onicecandidate=function(t){if(null==t.candidate||"edge"===b.webRTCAdapter.browserDetails.browser&&t.candidate.candidate.indexOf("endOfCandidates")>0)b.log("End of candidates."),a.iceDone=!0,!0===a.trickle?D(e,{completed:!0}):function(e,t){t=t||{},t.success="function"==typeof t.success?t.success:b.noop,t.error="function"==typeof t.error?t.error:b.noop;var n=E[e];if(null==n||null===n.webrtcStuff||void 0===n.webrtcStuff)return void b.warn("Invalid handle, not sending anything");var r=n.webrtcStuff;if(b.log("Sending offer/answer SDP..."),null===r.mySdp||void 0===r.mySdp)return void b.warn("Local SDP instance is invalid, not sending anything...");r.mySdp={type:r.pc.localDescription.type,sdp:r.pc.localDescription.sdp},!1===r.trickle&&(r.mySdp.trickle=!1);b.debug(t),r.sdpSent=!0,t.success(r.mySdp)}(e,s);else{var n={candidate:t.candidate.candidate,sdpMid:t.candidate.sdpMid,sdpMLineIndex:t.candidate.sdpMLineIndex};!0===a.trickle&&D(e,n)}},a.pc.ontrack=function(e){b.debug("进入peerConnection的ontrack事件"),b.log("监听到peerConnection连接，添加了新的RTCRtpReceiver:",e);let t=null;e.streams&&(a.remoteStream=e.streams[0],i.onremotestream(a.remoteStream),e.track.onended||(e.track.onended=function(e){b.log("流媒体轨道 关闭:",e),clearTimeout(t),t=null,a.remoteStream&&(a.remoteStream.removeTrack(e.target),i.onremotestream(a.remoteStream))},e.track.onmute=function(e){b.debug("Remote track muted:",e),t||(t=setTimeout(function(){try{b.log("流媒体轨道 移除：",e),a.remoteStream&&(a.remoteStream.removeTrack(e.target),i.onremotestream(a.remoteStream))}catch(e){b.error("流媒体轨道 移除失败，原因：",e)}t=null},2520))},e.track.onunmute=function(e){if(b.debug("Remote track flowing again:",e),null!=t)clearTimeout(t),t=null;else try{b.log("流媒体轨道 添加：",e),a.remoteStream.addTrack(e.target),i.onremotestream(a.remoteStream)}catch(e){b.errpr("流媒体轨道添加失败，原因：",e)}}))}}try{if(c&&null!=o)if(b.log("Adding local stream"),"screen"==s.media.video)o.getTracks().forEach(function(e){b.log("Adding local track:",e),"audio"===e.kind?a.pc.addTrack(e,o):a.pc.addTransceiver(e,{direction:"sendrecv",streams:[o],sendEncodings:[v]})});else{var O=o.getTracks();for(let e=0;e<O.length;e++){const t=O[e];if(b.log("Adding local track:",t),b.log("Adding local track settings:",t.getSettings()),"audio"===t.kind){var M,V;let e=null;try{e=await s.customizeAudioTrack(o)}catch(e){s.error(e)}a.pc.addTrack((null===(M=e)||void 0===M||null===(V=M.getAudioTracks)||void 0===V||null===(V=V.call(M))||void 0===V?void 0:V[0])||t,e||o)}else a.pc.addTransceiver(t,{direction:"sendrecv",streams:[o],sendEncodings:p})}}}catch(e){s.error(e)}(function(e){if(b.debug("isDataEnabled:",e),"edge"==b.webRTCAdapter.browserDetails.browser)return b.warn("Edge doesn't support data channels yet"),!1;return null!=e&&!0===e.data})(n)&&!a.dataChannel[b.dataChanDefaultLabel]&&(b.log("Creating data channel"),N(e,b.dataChanDefaultLabel,!1),a.pc.ondatachannel=function(t){b.log("Data channel created by Janus:",t),N(e,t.channel.label,t.channel)}),a.myStream&&i.onlocalstream(a.myStream),null==t?function(e,t,n){b.debug("进入createOffer函数"),n=n||{},n.success="function"==typeof n.success?n.success:b.noop,n.error="function"==typeof n.error?n.error:b.noop;var r=E[e];if(null==r||null===r.webrtcStuff||void 0===r.webrtcStuff)return b.warn("Invalid handle"),void n.error("Invalid handle");var s=r.webrtcStuff,o=!0===n.simulcast;o?b.log("Creating offer (iceDone="+s.iceDone+", simulcast="+o+")"):b.log("Creating offer (iceDone="+s.iceDone+")");var i={};if(b.unifiedPlan){var a=null,c=null,d=s.pc.getTransceivers();if(d&&d.length>0)for(var l in d){var u=d[l];u.sender&&u.sender.track&&"audio"===u.sender.track.kind||u.receiver&&u.receiver.track&&"audio"===u.receiver.track.kind?a||(a=u):(u.sender&&u.sender.track&&"video"===u.sender.track.kind||u.receiver&&u.receiver.track&&"video"===u.receiver.track.kind)&&(c||(c=u))}var h=J(t),m=G(t);h||m?h&&m?a&&(a.setDirection?a.setDirection("sendrecv"):a.direction="sendrecv",b.log("Setting audio transceiver to sendrecv:",a)):h&&!m?a&&(a.setDirection?a.setDirection("sendonly"):a.direction="sendonly",b.log("Setting audio transceiver to sendonly:",a)):!h&&m&&(a?(a.setDirection?a.setDirection("recvonly"):a.direction="recvonly",b.log("Setting audio transceiver to recvonly:",a)):(a=s.pc.addTransceiver("audio",{direction:"recvonly"}),b.log("Adding recvonly audio transceiver:",a))):t.removeAudio&&a&&(a.setDirection?a.setDirection("inactive"):a.direction="inactive",b.log("Setting audio transceiver to inactive:",a));var g=z(t),v=X(t);g||v?g&&v?c&&(c.setDirection?c.setDirection("sendrecv"):c.direction="sendrecv",b.log("Setting video transceiver to sendrecv:",c)):g&&!v?c&&(c.setDirection?c.setDirection("sendonly"):c.direction="sendonly",b.log("Setting video transceiver to sendonly:",c)):!g&&v&&(c?(c.setDirection?c.setDirection("recvonly"):c.direction="recvonly",b.log("Setting video transceiver to recvonly:",c)):(c=s.pc.addTransceiver("video",{direction:"recvonly"}),b.log("Adding recvonly video transceiver:",c))):t.removeVideo&&c&&(c.setDirection?c.setDirection("inactive"):c.direction="inactive",b.log("Setting video transceiver to inactive:",c))}else i.offerToReceiveAudio=G(t),i.offerToReceiveVideo=X(t);var p=!0===n.iceRestart;p&&(i.iceRestart=!0);b.debug(i);var f=z(t);b.log("执行peerConnection.createOffer，生成sdp信息"),s.pc.createOffer(i).then(async function(e){b.debug(e);var t={type:e.type,sdp:e.sdp};return n.customizeSdp(t),e.sdp=t.sdp,f&&o&&("chrome"===b.webRTCAdapter.browserDetails.browser||"safari"===b.webRTCAdapter.browserDetails.browser?b.log("Enabling Simulcasting for Chrome (SDP munging)"):"firefox"!==b.webRTCAdapter.browserDetails.browser&&b.warn("simulcast=true, but this is not Chrome nor Firefox, ignoring")),s.mySdp=e.sdp,b.log("设置local sdp信息：",e),"firefox"===b.webRTCAdapter.browserDetails.browser?(await s.pc.setLocalDescription(e),b.log("火狐执行 setLocalDescription 完毕")):s.pc.setLocalDescription(e).catch(n.error),e}).then(e=>{s.mediaConstraints=i,s.iceDone||s.trickle?(b.log("Offer ready"),n.success(e)):b.log("Waiting for all candidates...")}).catch(n.error)}(e,n,s):a.pc.setRemoteDescription(t).then(function(){if(b.log("Remote description accepted!"),a.remoteSdp=t.sdp,a.candidates&&a.candidates.length>0){for(var r=0;r<a.candidates.length;r++){var o=a.candidates[r];b.log("Adding remote candidate:",o),o&&!0!==o.completed?a.pc.addIceCandidate(o):a.pc.addIceCandidate(b.endOfCandidates)}a.candidates=[]}!function(e,t,n){b.log("进入createAnswer函数"),n=n||{},n.success="function"==typeof n.success?n.success:b.noop,n.error="function"==typeof n.error?n.error:b.noop,n.customizeSdp="function"==typeof n.customizeSdp?n.customizeSdp:b.noop;var r=E[e];if(null==r||null===r.webrtcStuff||void 0===r.webrtcStuff)return b.warn("Invalid handle"),void n.error("Invalid handle");var s=r.webrtcStuff,o=!0===n.simulcast;o?b.log("Creating answer (iceDone="+s.iceDone+", simulcast="+o+")"):b.log("Creating answer (iceDone="+s.iceDone+")");var i=null;if(b.unifiedPlan){i={};var a=null,c=null,d=s.pc.getTransceivers();if(d&&d.length>0)for(var l in d){var u=d[l];u.sender&&u.sender.track&&"audio"===u.sender.track.kind||u.receiver&&u.receiver.track&&"audio"===u.receiver.track.kind?a||(a=u):(u.sender&&u.sender.track&&"video"===u.sender.track.kind||u.receiver&&u.receiver.track&&"video"===u.receiver.track.kind)&&(c||(c=u))}var h=J(t),m=G(t);if(h||m){if(h&&m){if(a)try{a.setDirection?a.setDirection("sendrecv"):a.direction="sendrecv",b.log("Setting audio transceiver to sendrecv:",a)}catch(e){b.error(e)}}else if(h&&!m)try{a&&(a.setDirection?a.setDirection("sendonly"):a.direction="sendonly",b.log("Setting audio transceiver to sendonly:",a))}catch(e){b.error(e)}else if(!h&&m)if(a)try{a.setDirection?a.setDirection("recvonly"):a.direction="recvonly",b.log("Setting audio transceiver to recvonly:",a)}catch(e){b.error(e)}else a=s.pc.addTransceiver("audio",{direction:"recvonly"}),b.log("Adding recvonly audio transceiver:",a)}else if(t.removeAudio&&a)try{a.setDirection?a.setDirection("inactive"):a.direction="inactive",b.log("Setting audio transceiver to inactive:",a)}catch(e){b.error(e)}var g=z(t),v=X(t);if(g||v){if(g&&v){if(c)try{c.setDirection?c.setDirection("sendrecv"):c.direction="sendrecv",b.log("Setting video transceiver to sendrecv:",c)}catch(e){b.error(e)}}else if(g&&!v){if(c)try{c.setDirection?c.setDirection("sendonly"):c.direction="sendonly",b.log("Setting video transceiver to sendonly:",c)}catch(e){b.error(e)}}else if(!g&&v)if(c)try{c.setDirection?c.setDirection("recvonly"):c.direction="recvonly",b.log("Setting video transceiver to recvonly:",c)}catch(e){b.error(e)}else c=s.pc.addTransceiver("video",{direction:"recvonly"}),b.log("Adding recvonly video transceiver:",c)}else if(t.removeVideo&&c)try{c.setDirection?c.setDirection("inactive"):c.direction="inactive",b.log("Setting video transceiver to inactive:",c)}catch(e){b.error(e)}}else i="firefox"==b.webRTCAdapter.browserDetails.browser||"edge"==b.webRTCAdapter.browserDetails.browser?{offerToReceiveAudio:G(t),offerToReceiveVideo:X(t)}:{mandatory:{OfferToReceiveAudio:G(t),OfferToReceiveVideo:X(t)}};b.debug(i);var p=z(t);if(p&&o&&"firefox"===b.webRTCAdapter.browserDetails.browser){b.log("Enabling Simulcasting for Firefox (RID)");var f=s.pc.getSenders()[1];b.log(f);var _=f.getParameters();b.log(_);const e=S(n.simulcastMaxBitrates);f.setParameters({encodings:[{rid:"high",active:!0,priority:"high",maxBitrate:e.high},{rid:"medium",active:!0,priority:"medium",maxBitrate:e.medium},{rid:"low",active:!0,priority:"low",maxBitrate:e.low}]})}s.pc.createAnswer(i).then(function(e){b.debug(e);var t={type:e.type,sdp:e.sdp};n.customizeSdp(t),e.sdp=t.sdp,b.log("Setting local description"),p&&o&&("chrome"===b.webRTCAdapter.browserDetails.browser?b.warn("simulcast=true, but this is an answer, and video breaks in Chrome if we enable it"):"firefox"!==b.webRTCAdapter.browserDetails.browser&&b.warn("simulcast=true, but this is not Chrome nor Firefox, ignoring")),s.mySdp=e.sdp,s.pc.setLocalDescription(e).catch(n.error),s.mediaConstraints=i,s.iceDone||s.trickle?n.success(e):b.log("Waiting for all candidates...")},n.error)}(e,n,s)},s.error)}function U(e,t,n){b.debug("进入prepareWebrtc函数"),(n=n||{}).success="function"==typeof n.success?n.success:b.noop,n.error="function"==typeof n.error?n.error:K,n.customizeSdp="function"==typeof n.customizeSdp?n.customizeSdp:b.noop,n.customizeAudioTrack="function"==typeof n.customizeAudioTrack?n.customizeAudioTrack:b.noop;var r=n.jsep;if(t&&r)return b.error("Provided a JSEP to a createOffer"),void n.error("Provided a JSEP to a createOffer");if(!(t||r&&r.type&&r.sdp))return b.error("A valid JSEP is required for createAnswer"),void n.error("A valid JSEP is required for createAnswer");n.media=n.media||{audio:!0,video:!0};var s=n.media,o=E[e];if(null==o||null===o.webrtcStuff||void 0===o.webrtcStuff)return b.warn("Invalid handle"),void n.error("Invalid handle");var i,a=o.webrtcStuff;if(a.trickle=(i=n.trickle,b.debug("isTrickleEnabled:",i),null==i||!0===i),void 0===a.pc||null===a.pc)s.update=!1,s.keepAudio=!1,s.keepVideo=!1;else if(void 0!==a.pc&&null!==a.pc){if(b.log("Updating existing media session"),s.update=!0,null!==n.stream&&void 0!==n.stream)n.stream!==a.myStream&&b.log("Renegotiation involves a new external stream");else{if(s.addAudio){if(s.keepAudio=!1,s.replaceAudio=!1,s.removeAudio=!1,s.audioSend=!0,a.myStream&&a.myStream.getAudioTracks()&&a.myStream.getAudioTracks().length)return b.error("Can't add audio stream, there already is one"),void n.error("Can't add audio stream, there already is one")}else s.removeAudio?(s.keepAudio=!1,s.replaceAudio=!1,s.addAudio=!1,s.audioSend=!1):s.replaceAudio&&(s.keepAudio=!1,s.addAudio=!1,s.removeAudio=!1,s.audioSend=!0);if(null===a.myStream||void 0===a.myStream?(s.replaceAudio&&(s.keepAudio=!1,s.replaceAudio=!1,s.addAudio=!0,s.audioSend=!0),J(s)&&(s.keepAudio=!1,s.addAudio=!0)):null===a.myStream.getAudioTracks()||void 0===a.myStream.getAudioTracks()||0===a.myStream.getAudioTracks().length?(s.replaceAudio&&(s.keepAudio=!1,s.replaceAudio=!1,s.addAudio=!0,s.audioSend=!0),J(s)&&(s.keepVideo=!1,s.addAudio=!0)):!J(s)||s.removeAudio||s.replaceAudio||(s.keepAudio=!0),s.addVideo){if(s.keepVideo=!1,s.replaceVideo=!1,s.removeVideo=!1,s.videoSend=!0,a.myStream&&a.myStream.getVideoTracks()&&a.myStream.getVideoTracks().length)return b.error("Can't add video stream, there already is one"),void n.error("Can't add video stream, there already is one")}else s.removeVideo?(s.keepVideo=!1,s.replaceVideo=!1,s.addVideo=!1,s.videoSend=!1):s.replaceVideo&&(s.keepVideo=!1,s.addVideo=!1,s.removeVideo=!1,s.videoSend=!0);null===a.myStream||void 0===a.myStream||null===a.myStream.getVideoTracks()||void 0===a.myStream.getVideoTracks()||0===a.myStream.getVideoTracks().length?(s.replaceVideo&&(s.keepVideo=!1,s.replaceVideo=!1,s.addVideo=!0,s.videoSend=!0),z(s)&&(s.keepVideo=!1,s.addVideo=!0)):!z(s)||s.removeVideo||s.replaceVideo||(s.keepVideo=!0),s.addData&&(s.data=!0)}if(J(s)&&s.keepAudio&&z(s)&&s.keepVideo)return o.consentDialog(!1),void x(e,r,s,n,a.myStream)}if(s.update&&!a.streamExternal){if(s.removeAudio||s.replaceAudio){if(a.myStream&&a.myStream.getAudioTracks()&&a.myStream.getAudioTracks().length){var c=a.myStream.getAudioTracks()[0];b.log("Removing audio track:",c);try{c.stop(),a.myStream.removeTrack(c)}catch(A){}}if(a.pc.getSenders()&&a.pc.getSenders().length){var d=!0;if(s.replaceAudio&&b.unifiedPlan&&(d=!1),d)for(var l in a.pc.getSenders()){(c=a.pc.getSenders()[l])&&c.track&&"audio"===c.track.kind&&(b.log("Removing audio sender:",c),a.pc.removeTrack(c))}}}if(s.removeVideo||s.replaceVideo){if(a.myStream&&a.myStream.getVideoTracks()&&a.myStream.getVideoTracks().length){c=a.myStream.getVideoTracks()[0];b.log("Removing video track:",c);try{c.stop(),a.myStream.removeTrack(c)}catch(k){}}if(a.pc.getSenders()&&a.pc.getSenders().length){var u=!0;if(s.replaceVideo&&b.unifiedPlan&&(u=!1),u)for(var l in a.pc.getSenders()){(c=a.pc.getSenders()[l])&&c.track&&"video"===c.track.kind&&(b.log("Removing video sender:",c),a.pc.removeTrack(c))}}}}if(null!==n.stream&&void 0!==n.stream){var h=n.stream;if(b.log("MediaStream provided by the application"),b.debug(h),s.update&&a.myStream&&a.myStream!==n.stream&&!a.streamExternal){try{var m=a.myStream.getTracks();for(var g in m){var v=m[g];b.log(v),null!=v&&v.stop()}}catch(w){}a.myStream=null}return a.streamExternal=!0,o.consentDialog(!1),void x(e,r,s,n,h)}if(J(s)||z(s)){if(!b.isGetUserMediaAvailable())return void n.error("getUserMedia not available");var p={mandatory:{},optional:[]};o.consentDialog(!0);var f=J(s);!0===f&&null!=s&&null!=s&&"object"==typeof s.audio&&(f=s.audio);var _=z(s);if(!0===_&&null!=s&&null!=s)if(!(!0===n.simulcast)||r||void 0!==s.video&&!1!==s.video||(s.video="hires"),s.video&&"screen"!=s.video&&"window"!=s.video)if("object"==typeof s.video)_=s.video;else{var S=0,T=0;"lowres"===s.video?(T=240,S=320):"lowres-16:9"===s.video?(T=180,S=320):"hires"===s.video||"hires-16:9"===s.video||"hdres"===s.video?(T=720,S=1280):"fhdres"===s.video?(T=1080,S=1920):"4kres"===s.video?(T=2160,S=3840):"stdres"===s.video?(T=480,S=640):"stdres-16:9"===s.video?(T=360,S=640):(b.log("Default video setting is stdres 4:3"),T=480,S=640),b.log("Adding media constraint:",s.video),_={height:{ideal:T,max:T},width:{ideal:S,max:S}},b.log("Adding video constraint:",_)}else if("screen"===s.video||"window"===s.video){if(s.screenshareFrameRate||(s.screenshareFrameRate=3),navigator.mediaDevices&&navigator.mediaDevices.getDisplayMedia){const O={};n.screenWidth&&(O.width={ideal:n.screenWidth}),n.screenHeight&&(O.height={ideal:n.screenHeight}),n.displaySurface&&(O.displaySurface=n.displaySurface);const D=!(O.width||O.height||O.displaySurface)||O;return b.log("采集屏幕约束条件设置：",D),void navigator.mediaDevices.getDisplayMedia({video:D}).then(function(t){function i(){var i;o.consentDialog(!1),O.frameRate={exact:n.frameRate||15},t.getVideoTracks()[0].applyConstraints(O),(null===(i=t.getVideoTracks()[0])||void 0===i?void 0:i.getCapabilities)&&b.log("采集到的屏幕约束条件范围：",t.getVideoTracks()[0].getCapabilities()),b.log("采集到的屏幕约束条件：",t.getVideoTracks()[0].getSettings()),J(s)&&!s.keepAudio?navigator.mediaDevices.getUserMedia({audio:!0,video:!1}).then(function(o){t.addTrack(o.getAudioTracks()[0]),x(e,r,s,n,t)}):x(e,r,s,n,t)}"safari"===b.webRTCAdapter.browserDetails.browser?setTimeout(i,1500):i()}).catch(e=>{o.consentDialog(!1),n.error(e)})}function P(t,i){o.consentDialog(!1),t?n.error(t):x(e,r,s,n,i)}function C(e,t,n){b.log("Adding media constraint (screen capture)"),b.debug(e),navigator.mediaDevices.getUserMedia(e).then(function(e){n?navigator.mediaDevices.getUserMedia({audio:!0,video:!1}).then(function(n){e.addTrack(n.getAudioTracks()[0]),t(null,e)}):t(null,e)}).catch(function(e){o.consentDialog(!1),t(e)})}if("chrome"===b.webRTCAdapter.browserDetails.browser){var I=b.webRTCAdapter.browserDetails.version,y=33;window.navigator.userAgent.match("Linux")&&(y=35),I>=26&&I<=y?C(p={video:{mandatory:{googLeakyBucket:!0,maxWidth:window.screen.width,maxHeight:window.screen.height,minFrameRate:s.screenshareFrameRate,maxFrameRate:s.screenshareFrameRate,chromeMediaSource:"screen"}},audio:J(s)&&!s.keepAudio},P):b.extension.getScreen(function(e,t){if(e)return o.consentDialog(!1),n.error(e);(p={audio:!1,video:{mandatory:{chromeMediaSource:"desktop",maxWidth:window.screen.width,maxHeight:window.screen.height,minFrameRate:s.screenshareFrameRate,maxFrameRate:s.screenshareFrameRate},optional:[{googLeakyBucket:!0},{googTemporalLayeredScreencast:!0}]}}).video.mandatory.chromeMediaSourceId=t,C(p,P,J(s)&&!s.keepAudio)})}else if("firefox"===b.webRTCAdapter.browserDetails.browser){if(!(b.webRTCAdapter.browserDetails.version>=33)){var R=new Error("NavigatorUserMediaError");return R.name="Your version of Firefox does not support screen sharing, please install Firefox 33 (or more recent versions)",o.consentDialog(!1),void n.error(R)}C(p={video:{mozMediaSource:s.video,mediaSource:s.video},audio:J(s)&&!s.keepAudio},function(e,t){if(P(e,t),!e)var n=t.currentTime,r=window.setInterval(function(){t||window.clearInterval(r),t.currentTime==n&&(window.clearInterval(r),t.onended&&t.onended()),n=t.currentTime},500)})}return}null!=s&&"screen"===s.video||navigator.mediaDevices.enumerateDevices().then(function(t){var i=t.some(function(e){return"audioinput"===e.kind}),a=function(e){if(b.debug("isScreenSendEnabled:",e),null==e)return!1;if("object"!=typeof e.video||"object"!=typeof e.video.mandatory)return!1;var t=e.video.mandatory;if(t.chromeMediaSource)return"desktop"===t.chromeMediaSource||"screen"===t.chromeMediaSource;if(t.mozMediaSource)return"window"===t.mozMediaSource||"screen"===t.mozMediaSource;if(t.mediaSource)return"window"===t.mediaSource||"screen"===t.mediaSource;return!1}(s)||t.some(function(e){return"videoinput"===e.kind}),c=J(s),d=z(s),l=function(e){return b.debug("isAudioSendRequired:",e),null!=e&&(!1!==e.audio&&!1!==e.audioSend&&(void 0!==e.failIfNoAudio&&null!==e.failIfNoAudio&&!0===e.failIfNoAudio))}(s),u=function(e){return b.debug("isVideoSendRequired:",e),null!=e&&(!1!==e.video&&!1!==e.videoSend&&(void 0!==e.failIfNoVideo&&null!==e.failIfNoVideo&&!0===e.failIfNoVideo))}(s);if(c||d||l||u){var m=!!c&&i,g=!!d&&a;if(!m&&!g)return o.consentDialog(!1),n.error("No capture device found"),!1;if(!m&&l)return o.consentDialog(!1),n.error("Audio capture is required, but no capture device found"),!1;if(!g&&u)return o.consentDialog(!1),n.error("Video capture is required, but no capture device found"),!1}let v={audio:!(!i||s.keepAudio)&&f,video:!(!a||s.keepVideo)&&_};if(s.encodings&&(v=s.encodings),b.log("采集音视频约束条件设置：",v),v.audio||v.video){const t=3,i=function(a){let c=!1,d=window.setTimeout(()=>{b.log(`getUserMedia重试次数：${a}`),c=!0,d=null,a>=t?n.error("getUserMedia timeout"):i(++a)},3e3);navigator.mediaDevices.getUserMedia(s.encodings?s.encodings:v).then(async function(t){var i;if(c)return void t.getTracks().forEach(e=>{e.stop()});o.consentDialog(!1);const a=null===(i=t.getVideoTracks())||void 0===i?void 0:i[0],d={...v.video,frameRate:{ideal:n.frameRate,max:n.frameRate}};var l;a&&(a.applyConstraints(d),(null===(l=t.getVideoTracks()[0])||void 0===l?void 0:l.getCapabilities)&&b.log("摄像头采集后，约束条件范围：",t.getVideoTracks()[0].getCapabilities()),b.log("摄像头采集后，约束条件：",t.getVideoTracks()[0].getSettings()));x(e,r,s,n,t)}).catch(function(e){o.consentDialog(!1),n.error({code:e.code,name:e.name,message:e.message})}).finally(()=>{window.clearTimeout(d),d=null})};i(1)}else o.consentDialog(!1),x(e,r,s,n,h)}).catch(function(e){o.consentDialog(!1),n.error(`enumerateDevices error：${e}`)})}else x(e,r,s,n)}function Y(e,t){(t=t||{}).success="function"==typeof t.success?t.success:b.noop,t.error="function"==typeof t.error?t.error:K;var n=t.jsep,r=E[e];if(null==r||null===r.webrtcStuff||void 0===r.webrtcStuff)return b.warn("Invalid handle"),void t.error("Invalid handle");var s=r.webrtcStuff;if(null!=n){if(null===s.pc)return b.warn("Wait, no PeerConnection?? if this is an answer, use createAnswer and not handleRemoteJsep"),void t.error("No PeerConnection: if this is an answer, use createAnswer and not handleRemoteJsep");s.pc.setRemoteDescription(n).then(function(){if(b.log("设置remote sdp成功"),s.remoteSdp=n.sdp,s.candidates&&s.candidates.length>0){for(var e=0;e<s.candidates.length;e++){var r=s.candidates[e];b.log("Adding remote candidate:",r),r&&!0!==r.completed?s.pc.addIceCandidate(r):s.pc.addIceCandidate(b.endOfCandidates)}s.candidates=[]}t.success()},t.error)}else t.error("Invalid JSEP")}function j(e,t){var n=E[e];if(null==n||null===n.webrtcStuff||void 0===n.webrtcStuff)return b.warn("Invalid handle"),0;var r=t?"remote":"local",s=n.webrtcStuff;return s.volume[r]||(s.volume[r]={value:0}),s.pc.getStats&&"chrome"===b.webRTCAdapter.browserDetails.browser?!t||null!==s.remoteStream&&void 0!==s.remoteStream?t||null!==s.myStream&&void 0!==s.myStream?null===s.volume[r].timer||void 0===s.volume[r].timer?(b.log("Starting "+r+" volume monitor"),s.volume[r].timer=setInterval(function(){s.pc.getStats(function(e){for(var n=e.result(),o=0;o<n.length;o++){var i=n[o];"ssrc"==i.type&&(t&&i.stat("audioOutputLevel")?s.volume[r].value=parseInt(i.stat("audioOutputLevel")):!t&&i.stat("audioInputLevel")&&(s.volume[r].value=parseInt(i.stat("audioInputLevel"))))}})},200),0):s.volume[r].value:(b.warn("Local stream unavailable"),0):(b.warn("Remote stream unavailable"),0):(b.warn("Getting the "+r+" volume unsupported by browser"),0)}function $(e,t){var n=E[e];if(null==n||null===n.webrtcStuff||void 0===n.webrtcStuff)return b.warn("Invalid handle"),!0;var r=n.webrtcStuff;return null===r.pc||void 0===r.pc?(b.warn("Invalid PeerConnection"),!0):void 0===r.myStream||null===r.myStream?(b.warn("Invalid local MediaStream"),!0):t?null===r.myStream.getVideoTracks()||void 0===r.myStream.getVideoTracks()||0===r.myStream.getVideoTracks().length?(b.warn("No video track"),!0):!r.myStream.getVideoTracks()[0].enabled:null===r.myStream.getAudioTracks()||void 0===r.myStream.getAudioTracks()||0===r.myStream.getAudioTracks().length?(b.warn("No audio track"),!0):!r.myStream.getAudioTracks()[0].enabled}function H(e,t,n){var r=E[e];if(null==r||null===r.webrtcStuff||void 0===r.webrtcStuff)return b.warn("Invalid handle"),!1;var s=r.webrtcStuff;return null===s.pc||void 0===s.pc?(b.warn("Invalid PeerConnection"),!1):void 0===s.myStream||null===s.myStream?(b.warn("Invalid local MediaStream"),!1):t?null===s.myStream.getVideoTracks()||void 0===s.myStream.getVideoTracks()||0===s.myStream.getVideoTracks().length?(b.warn("No video track"),!1):(s.myStream.getVideoTracks()[0].enabled=!n,!0):null===s.myStream.getAudioTracks()||void 0===s.myStream.getAudioTracks()||0===s.myStream.getAudioTracks().length?(b.warn("No audio track"),!1):(s.myStream.getAudioTracks()[0].enabled=!n,!0)}function F(e,t){var n=E[e];if(null==n||null===n.webrtcStuff||void 0===n.webrtcStuff)return b.warn("Invalid handle"),"Invalid handle";var r=n.webrtcStuff;return null===r.pc||void 0===r.pc?"Invalid PeerConnection":r.pc.getStats?void r.pc.getStats().then(function(e){const n={};e.forEach(function(e){if(!e)return;let t=!1;if(n[e.type]=e,("inbound-rtp"===e.type||"outbound-rtp"===e.type)&&e.id.indexOf("rtcp")<0?t=!0:("ssrc"!=e.type||!e.bytesReceived||"VP8"!==e.googCodecName&&""!==e.googCodecName)&&("ssrc"!=e.type||!e.bytesSent||"VP8"!==e.googCodecName&&""!==e.googCodecName)||(t=!0),t)if(r.bitrate.bsnow=e.bytesReceived,r.bitrate.tsnow=e.timestamp,null===r.bitrate.bsbefore||null===r.bitrate.tsbefore)r.bitrate.bsbefore=r.bitrate.bsnow,r.bitrate.tsbefore=r.bitrate.tsnow;else{var s=r.bitrate.tsnow-r.bitrate.tsbefore;"safari"==b.webRTCAdapter.browserDetails.browser&&(s/=1e3);var o=Math.round(8*(r.bitrate.bsnow-r.bitrate.bsbefore)/s);"safari"===b.webRTCAdapter.browserDetails.browser&&(o=parseInt(o/1e3)),r.bitrate.value=o+" kbits/sec",r.bitrate.bsbefore=r.bitrate.bsnow,r.bitrate.tsbefore=r.bitrate.tsnow}}),t&&t(n)}):(b.warn("Getting the video bitrate unsupported by browser"),"Feature unsupported by browser")}function q(e,t,n){const r=E[e];r.listenList[t]||(r.listenList[t]=[]);for(var s=0;s<r.listenList[t].length;s++)if(r.listenList[t][s].fn===n)return;r.listenList[t].push({time:(new Date).getTime(),fn:n})}function Q(e,t,n){const r=E[e],s=r.listenList[t];if(!s||0===s.length)return!1;(new Date).getTime();for(let e=0;e<s.length;e++){s[e].fn.call(r,n)}r.listenList[t]=null}function B(e){var t=E[e];if(null==t||null===t.webrtcStuff||void 0===t.webrtcStuff)return b.warn("Invalid handle"),"Invalid handle";var n=t.webrtcStuff;return null===n.pc||void 0===n.pc?"Invalid PeerConnection":n.pc.getStats?null===n.bitrate.timer||void 0===n.bitrate.timer?(b.log("Starting bitrate timer (via getStats)"),n.bitrate.timer=setInterval(function(){n.pc.getStats().then(function(e){e.forEach(function(e){if(e){var t=!1;if(("video"===e.mediaType||e.id.toLowerCase().indexOf("video")>-1)&&"inbound-rtp"===e.type&&e.id.indexOf("rtcp")<0?t=!0:"ssrc"!=e.type||!e.bytesReceived||"VP8"!==e.googCodecName&&""!==e.googCodecName||(t=!0),t)if(n.bitrate.bsnow=e.bytesReceived,n.bitrate.tsnow=e.timestamp,null===n.bitrate.bsbefore||null===n.bitrate.tsbefore)n.bitrate.bsbefore=n.bitrate.bsnow,n.bitrate.tsbefore=n.bitrate.tsnow;else{var r=n.bitrate.tsnow-n.bitrate.tsbefore;"safari"==b.webRTCAdapter.browserDetails.browser&&(r/=1e3);var s=Math.round(8*(n.bitrate.bsnow-n.bitrate.bsbefore)/r);"safari"===b.webRTCAdapter.browserDetails.browser&&(s=parseInt(s/1e3)),n.bitrate.value=s+" kbits/sec",n.bitrate.bsbefore=n.bitrate.bsnow,n.bitrate.tsbefore=n.bitrate.tsnow}}})})},1e3),"0 kbits/sec"):n.bitrate.value:(b.warn("Getting the video bitrate unsupported by browser"),"Feature unsupported by browser")}function K(e){b.error("WebRTC error:",e)}function W(e,t){b.log("Cleaning WebRTC stuff");var s=E[e];if(null!=s){var o=s.webrtcStuff;if(null!=o){if(!0===t){var i={rtcgw:"hangup",transaction:b.randomString(12)};null!==s.token&&void 0!==s.token&&(i.token=s.token),null!=p&&(i.apisecret=p),b.debug("Sending hangup request (handle="+e+"):"),b.debug(i),n?(i.session_id=I,i.handle_id=e,r.send(JSON.stringify(i))):b.httpAPICall(c+"/"+I+"/"+e,{verb:"POST",withCredentials:m,body:i})}o.remoteStream=null,o.volume&&(o.volume.local&&o.volume.local.timer&&clearInterval(o.volume.local.timer),o.volume.remote&&o.volume.remote.timer&&clearInterval(o.volume.remote.timer)),o.volume={},o.bitrate.timer&&clearInterval(o.bitrate.timer),o.bitrate.timer=null,o.bitrate.bsnow=null,o.bitrate.bsbefore=null,o.bitrate.tsnow=null,o.bitrate.tsbefore=null,o.bitrate.value=null;try{if(!o.streamExternal&&null!==o.myStream&&void 0!==o.myStream){b.log("Stopping local stream tracks");var a=o.myStream.getTracks();for(var d in a){var l=a[d];b.log(l),null!=l&&l.stop()}}}catch(e){}o.streamExternal=!1,o.myStream=null;try{b.log("关闭peerConnection"),o.pc.close()}catch(e){}o.pc=null,o.candidates=null,o.mySdp=null,o.remoteSdp=null,o.iceDone=!1,o.dataChannel={},o.dtmfSender=null}s.oncleanup()}}function J(e){return b.debug("isAudioSendEnabled:",e),null==e||!1!==e.audio&&(void 0===e.audioSend||null===e.audioSend||!0===e.audioSend)}function G(e){return b.debug("isAudioRecvEnabled:",e),null==e||!1!==e.audio&&(void 0===e.audioRecv||null===e.audioRecv||!0===e.audioRecv)}function z(e){return b.debug("isVideoSendEnabled:",e),null==e||!1!==e.video&&(void 0===e.videoSend||null===e.videoSend||!0===e.videoSend)}function X(e){return b.debug("isVideoRecvEnabled:",e),null==e||!1!==e.video&&(void 0===e.videoRecv||null===e.videoRecv||!0===e.videoRecv)}C(e),this.getServer=function(){return c},this.isConnected=function(){return T},this.reconnect=function(e){(e=e||{}).success="function"==typeof e.success?e.success:b.noop,e.error="function"==typeof e.error?e.error:b.noop,e.reconnect=!0,C(e)},this.getSessionId=function(){return I},this.destroy=function(t){!function(t){t=t||{},t.success="function"==typeof t.success?t.success:b.noop;var i=!0;void 0!==t.asyncRequest&&null!==t.asyncRequest&&(i=!0===t.asyncRequest);var a=!0;void 0!==t.notifyDestroyed&&null!==t.notifyDestroyed&&(a=!0===t.notifyDestroyed);var d=!1;void 0!==t.cleanupHandles&&null!==t.cleanupHandles&&(d=!0===t.cleanupHandles);if(b.log("Destroying session "+I+" (async="+i+")"),!T)return b.warn("Is the server down? (connected=false)"),void t.success();if(null==I)return b.warn("No session to destroy"),t.success(),void(a&&e.destroyed());if(d)for(var l in E)L(l,{noRequest:!0});var u={rtcgw:"destroy",transaction:b.randomString(12)};null!=v&&(u.token=v);null!=p&&(u.apisecret=p);if(n){u.session_id=I;var h=function(){for(var e in s)r.removeEventListener(e,s[e]);r.removeEventListener("message",g),r.removeEventListener("error",f),o&&clearTimeout(o),r.close()},g=function(n){var r=JSON.parse(n.data);r.session_id==u.session_id&&r.transaction==u.transaction&&(h(),t.success(),a&&e.destroyed())},f=function(n){h(),t.error("Failed to destroy the server: Is the server down?"),a&&e.destroyed()};return r.addEventListener("message",g),r.addEventListener("error",f),void r.send(JSON.stringify(u))}b.httpAPICall(c+"/"+I,{verb:"POST",async:i,withCredentials:m,body:u,success:function(n){b.log("Destroyed session:"),b.debug(n),I=null,T=!1,"success"!==n.rtcgw&&b.error("Ooops: "+n.error.code+" "+n.error.reason),t.success(),a&&e.destroyed()},error:function(n,r){b.error(n+":",r),I=null,T=!1,t.success(),a&&e.destroyed(),pluginHandlesp}})}(t)},this.attach=function(e){!function(e){if(e=e||{},e.success="function"==typeof e.success?e.success:b.noop,e.error="function"==typeof e.error?e.error:b.noop,e.consentDialog="function"==typeof e.consentDialog?e.consentDialog:b.noop,e.iceState="function"==typeof e.iceState?e.iceState:b.noop,e.mediaState="function"==typeof e.mediaState?e.mediaState:b.noop,e.webrtcState="function"==typeof e.webrtcState?e.webrtcState:b.noop,e.slowLink="function"==typeof e.slowLink?e.slowLink:b.noop,e.onmessage="function"==typeof e.onmessage?e.onmessage:b.noop,e.onlocalstream="function"==typeof e.onlocalstream?e.onlocalstream:b.noop,e.onremotestream="function"==typeof e.onremotestream?e.onremotestream:b.noop,e.ondata="function"==typeof e.ondata?e.ondata:b.noop,e.ondataopen="function"==typeof e.ondataopen?e.ondataopen:b.noop,e.oncleanup="function"==typeof e.oncleanup?e.oncleanup:b.noop,e.ondetached="function"==typeof e.ondetached?e.ondetached:b.noop,!T)return b.warn("Is the server down? (connected=false)"),void e.error("Is the server down? (connected=false)");var t=e.plugin;if(null==t)return b.error("Invalid plugin"),void e.error("Invalid plugin");var s=e.opaqueId,o=e.token?e.token:v,i=b.randomString(12),a={rtcgw:"attach",plugin:t,opaque_id:s,transaction:i};null!=o&&(a.token=o);null!=p&&(a.apisecret=p);if(n)return A[i]=function(n){if(b.debug(n),"success"!==n.rtcgw)return b.error("Ooops: "+n.error.code+" "+n.error.reason),void e.error("Ooops: "+n.error.code+" "+n.error.reason);var r=n.data.id;b.log("Created handle: "+r);var s={session:y,plugin:t,id:r,token:o,detached:!1,webrtcStuff:{started:!1,myStream:null,streamExternal:!1,remoteStream:null,mySdp:null,mediaConstraints:null,pc:null,dataChannel:{},dtmfSender:null,trickle:!0,iceDone:!1,volume:{value:null,timer:null},bitrate:{value:null,bsnow:null,bsbefore:null,tsnow:null,tsbefore:null,timer:null}},listenList:[],getId:function(){return r},getPlugin:function(){return t},getVolume:function(){return j(r,!0)},getRemoteVolume:function(){return j(r,!0)},getLocalVolume:function(){return j(r,!1)},isAudioMuted:function(){return $(r,!1)},muteAudio:function(){return H(r,!1,!0)},unmuteAudio:function(){return H(r,!1,!1)},isVideoMuted:function(){return $(r,!0)},muteVideo:function(){return H(r,!0,!0)},unmuteVideo:function(){return H(r,!0,!1)},getBitrate:function(){return B(r)},getNetworkQuality:function(e,t){F(e,t)},messageListen:function(e,t){q(r,e,t)},messageTrigger:function(e,t){Q(r,e,t)},send:function(e){O(r,e)},data:function(e){M(r,e)},dtmf:function(e){V(r,e)},consentDialog:e.consentDialog,iceState:e.iceState,mediaState:e.mediaState,webrtcState:e.webrtcState,slowLink:e.slowLink,onmessage:e.onmessage,createOffer:function(e){U(r,!0,e)},createAnswer:function(e){U(r,!1,e)},handleRemoteJsep:function(e){Y(r,e)},onlocalstream:e.onlocalstream,onremotestream:e.onremotestream,ondata:e.ondata,ondataopen:e.ondataopen,oncleanup:e.oncleanup,ondetached:e.ondetached,hangup:function(e){W(r,!0===e)},detach:function(e){L(r,e)}};E[r]=s,e.success(s)},a.session_id=I,void r.send(JSON.stringify(a));b.httpAPICall(c+"/"+I,{verb:"POST",withCredentials:m,body:a,success:function(n){if(b.debug(n),"success"!==n.rtcgw)return b.error("Ooops: "+n.error.code+" "+n.error.reason),void e.error("Ooops: "+n.error.code+" "+n.error.reason);var r=n.data.id;b.log("Created handle: "+r);var s={session:y,plugin:t,id:r,token:o,detached:!1,webrtcStuff:{started:!1,myStream:null,streamExternal:!1,remoteStream:null,mySdp:null,mediaConstraints:null,pc:null,dataChannel:{},dtmfSender:null,trickle:!0,iceDone:!1,volume:{value:null,timer:null},bitrate:{value:null,bsnow:null,bsbefore:null,tsnow:null,tsbefore:null,timer:null}},listenList:[],getId:function(){return r},getPlugin:function(){return t},getVolume:function(){return j(r,!0)},getRemoteVolume:function(){return j(r,!0)},getLocalVolume:function(){return j(r,!1)},isAudioMuted:function(){return $(r,!1)},muteAudio:function(){return H(r,!1,!0)},unmuteAudio:function(){return H(r,!1,!1)},isVideoMuted:function(){return $(r,!0)},muteVideo:function(){return H(r,!0,!0)},unmuteVideo:function(){return H(r,!0,!1)},getBitrate:function(){return B(r)},getNetworkQuality:function(e){F(r,e)},messageListen:function(e,t){q(r,e,t)},messageTrigger:function(e,t){Q(r,e,t)},send:function(e){O(r,e)},data:function(e){M(r,e)},dtmf:function(e){V(r,e)},consentDialog:e.consentDialog,iceState:e.iceState,mediaState:e.mediaState,webrtcState:e.webrtcState,slowLink:e.slowLink,onmessage:e.onmessage,createOffer:function(e){U(r,!0,e)},createAnswer:function(e){U(r,!1,e)},handleRemoteJsep:function(e){Y(r,e)},onlocalstream:e.onlocalstream,onremotestream:e.onremotestream,ondata:e.ondata,ondataopen:e.ondataopen,oncleanup:e.oncleanup,ondetached:e.ondetached,hangup:function(e){W(r,!0===e)},detach:function(e){L(r,e)}};E[r]=s,e.success(s)},error:function(e,t){b.error(e+":",t)}})}(e)}}b.init=function(e){if((e=e||{}).callback="function"==typeof e.callback?e.callback:b.noop,!0===b.initDone)e.callback();else{"undefined"!=typeof console&&void 0!==console.log||(console={log:function(){}}),b.trace=b.noop,b.debug=b.noop,b.vdebug=b.noop,b.log=b.noop,b.warn=b.noop,b.error=b.noop,["log","debug","vdebug","info","warn","error","trace"].forEach(t=>{(Array.isArray(e.debug)&&e.debug.includes(t)||!0===e.debug||"all"===e.debug)&&Object.defineProperty(b,t,{get:function(){return E[t]},set:function(e){E[t]=e}})}),b.log("Initializing library");var t=e.dependencies||b.useDefaultDependencies();b.isArray=t.isArray,b.webRTCAdapter=t.webRTCAdapter,b.httpAPICall=t.httpAPICall,b.newWebSocket=t.newWebSocket,b.extension=t.extension,b.extension.init(),b.listDevices=function(e,t){e="function"==typeof e?e:b.noop,null==t&&(t={audio:!0,video:!0}),b.isGetUserMediaAvailable()?navigator.mediaDevices.getUserMedia(t).then(function(t){navigator.mediaDevices.enumerateDevices().then(function(n){b.debug(n),e(n);try{var r=t.getTracks();for(var s in r){var o=r[s];null!=o&&o.stop()}}catch(e){}})}).catch(function(t){b.error(t),e([])}):(b.warn("navigator.mediaDevices unavailable"),e([]))},b.attachMediaStream=function(e,t){try{"srcObject"in e?e.srcObject=t:e.src=URL.createObjectURL(t)}catch(e){b.error("Error attaching stream to element")}},b.reattachMediaStream=function(e,t){"chrome"===b.webRTCAdapter.browserDetails.browser?b.webRTCAdapter.browserDetails.version>=52?e.srcObject=t.srcObject:void 0!==e.src?e.src=t.src:b.error("Error reattaching stream to element"):e.srcObject=t.srcObject};var n=["iPad","iPhone","iPod"].indexOf(navigator.platform)>=0?"pagehide":"beforeunload",r=window["on"+n];if(window.addEventListener(n,function(e){for(var t in b.log("Closing window"),b.sessions)null!==b.sessions[t]&&void 0!==b.sessions[t]&&b.sessions[t].destroyOnUnload&&(b.log("Destroying session "+t),b.sessions[t].destroy({asyncRequest:!1,notifyDestroyed:!1}));r&&"function"==typeof r&&r()}),b.safariVp8=!1,"safari"===b.webRTCAdapter.browserDetails.browser&&b.webRTCAdapter.browserDetails.version>=605)if(RTCRtpSender&&RTCRtpSender.getCapabilities&&RTCRtpSender.getCapabilities("video")&&RTCRtpSender.getCapabilities("video").codecs&&RTCRtpSender.getCapabilities("video").codecs.length){for(var s in RTCRtpSender.getCapabilities("video").codecs){var o=RTCRtpSender.getCapabilities("video").codecs[s];if(o&&o.mimeType&&"video/vp8"===o.mimeType.toLowerCase()){b.safariVp8=!0;break}}b.safariVp8?b.log("This version of Safari supports VP8"):b.warn("This version of Safari does NOT support VP8: if you're using a Technology Preview, try enabling the 'WebRTC VP8 codec' setting in the 'Experimental Features' Develop menu")}else{var i=new RTCPeerConnection({},{});i.createOffer({offerToReceiveVideo:!0}).then(function(e){b.safariVp8=-1!==e.sdp.indexOf("VP8"),b.safariVp8?b.log("This version of Safari supports VP8"):b.warn("This version of Safari does NOT support VP8: if you're using a Technology Preview, try enabling the 'WebRTC VP8 codec' setting in the 'Experimental Features' Develop menu"),i.close(),i=null})}if(b.unifiedPlan=!1,"firefox"===b.webRTCAdapter.browserDetails.browser&&b.webRTCAdapter.browserDetails.version>=59)b.unifiedPlan=!0;else if("chrome"===b.webRTCAdapter.browserDetails.browser&&b.webRTCAdapter.browserDetails.version<72)b.unifiedPlan=!1;else if("currentDirection"in RTCRtpTransceiver.prototype){const e=new RTCPeerConnection;try{e.addTransceiver("audio"),b.unifiedPlan=!0}catch(e){}e.close()}else b.unifiedPlan=!1;b.initDone=!0,e.callback()}},b.isWebrtcSupported=function(){return void 0!==window.RTCPeerConnection&&null!==window.RTCPeerConnection},b.isGetUserMediaAvailable=function(){return void 0!==navigator.mediaDevices&&null!==navigator.mediaDevices&&void 0!==navigator.mediaDevices.getUserMedia&&null!==navigator.mediaDevices.getUserMedia},b.randomString=function(e){for(var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",n="",r=0;r<e;r++){var s=Math.floor(62*Math.random());n+=t.substring(s,s+1)}return n};const y={ERR_OK:{code:0,desc:"成功"},ERR_UNKNOWN:{code:100001,desc:"未知错误"},ERR_INIT_FAILED:{code:100002,desc:"初始化失败"},ERR_NOT_SUPPORT:{code:100003,desc:"调用不支持"},ERR_INVALID_ARGUMENT:{code:100004,desc:"参数非法"},ERR_REFUSED:{code:100005,desc:"调用被拒绝"},ERR_NOT_INIT:{code:100006,desc:"SDK尚未初始化"},ERR_TIMEOUT:{code:100007,desc:"调用超时"},ERR_REQUEST_PARAMETER:{code:100009,desc:"接口请求参数错误"},ERR_REQUEST_UNKNOWN:{code:100010,desc:"接口请求异常"},ERR_SDK_CONNECTED:{code:100011,desc:"SDK连接异常"},ERR_ROOM_ENTER_FAIL:{code:101001,desc:"进入房间失败"},ERR_ROOM_INVALID_TOKEN:{code:101006,desc:"无效token"},ERR_TOKEN_EXPIRED:{code:101011,desc:"token异常或过期"},ERR_ROOM_EXIT_FAIL:{code:101501,desc:"退出房间失败"},ERR_SERVICE_ACCESSTOKEN_INVALID:{code:210002,desc:"accessToken异常或过期"},ERR_DEVICE_NO_PERMISSION:{code:102001,desc:"设备未授权"},ERR_CAMERA_START_FAIL:{code:102002,desc:"摄像头驱动异常"},ERR_CAMERA_SET_PARAM_FAIL:{code:102004,desc:"摄像头参数设置出错（参数不支持或其它）"},ERR_NO_DEVICE:{code:102005,desc:"未查询到设备"},ERR_MICROPHONE_UNKNOWN:{code:102401,desc:"麦克风未知错误"},ERR_MICROPHONE_START_FAIL:{code:102404,desc:"麦克风驱动异常"},ERR_MICROPHONE_SET_PARAM_FAIL:{code:102405,desc:"麦克风参数错误"},ERR_SUBSCRIBE_FAIL:{code:102902,desc:"订阅音视频失败"},ERR_SIGNAL_SEND:{code:104001,desc:"信令发送报错"},ERR_SIGNAL_RECEIVE:{code:104002,desc:"信令接收报错"}},R=e=>A({key:{"-101":"ERR_SIGNAL_RECEIVE"}[e.code]||"ERR_SIGNAL_RECEIVE",msg:e.msg,data:e});function A(e){if("object"==typeof e){let t=e.msg||y[e.key].desc;return e.msg instanceof Error&&(t=t.message),{code:y[e.key].code,msg:t,data:e.data||null}}return{code:y[e].code,msg:y[e].desc,data:null}}function k(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:15e3,t={};return t.promise=new Promise((e,n)=>{t.resolve=e,t.reject=n}),e&&setTimeout(()=>{t.resolve(A({key:"ERR_TIMEOUT",msg:"timeout"}))},e),t}function w(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:5e3;return new Promise((t,n)=>{setTimeout(()=>{t("timeout")},e)})}Date.prototype.Format=function(e){var t={"M+":this.getMonth()+1,"d+":this.getDate(),"h+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),S:this.getMilliseconds()};for(var n in/(y+)/.test(e)&&(e=e.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length))),t)new RegExp("("+n+")").test(e)&&(e=e.replace(RegExp.$1,1==RegExp.$1.length?t[n]:("00"+t[n]).substr((""+t[n]).length)));return e};const P=function(e){for(var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",n="",r=0;r<e;r++){var s=Math.floor(62*Math.random());n+=t.substring(s,s+1)}return n},C=e=>new Promise((t,n)=>{var r;const s=e.url||"",o=(null===(r=e.method)||void 0===r?void 0:r.toUpperCase())||"GET",i=e.data||{},a=e.headerOptions||{};let c={"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"},d="";c=Object.assign(c,a);var l=new Headers;Object.keys(c).map(e=>{l.append(e,c[e])}),c=l,Object.keys(Object.assign({},i)).forEach(e=>{let t=i[e];"string"==typeof i[e]&&(t=i[e].replace("%","%25")),void 0!==i[e]&&(d+=`&${e}=${encodeURIComponent(t)}`)}),d.length>0&&(d=-1!==["GET","PUT","DELETE"].indexOf(o.toUpperCase())?`?${d.slice(1)}`:d.slice(1));let u=s+(-1!==["GET","PUT","DELETE"].indexOf(o.toUpperCase())?d:"");const h={headers:c,method:o};"POST"===o&&(h.body=d),"POST"===o&&a&&"application/json"===a["Content-Type"]&&(h.body=JSON.stringify(i)),"GET"===o&&(-1===u.indexOf("?")?u+=`?_r=${Math.random()}`:u+=`&_r=${Math.random()}`),h.credentials="same-origin",fetch(u,h).then(e=>e.json()).then(e=>{t(e)}).catch(e=>{n(e)})});var O="2.1.3-alpha.15";var D=new WeakMap;class N{constructor(e){a(this,D,[]),e.onChange&&(this.onChange=e.onChange)}init(){}addUser(e){if(i(D,this).find(t=>t.id===e.id))return!1;i(D,this).push(e),this.onChange&&this.onChange(i(D,this))}removeUser(e){c(D,this,i(D,this).filter(t=>t.id!==e.id)),this.onChange&&this.onChange(i(D,this))}updateUser(e,t){let n=!1;c(D,this,i(D,this).map(r=>r.id===e.id?(JSON.stringify(r)!==JSON.stringify(e)&&(n=!0),t?e:{...r,...e}):r)),n&&this.onChange&&this.onChange(i(D,this))}query(e){return i(D,this).find(t=>t.id===e.id)}getUsers(e){return n.cloneDeep(i(D,this))}empty(e){c(D,this,[]),this.onChange&&this.onChange(i(D,this))}}var M,V,L={websocketCheck(e,t){let{name:n,addInitializer:r}=t;return async function(){var t;if(null!==(t=this.janusInstance)&&void 0!==t&&t.isConnected()){for(var r=arguments.length,s=new Array(r),o=0;o<r;o++)s[o]=arguments[o];return await e.apply(this,s)}return Promise.reject(A({key:"ERR_NOT_INIT",msg:`check websocket connnect false. (connected=false), error function: ${n}`}))}}};let x,U,Y,j,$,H,F,q,Q,B,K,W,J;const G={uplink:{quality:0,reportedQuality:0,packageLost:null,jitter:null,rtt:null,lastReports:{},currentReports:{}},downlink:{quality:0,reportedQuality:0,packageLost:null,jitter:null,rtt:null,remotes:{}}};let z;new(Y=[L,L.websocketCheck],j=[L,L.websocketCheck],$=[L,L.websocketCheck],H=[L,L.websocketCheck],F=[L,L.websocketCheck],q=[L,L.websocketCheck],Q=[L,L.websocketCheck],B=[L,L.websocketCheck],K=[L,L.websocketCheck],J="extend",V=class{static[J](e){Array.isArray(e)&&e.forEach(e=>function(e){"object"==typeof e&&z.plugins.push(e)}(e))}constructor(e){var t,r;x(this),this.params=e,this.debug=(null==e?void 0:e.debug)||!1,this.exportLogs=null===(t=null==e?void 0:e.exportLogs)||void 0===t||t,this.autoPublish=null===(r=null==e?void 0:e.autoPublish)||void 0===r||r,this.domain=(null==e?void 0:e.domain)||null,this.janusInstance=null,this.usersInstance=null,this.config={opaqueId:"sts-"+b.randomString(12),wsServer:null,customId:null,strRoomId:null,appId:null,accessToken:null,roomId:null,clientId:null,timeout:null},this.plugins={},this.state={roomInfo:{id:"",roomId:"",isJoined:!1,me:{clientId:"",userId:"",astate:0,vstate:0,sstate:0,networkQuality:null,pluginHandle:null,streams:[]},amixer:{id:"amixer",pluginHandle:null,streams:[]},shareInfo:{},persons:[]},profile:{},networkQuality:n.cloneDeep(G),networkQualityRemotes:{},messagePluginHandle:null,publishAttaches:{},subscribeAttaches:{},publishAttachesQueue:[],subscribeAttachesQueue:[],videoSettingParams:{cameraId:null,frameRate:null,width:null,height:null,bitrate:null,simulcast:!1,simulcastMaxBitrates:null},audioSettingParams:{microphoneId:null}},this.registerPlugins(),this.bindConsoleProxy(),this.registerMethods(e),this.INNER_EVENT=z.INNER_EVENT,this.STREAM_TYPE=z.STREAM_TYPE,this.bindGlobalFuns()}registerPlugins(){z.plugins.forEach(e=>{e.exec({instance:this,classNative:z}),this.plugins[e.pluginName||`plugin_${Math.random()}`]=e})}bindConsoleProxy(){this.logger={},T.setGlobalConfig({supportExport:this.exportLogs});const e=T.proxy({name:"ERTC"});["log","debug","info","warn","error","trace"].forEach(t=>{this.logger[t]=()=>{},this.debug&&Object.defineProperty(this.logger,t,{get:()=>e[t],set(n){e[t]=n}})})}bindGlobalFuns(){window&&(window.ERTC_WEB={exportLogs:T.exportLogs})}registerMethods(e){this.iceTimeoutRestartWebsocket=n.debounce(e=>{var t,n;(this.logger.log("ice超时，重启websocket"),null!==(t=this.janusInstance)&&void 0!==t&&t.isConnected())&&(null==e||null===(n=e.close)||void 0===n||n.call(e))},(null==e?void 0:e.iceResetWsTime)||1e4)}settingMessageBody(e){return{requestId:b.randomString(12),customId:this.config.customId,roomId:this.config.roomId,...e}}async enterRoom(e){let t=null;return await this.initConfig(e),await this.connectWebsocket(),t=await this.attachRoom(),this.setVideoProfile(this.state.profile),this.setAudioProfile(this.state.profile),t}leaveRoom(e){const t=this;let n=k();return this.state.messagePluginHandle?(this.state.messagePluginHandle.messageListen(z.EVENT.EXITROOMACK,e=>{var t,r;this.logger.log("退出房间成功：",e),this.resettingConfig(),null===(t=this.janusInstance)||void 0===t||t.destroy(),this.janusInstance=null,null===(r=this.usersInstance)||void 0===r||r.empty(),n.resolve(A("ERR_OK"))}),this.state.messagePluginHandle.send({message:this.settingMessageBody({cmdType:"exitRoom"}),success:()=>{},error:e=>{t.logger.error("离开房间失败，原因：",e),n.reject(A({key:"ERR_ROOM_EXIT_FAIL",msg:e}))}}),this.state.roomInfo.isJoined=!1):n.resolve(A({key:"ERR_UNKNOWN",msg:"no handle"})),n.promise}initConfig(e){const t=this;this.logger.log("EzRtcCore 初始化入参：",e),this.resettingConfig();const n=k(),r={appId:e.appId,strRoomId:e.roomId,customId:e.userId};return C({url:`${this.domain||"https://open.ys7.com"}/api/v3/ertc/wss`,method:"POST",data:r,headerOptions:{accessToken:e.accessToken}}).then(function(s){var o;if(t.logger.log("wss接口请求成功：",s),200!==(null===(o=s.meta)||void 0===o?void 0:o.code)){var i;const e=A({key:{10002:"ERR_SERVICE_ACCESSTOKEN_INVALID",400:"ERR_REQUEST_PARAMETER"}[(a=null==s?void 0:s.meta).code]||"ERR_REQUEST_UNKNOWN",msg:a.message,data:a})||A({key:"ERR_INIT_FAILED",msg:(null==s||null===(i=s.meta)||void 0===i?void 0:i.message)||s.msg});return void n.reject(e)}{const{clientId:o,domain:i,roomId:a,wssPath:c}=s.data;Object.assign(t.config,{...r,wsServer:`wss://${i}/${c}`,accessToken:e.accessToken,roomId:a,clientId:o,timeout:e.timeout||300}),t.usersInstance=new N({onChange:e=>{t.trigger(z.EVENT.USERS_CHANGE,e)}}),n.resolve(A({key:"ERR_OK",data:s.data}))}var a}).catch(function(e){n.reject(A({key:"ERR_INIT_FAILED",msg:e}))}),n.promise}async connectWebsocket(){var e;let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;const n=k(),r=this,{accessToken:s,customId:o,strRoomId:i,appId:a}=this.config,c=(new Date).getTime();let d=!1,l=!1,u=t,h={token:`token=${s}&customId=${o}&strRoomId=${i}&appId=${a}`,authtype:23,sdk_version:z.VERSION};return null===(e=this.janusInstance)||void 0===e||e.destroy(),this.janusInstance=null,this.resettingAttaches("subscribe"),b.init({debug:!!this.debug&&["log","warn","error"],callback:()=>{r.janusInstance=new b({server:r.params.wsServer||r.config.wsServer,success:function(e){d=!0,e&&(u>0&&(r.trigger(z.EVENT.CONNECT_STATE_CHANGE,A({key:"ERR_OK",msg:"reconnect success"})),setTimeout(()=>{r.attachRoom("reconnect")},3e3),u=0),r.trigger(z.EVENT.CONNECT_STATE_CHANGE,A({key:"ERR_OK",msg:"success"})),r.attachScreenBySafari(),n.resolve(A({key:"ERR_OK",data:e})))},error:async function(e){if(r.logger.log("监听websocket连接error：",e),"rcstoken check failed"===e)return u>0&&r.trigger(z.EVENT.CONNECT_STATE_CHANGE,A({key:"ERR_SDK_CONNECTED",msg:"fail"})),void n.reject(A({key:"ERR_ROOM_INVALID_TOKEN",msg:e}));if(r.state.roomInfo.isJoined&&(d||u>0)&&("Lost connection to the server"==e||"Error connecting to the Janus WebSockets server: Is the server down?"==e)){if(l)return;var t;if(l=!0,u>=30)return r.logger.log(`重连超过${u}次退出重连机制`),r.resettingConfig(),r.janusInstance&&r.janusInstance.destroy(),r.janusInstance=null,null===(t=r.usersInstance)||void 0===t||t.empty(),void r.trigger(z.EVENT.CONNECT_STATE_CHANGE,A({key:"ERR_SDK_CONNECTED",msg:"fail"}));(new Date).getTime()-c<5e3&&await w(3e3),0===u&&r.trigger(z.EVENT.CONNECT_STATE_CHANGE,A({key:"ERR_SDK_CONNECTED",msg:"reconnecting"})),r.logger.log(`正在开始第${u+1}次重连`),r.connectWebsocket(u+1)}else n.reject(A({key:"ERR_INIT_FAILED",msg:e}))},destroyed:function(){r.logger.log("监听janus被销毁"),r.state.networkQualityRemotes={},r.trigger(z.EVENT.CONNECT_STATE_CHANGE,A({key:"ERR_SDK_CONNECTED",msg:"destroyed"})),n.reject(A({key:"ERR_UNKNOWN",msg:"Janus destroyed"}))}},h)}}),n.promise}attachRoom(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"enterRoom";const t=this,{timeout:n}=this.config;let r=k(),s=null;return this.janusInstance.attach({plugin:"rtcgw.plugin.sts",opaqueId:this.config.opaqueId,success:function(o){var i;t.logger.log("attachRoom attach success回调，返回类型：",e,"返回句柄pluginHandle：",o),s=o;const a=t.settingMessageBody({cmdType:e,clientId:t.config.clientId,strroomId:t.config.strRoomId,authtype:23,authentication:t.config.accessToken,appId:t.config.appId});n&&(a.timeout=n),s.send({message:a,error:e=>r.reject(A({key:"ERR_ROOM_ENTER_FAIL",msg:e}))}),null===(i=t.usersInstance)||void 0===i||i.empty(),s.messageListen(z.EVENT.ENTERROOMACK,n=>{0===n.code?(t.state.messagePluginHandle=s,t.state.roomInfo.isJoined=!0,t.usersInstance.addUser({id:t.config.customId,clientId:t.config.clientId}),"reconnect"===e&&setTimeout(()=>{t.reconnectRoomEffect()},500),r.resolve(A({key:"ERR_OK",data:o.id}))):(t.logger.log("加入房间失败：",n.msg),r.reject(A({key:"ERR_ROOM_ENTER_FAIL",msg:n.msg||"加入房间失败"})))}),s.messageListen(z.EVENT.ERROR,e=>{t.logger.log("加入房间失败，监听到通用错误：",e),r.reject(A({key:"ERR_ROOM_ENTER_FAIL",msg:e.msg||"加入房间失败"}))})},error:function(e){t.logger.error("attachRoom attach error回调：",e),r.reject(A({key:"ERR_ROOM_ENTER_FAIL",msg:e}))},consentDialog:function(e){t.logger.debug("attachRoom consentDialog回调：",e)},iceState:function(e){switch(t.logger.debug("attachRoom iceState回调："+e),e){case"connected":t.logger.log("attachRoom ice 连接成功");break;case"disconnected":t.logger.log("attachRoom ice 连接断开")}},mediaState:function(e,n){t.logger.log("attachRoom mediaState回调，Janus "+(n?"started":"stopped")+" receiving our "+e)},webrtcState:function(e){t.logger.log("attachRoom webrtcState回调，Janus says our WebRTC PeerConnection is "+(e?"up":"down")+" now")},slowLink:function(e,n){t.logger.warn("attachRoom slowLink回调，Janus reports problems "+(e?"sending":"receiving")+" packets on this PeerConnection ("+n+" lost packets)")},onmessage:function(e,n){![z.EVENT.AUDIOLEVEL,"networkquality"].includes(e.rtcgw)&&t.logger.log("attachRoom onMessage回调，返回msg:",e,"返回jsep:",n),null!=n&&(t.logger.debug("Handling SDP as well..."),s.handleRemoteJsep({jsep:n}));var r=e.result;if(null!=r){var o;if("done"===r)return t.resettingConfig(),t.janusInstance.destroy(),t.janusInstance=null,void(null===(o=t.usersInstance)||void 0===o||o.empty());r.status}if(s.messageTrigger(e.rtcgw,e),e.error&&t.trigger(z.EVENT.ERROR,A({key:"ERR_UNKNOWN",data:e,msg:null==e?void 0:e.msg})),e.rtcgw===z.EVENT.ERROR){var i;if(21===e.code)t.resettingConfig(),t.janusInstance.destroy(),t.janusInstance=null,null===(i=t.usersInstance)||void 0===i||i.empty();8===e.code&&setTimeout(()=>{t.connectWebsocket(1)},500)}if(e.rtcgw===z.EVENT.CLIENTJOIN&&t.usersInstance.addUser({id:e.customId,clientId:e.clientId,networkQuality:t.state.networkQualityRemotes[e.customId]||null}),e.rtcgw===z.EVENT.CLIENTLEAVE&&(t.usersInstance.removeUser({id:e.customId}),t.destroySubscribeAttach(e.customId)),e.rtcgw===z.EVENT.STREAM_ADDED&&(e.streamtype===z.STREAM_TYPE.VIDEO_ONLY&&t.usersInstance.updateUser({id:e.customId,vstate:1}),e.streamtype===z.STREAM_TYPE.AUDIO_ONLY&&t.usersInstance.updateUser({id:e.customId,astate:1}),e.streamtype===z.STREAM_TYPE.SCREEN&&t.usersInstance.updateUser({id:e.customId,sstate:1})),e.rtcgw===z.EVENT.STREAM_REMOVED&&(e.streamtype===z.STREAM_TYPE.VIDEO_ONLY&&t.usersInstance.updateUser({id:e.customId,vstate:0}),e.streamtype===z.STREAM_TYPE.AUDIO_ONLY&&t.usersInstance.updateUser({id:e.customId,astate:0}),e.streamtype===z.STREAM_TYPE.SCREEN&&t.usersInstance.updateUser({id:e.customId,sstate:0})),e.rtcgw===z.EVENT.CLIENT_PERMISSION){const n=t.usersInstance.query({id:e.customId});(null==n?void 0:n.videoPermission)!==e.videoPermission&&2===e.videoPermission&&1===n.vstate&&t.unpublishStream({type:z.STREAM_TYPE.VIDEO_ONLY}),(null==n?void 0:n.audioPermission)!==e.audioPermission&&2===e.audioPermission&&1===n.astate&&t.unpublishStream({type:z.STREAM_TYPE.AUDIO_ONLY}),(null==n?void 0:n.sharePermission)!==e.sharePermission&&2===e.sharePermission&&1===n.sstate&&t.unpublishStream({type:z.STREAM_TYPE.SCREEN}),t.usersInstance.updateUser({id:e.customId,audioPermission:e.audioPermission,videoPermission:e.videoPermission,sharePermission:e.sharePermission})}if(e.rtcgw===z.EVENT.SUB_PERMISSION&&(1===e.audioPermission&&t.unsubscribe({userId:e.customId,type:z.STREAM_TYPE.AUDIO_ONLY}),1===e.videoPermission&&t.unsubscribe({userId:e.customId,type:z.STREAM_TYPE.VIDEO_ONLY}),1===e.sharePermission&&t.unsubscribe({userId:e.customId,type:z.STREAM_TYPE.SCREEN})),e.rtcgw===z.EVENT.NETWORKQUALITY&&(t.state.networkQualityRemotes[e.customId]={upquality:e.upquality,downquality:e.downquality},Object.entries(t.state.networkQualityRemotes).forEach(e=>{let[n,r]=e;t.usersInstance.query({id:n})&&t.usersInstance.updateUser({id:n,networkQuality:r})})),e.rtcgw){let n=e;"error"===e.rtcgw&&(n=R(e)),t.trigger(e.rtcgw,n)}},onlocalstream:function(e){t.logger.log("attachRoom onlocalstream回调：",e)},onremotestream:function(e){t.logger.log("attachRoom onremotestream回调：",e)},ondataopen:function(e){t.logger.log("attachRoom ondataopen回调：",e)},ondata:function(e){t.logger.log("attachRoom ondata回调：",e)},oncleanup:function(){t.logger.log("attachRoom oncleanup回调"),t.trigger(z.EVENT.CONNECT_STATE_CHANGE,{code:205,msg:"disconnected"})}}),r.promise}reconnectRoomEffect(){const{publishAttaches:e,subscribeAttaches:t,roomInfo:n}=this.state,r=this;var s;(this.resettingNetworkQuality(),this.autoPublish&&(this.logger.log("重连房间后，重新发布：",e),e&&Object.entries(e).forEach(async e=>{let[t,n]=e;try{if(null!=n&&n.pluginHandle&&null!=n&&n.createOfferParams){const{media:e,simulcast:r}=n.createOfferParams;if(e.video){const e=n.videoParams||{};e.isSingleConnect&&e.stream?await this.publishStream({...e,refrush:!0}):await this.publishStream({type:t===z.ATTACHES_TYPE[z.STREAM_TYPE.SCREEN]?z.STREAM_TYPE.SCREEN:z.STREAM_TYPE.VIDEO_ONLY,simulcast:r,refrush:!0})}if(e.audio){const t=n.audioParams||{};var s,o;if(t.isSingleConnect&&t.stream)null===(s=n.pluginHandleAudio)||void 0===s||null===(o=s.detach)||void 0===o||o.call(s),n.pluginHandleAudio=null,await this.publishStream({...t,refrush:!e.video});else await this.publishStream({type:z.STREAM_TYPE.AUDIO_ONLY,refrush:!e.video})}}}catch(e){r.logger.error("重连房间后，重新发布失败：",e),"string"==typeof e&&e.indexOf("getUserMedia timeout")>-1&&r.trigger(z.EVENT.ERROR,A({key:"ERR_CAMERA_START_FAIL",msg:e}))}})),n.amixer.pluginHandle)&&(this.logger.log("混音流原句柄还存在，先进行detach后再订阅"),n.amixer.pluginHandle.detach(),this.subscribeMix({view:null===(s=n.amixer.streams)||void 0===s||null===(s=s[0])||void 0===s?void 0:s.view}))}async publishStream(e){var t,r,s,o,i,a;this.logger.log("发布本地音视频，入参：",JSON.stringify(e));const c=this,d=k(e.type===z.STREAM_TYPE.SCREEN?null:15e3),{type:l,view:u,simulcast:h,refrush:m,attachOnly:g=!1,stream:v,isSingleConnect:p}=e,{videoSettingParams:f,audioSettingParams:_,publishAttaches:S}=this.state,T=null!=h?h:this.state.videoSettingParams.simulcast,I=this.usersInstance.query({id:this.config.customId});if([z.STREAM_TYPE.VIDEO_ONLY,z.STREAM_TYPE.VIDEO_SIMULCAST_LITTLE,z.STREAM_TYPE.VIDEO_SIMULCAST_LARGE,z.STREAM_TYPE.AUDIO_AND_VIDEO].includes(l)&&2===(null==I?void 0:I.videoPermission))return Promise.reject(A({key:"ERR_REFUSED",msg:"no video publish permission"}));if([z.STREAM_TYPE.AUDIO_ONLY,z.STREAM_TYPE.AUDIO_AND_VIDEO].includes(l)&&2===(null==I?void 0:I.audioPermission))return Promise.reject(A({key:"ERR_REFUSED",msg:"no audio publish permission"}));if(l===z.STREAM_TYPE.SCREEN&&2===(null==I?void 0:I.sharePermission))return Promise.reject(A({key:"ERR_REFUSED",msg:"no share publish permission"}));if(["safari","firefox"].includes(null===(t=b.webRTCAdapter)||void 0===t||null===(t=t.browserDetails)||void 0===t?void 0:t.browser)&&l===z.STREAM_TYPE.VIDEO_ONLY&&T)return Promise.reject(A({key:"ERR_NOT_SUPPORT",msg:"firefox/safari not support simulcast"}));await this.publishAttachesQueueAwait(d);const E=S[z.ATTACHES_TYPE[l]],y={[z.STREAM_TYPE.VIDEO_ONLY]:"pluginHandle",[z.STREAM_TYPE.AUDIO_ONLY]:"pluginHandleAudio",[z.STREAM_TYPE.SCREEN]:"pluginHandle"},w={[z.STREAM_TYPE.VIDEO_ONLY]:"mediaStream",[z.STREAM_TYPE.AUDIO_ONLY]:"mediaStreamAudio",[z.STREAM_TYPE.SCREEN]:"mediaStream"},P={[z.STREAM_TYPE.VIDEO_ONLY]:"videoParams",[z.STREAM_TYPE.AUDIO_ONLY]:"audioParams",[z.STREAM_TYPE.SCREEN]:"videoParams"};let C=null==E?void 0:E[p?y[l]:"pluginHandle"],O={};const D=this.settingMessageBody({cmdType:"publishlocalstream",streamtype:l});let N={videoSend:!m&&!(null==E||null===(r=E.createOfferParams)||void 0===r||null===(r=r.media)||void 0===r||!r.video),videoRecv:!1,audioSend:!m&&!(null==E||null===(s=E.createOfferParams)||void 0===s||null===(s=s.media)||void 0===s||!s.audio),audioRecv:!1,data:!1,video:!m&&((null==E||null===(o=E.createOfferParams)||void 0===o||null===(o=o.media)||void 0===o?void 0:o.video)||!1),audio:!m&&((null==E||null===(i=E.createOfferParams)||void 0===i||null===(i=i.media)||void 0===i?void 0:i.audio)||!1)};switch(l){case z.STREAM_TYPE.VIDEO_ONLY:let t={};f.cameraId&&(t.deviceId=f.cameraId),f.width&&(t.width={ideal:f.width}),f.height&&(t.height={ideal:f.height}),0===Object.keys(t).length&&(t=!0),N={...N,videoSend:!0,videoRecv:!1,video:t},D.streamtype=T?z.STREAM_TYPE.VIDEO_SIMULCAST_LARGE:z.STREAM_TYPE.VIDEO_ONLY;break;case z.STREAM_TYPE.AUDIO_ONLY:N={...N,audioSend:!0,audioRecv:!1,audio:{deviceId:_.microphoneId,echoCancellation:!0}};break;case z.STREAM_TYPE.SCREEN:N={...N,audioRecv:!1,audioSend:!1,audio:!1,videoSend:!0,videoRecv:!1,video:"screen",screenshareFrameRate:3},O={frameRate:15,simulcastMaxBitrates:2e6,bitrate:2e6},e.displaySurface&&(O.displaySurface=e.displaySurface)}const M={media:N,...O,simulcast:T||(null==E||null===(a=E.createOfferParams)||void 0===a?void 0:a.simulcast)||!1};if(f.simulcastMaxBitrates&&(M.simulcastMaxBitrates=f.simulcastMaxBitrates),f.frameRate&&(M.frameRate=f.frameRate),f.bitrate&&(M.bitrate=f.bitrate),this.logger.log("发布音视频 createOfferParams：",M),m&&C&&(C.detach(),this.state.publishAttaches[z.ATTACHES_TYPE[l]]=null),g)return await V(),d.resolve(A("ERR_OK")),!0;if(C&&!m){if(l===z.STREAM_TYPE.SCREEN&&null!=E&&E.createOfferParams)return d.reject(A({key:"ERR_NOT_SUPPORT",msg:"repeat publish screen stream"})),d.promise;L()}else V().then(L).catch(e=>{c.logger.error("发布本地音视频失败：",e),d.reject(A({key:"ERR_UNKNOWN",msg:e}))});function V(){return new Promise((t,n)=>{c.janusInstance.attach({plugin:"rtcgw.plugin.sts",opaqueId:c.config.opaqueId,success:function(e){c.logger.log("publishStream attach success回调，返回发布流句柄：",e),C=e,p?c.state.publishAttaches[z.ATTACHES_TYPE[l]]?c.state.publishAttaches[z.ATTACHES_TYPE[l]][y[l]]=C:c.state.publishAttaches[z.ATTACHES_TYPE[l]]={[y[l]]:C}:c.state.publishAttaches[z.ATTACHES_TYPE[l]]={pluginHandle:C},t(e)},error:function(e){c.logger.error("publishStream attach error回调：",e),d.reject(A({key:"ERR_UNKNOWN",msg:e}))},consentDialog:function(e){c.logger.debug("publishStream consentDialog回调：",e)},iceState:function(e,t){switch(c.logger.log("publishStream iceState回调：",e),e){case"connected":c.iceTimeoutRestartWebsocket.cancel();break;case"disconnected":c.iceTimeoutRestartWebsocket(t)}},mediaState:function(e,t){c.logger.log("publishStream mediaState回调，Janus "+(t?"started":"stopped")+" receiving our "+e)},webrtcState:function(e){c.logger.log("publishStream webrtcState回调，Janus says our WebRTC PeerConnection is "+(e?"up":"down")+" now"),e&&c.pollingNetworkQuality()},slowLink:function(e,t){c.logger.warn("publishStream slowLink回调，Janus reports problems "+(e?"sending":"receiving")+" packets on this PeerConnection ("+t+" lost packets)")},onmessage:function(e,t){if(c.logger.log("publishStream onMessage回调，返回msg:",e,"返回jsep:",t),null!=t&&(c.logger.debug("Handling SDP as well..."),C.handleRemoteJsep({jsep:t})),e.rtcgw){C.messageTrigger(e.rtcgw,e);let t=e;"error"===e.rtcgw&&(t=R(e)),c.trigger(e.rtcgw,t)}},onlocalstream:function(t){var n;(c.logger.log("publishStream onlocalstream回调：",t,"steamTracks：",null==t?void 0:t.getTracks()),null!=t&&t.active)&&(p?c.state.publishAttaches[z.ATTACHES_TYPE[l]][w[l]]=v:c.state.publishAttaches[z.ATTACHES_TYPE[l]].mediaStream=t,c.trigger(z.EVENT.LOCAL_STREAM_AVAILABLE,{stream:new MediaStream(t),streamtype:l}),l===z.STREAM_TYPE.SCREEN&&(null==t||null===(n=t.getVideoTracks())||void 0===n||null===(n=n[0])||void 0===n||n.addEventListener("ended",()=>{c.logger.log("停止了屏幕共享-----------------------");let t=c.settingMessageBody({cmdType:"unpublishlocalstream",streamtype:8});C&&C.send({message:t,success:()=>{c.state.publishAttaches[z.ATTACHES_TYPE[z.STREAM_TYPE.SCREEN]].pluginHandle.messageListen(z.EVENT.UNPUBLISHLOCALSTREAMACK,t=>{0===t.code&&([z.STREAM_TYPE.SCREEN].includes(e.type)&&c.state.publishAttaches[z.ATTACHES_TYPE[z.STREAM_TYPE.SCREEN]].pluginHandle.detach({success:()=>c.state.publishAttaches[z.ATTACHES_TYPE[z.STREAM_TYPE.SCREEN]]=null}),c.attachScreenBySafari())})},error:e=>{}})})))},onremotestream:function(e){c.logger.log("publishStream onremotestream回调：",e)},ondataopen:function(e){c.logger.log("publishStream ondataopen回调：",e)},ondata:function(e){c.logger.log("publishStream ondata回调：",e)},oncleanup:function(){c.logger.log("publishStream oncleanup回调")},ondetached:function(){c.logger.log("publishStream ondetached回调")}})})}function L(){C.createOffer({...n.cloneDeep(M),stream:v,customizeSdp:e=>{c.logger.log("jsep",e);const t=l===z.STREAM_TYPE.VIDEO_ONLY&&p,n=l===z.STREAM_TYPE.AUDIO_ONLY&&p;if("offer"===(null==e?void 0:e.type)&&(N.audio&&!N.video||n)){c.logger.log("纯音频流，自定义修改sdp，添加额外extmap");let t=e.sdp;const n=t.split("\r\n");if(!n.find(e=>e.indexOf("a=extmap:10")>-1)){let e=n.findLastIndex(e=>e.indexOf("a=extmap:")>-1);e=e>-1?e:n.findIndex(e=>e.indexOf("a=mid:")>-1),e>-1&&n.splice(e+1,0,"a=extmap:10 urn:ietf:params:rtp-hdrext:sdes:rtp-stream-id")}if(!n.find(e=>e.indexOf("a=extmap:11")>-1)){let e=n.findLastIndex(e=>e.indexOf("a=extmap:")>-1);n.splice(e+1,0,"a=extmap:11 urn:ietf:params:rtp-hdrext:sdes:repaired-rtp-stream-id")}t=n.join("\r\n"),t.endsWith("\r\n")||(t+="\r\n"),e.sdp=t}if("offer"===(null==e?void 0:e.type)&&N.audio&&!t){let t=e.sdp,n=t.split("\r\n"),r=n.indexOf(n.find(e=>e.startsWith("m=audio"))),s=n.indexOf(n.slice(r+1).find(e=>e.startsWith("m=")))||n.length,o=n.slice(r,s),i=`a=rtcp-fb:${o.find(e=>e.startsWith("a=rtpmap")).split(" ")[0].split(":")[1]} nack`;o.some(e=>e.includes("nack"))||(o.push(i),n=[...n.slice(0,r),...o,...n.slice(s)],t=n.join("\r\n")),t.endsWith("\r\n")||(t+="\r\n"),e.sdp=t}},customizeAudioTrack:e=>new Promise((t,n)=>{var r;const s=new MediaStream,o=e.getAudioTracks()[0];o&&"on"===(null===(r=c.plugins.VoiceChange)||void 0===r?void 0:r.pluginStatus)?(s.addTrack(o),c.plugins.VoiceChange.recStart(s).then(e=>{t(e)}).catch(n=>{c.logger.error("publishStream customizeAudioTrack error：",n),t(e)})):t(e)}),success:function(t){c.logger.log("publishStream createOffer success回调，返回jsep：",t),C.send({message:D,jsep:t,error:e=>d.reject(A({key:"ERR_SIGNAL_SEND",msg:e}))});const n=t=>{if(0===t.code)c.state.publishAttaches[z.ATTACHES_TYPE[l]].createOfferParams=M,c.state.publishAttaches[z.ATTACHES_TYPE[l]][P[l]]=e,c.state.publishAttaches[z.ATTACHES_TYPE[l]].videostreamtype=l===z.STREAM_TYPE.AUDIO_ONLY?(null==E?void 0:E.videostreamtype)||null:l,[z.STREAM_TYPE.VIDEO_ONLY,z.STREAM_TYPE.VIDEO_SIMULCAST_LITTLE,z.STREAM_TYPE.VIDEO_SIMULCAST_LARGE].includes(e.type)&&c.usersInstance.updateUser({id:c.config.customId,vstate:1}),[z.STREAM_TYPE.AUDIO_ONLY].includes(e.type)&&c.usersInstance.updateUser({id:c.config.customId,astate:1}),[z.STREAM_TYPE.SCREEN].includes(e.type)&&c.usersInstance.updateUser({id:c.config.customId,sstate:1}),d.resolve(A("ERR_OK"));else{x();const e=R(t);d.reject(e)}};l===z.STREAM_TYPE.SCREEN?c.state.messagePluginHandle.messageListen(z.EVENT.PUBLISHSCREENSTREAMACK,n):C.messageListen(z.EVENT.PUBLISHLOCALSTREAMACK,n),C.messageListen(z.EVENT.ERROR,e=>{c.logger.log("发布失败：",null==e?void 0:e.msg),x();const t=R(e);d.reject(t)})},error:function(e){c.logger.error("publishStream createOffer error回调：",e),x();let t=((e,t)=>{const n={NotAllowedError:{video:"ERR_DEVICE_NO_PERMISSION",audio:"ERR_DEVICE_NO_PERMISSION",screen:"ERR_DEVICE_NO_PERMISSION"},NotFoundError:{video:"ERR_CAMERA_START_FAIL",audio:"ERR_MICROPHONE_START_FAIL",screen:"ERR_DEVICE_NO_PERMISSION"},NotReadableError:{video:"ERR_CAMERA_START_FAIL",audio:"ERR_MICROPHONE_START_FAIL",screen:"ERR_DEVICE_NO_PERMISSION"},OverconstrainedError:{video:"ERR_CAMERA_SET_PARAM_FAIL",audio:"ERR_MICROPHONE_SET_PARAM_FAIL",screen:"ERR_UNKNOWN"},AbortError:{video:"ERR_CAMERA_START_FAIL",audio:"ERR_MICROPHONE_UNKNOWN",screen:"ERR_UNKNOWN"},SecurityError:{video:"ERR_CAMERA_START_FAIL",audio:"ERR_MICROPHONE_START_FAIL",screen:"ERR_UNKNOWN"}};return n[null==e?void 0:e.name]?A({key:n[e.name][t],msg:e.message}):null})(e,{[z.STREAM_TYPE.VIDEO_ONLY]:"video",[z.STREAM_TYPE.AUDIO_ONLY]:"audio",[z.STREAM_TYPE.SCREEN]:"screen",[z.STREAM_TYPE.VIDEO_SIMULCAST_LITTLE]:"video",[z.STREAM_TYPE.VIDEO_SIMULCAST_LARGE]:"video"}[l])||A({key:"ERR_UNKNOWN",msg:e});"string"==typeof e&&e.toLocaleLowerCase().indexOf("no capture device found")>-1&&(t=A({key:"ERR_NO_DEVICE",msg:e})),d.reject(t)}})}function x(){var t;if(l!==z.STREAM_TYPE.SCREEN){var n;const{video:e,audio:t}=(null===(n=c.state.publishAttaches[z.ATTACHES_TYPE[l]])||void 0===n||null===(n=n.createOfferParams)||void 0===n?void 0:n.media)||{};if(!!e+!!t>=1)return}null===(t=C)||void 0===t||t.detach(),c.state.publishAttaches[z.ATTACHES_TYPE[l]]=null,e.type===z.STREAM_TYPE.SCREEN&&c.attachScreenBySafari()}return d.promise}async unpublishStream(e){this.logger.log("取消发布本地音视频，入参：",JSON.stringify(e));const t=this,r=k(),s=this.state.publishAttaches[z.ATTACHES_TYPE[e.type]],o={[z.STREAM_TYPE.VIDEO_ONLY]:"pluginHandle",[z.STREAM_TYPE.AUDIO_ONLY]:"pluginHandleAudio",[z.STREAM_TYPE.SCREEN]:"pluginHandle"};let i=null==s?void 0:s[e.isSingleConnect?o[e.type]:"pluginHandle"];const a=this.settingMessageBody({cmdType:"unpublishlocalstream",streamtype:e.type==z.STREAM_TYPE.VIDEO_ONLY?1==this.state.videoSettingParams.simulcast?z.STREAM_TYPE.VIDEO_SIMULCAST_LARGE:z.STREAM_TYPE.VIDEO_ONLY:e.type});var c;(await this.publishAttachesQueueAwait(r),i)?i.createOffer({media:e.isSingleConnect?{audio:!1,audioSend:!1,audioRecv:!1,addAudio:!1,replaceAudio:!1,video:!1,videoSend:!1,videoRecv:!1,addVideo:!1,replaceVideo:!1,[e.type===z.STREAM_TYPE.AUDIO_ONLY?"removeAudio":"removeVideo"]:!0}:n.cloneDeep({...null===(c=s.createOfferParams)||void 0===c?void 0:c.media,replaceAudio:!1,replaceVideo:!1,addVideo:!1,addAudio:!1,[e.type===z.STREAM_TYPE.AUDIO_ONLY?"removeAudio":"removeVideo"]:!0}),success:n=>{i.send({message:a,error:e=>{r.reject(A({key:"ERR_SIGNAL_SEND",msg:e}))}}),i.messageListen(z.EVENT.UNPUBLISHLOCALSTREAMACK,n=>{if(0===n.code){if(e.type!==z.STREAM_TYPE.SCREEN){var a;if([z.STREAM_TYPE.VIDEO_ONLY,z.STREAM_TYPE.VIDEO_SIMULCAST_LITTLE,z.STREAM_TYPE.VIDEO_SIMULCAST_LARGE].includes(e.type)&&(s.createOfferParams.media.video=!1,t.usersInstance.updateUser({id:t.config.customId,vstate:0})),[z.STREAM_TYPE.AUDIO_ONLY].includes(e.type))s.createOfferParams.media.audio=!1,t.usersInstance.updateUser({id:t.config.customId,astate:0}),null===(a=this.plugins.VoiceChange)||void 0===a||a.recStop();const{video:n,audio:r}=s.createOfferParams.media;!!n+!!r==0&&i.detach({success:()=>this.state.publishAttaches[z.ATTACHES_TYPE[e.type]]=null}),e.isSingleConnect&&i.detach({success:()=>{var t;null!==(t=this.state.publishAttaches)&&void 0!==t&&null!==(t=t[z.ATTACHES_TYPE[e.type]])&&void 0!==t&&t[o[e.type]]&&(this.state.publishAttaches[z.ATTACHES_TYPE[e.type]][o[e.type]]=null)}})}[z.STREAM_TYPE.SCREEN].includes(e.type)&&(i.detach({success:()=>this.state.publishAttaches[z.ATTACHES_TYPE[e.type]]=null}),t.attachScreenBySafari(),t.usersInstance.updateUser({id:t.config.customId,sstate:0})),r.resolve(A("ERR_OK"))}else{const e=R(n);r.reject(e)}})},error:function(e){t.logger.error("取消发布流失败：",e),r.reject(A({key:"ERR_UNKNOWN",msg:e}))}}):setTimeout(r.reject(A({key:"ERR_UNKNOWN",msg:"no handle"})),0);return r.promise}async subscribeStream(e){var t,r,s,o,i;this.logger.log("订阅音视频，入参：",JSON.stringify(e));const a=this;let c=k();await this.subscribeAttachesQueueAwait(c);const d=null===(t=this.state.subscribeAttaches)||void 0===t||null===(t=t[e.userId])||void 0===t?void 0:t[z.ATTACHES_TYPE[e.type]];let l=(null==d?void 0:d.pluginHandle)||null;const u=this.settingMessageBody({cmdType:"subremote",streamtype:e.type,customId:e.userId});let h={videoSend:!1,videoRecv:!(null==d||null===(r=d.createOfferParams)||void 0===r||null===(r=r.media)||void 0===r||!r.video),audioSend:!1,audioRecv:!(null==d||null===(s=d.createOfferParams)||void 0===s||null===(s=s.media)||void 0===s||!s.audio),data:!1,video:(null==d||null===(o=d.createOfferParams)||void 0===o||null===(o=o.media)||void 0===o?void 0:o.video)||!1,audio:(null==d||null===(i=d.createOfferParams)||void 0===i||null===(i=i.media)||void 0===i?void 0:i.audio)||!1};switch(e.type){case z.STREAM_TYPE.VIDEO_ONLY,z.STREAM_TYPE.VIDEO_SIMULCAST_LARGE,z.STREAM_TYPE.VIDEO_SIMULCAST_LITTLE:h={...h,videoRecv:!0,video:!0};break;case z.STREAM_TYPE.AUDIO_ONLY:h={...h,audioRecv:!0,audio:!0};break;case z.STREAM_TYPE.SCREEN:h={...h,audioRecv:!1,audio:!1,videoRecv:!0,video:!0};break;default:h={...h,videoRecv:!0,video:!0}}const m={media:h,simulcast:!1};function g(){l.createOffer({...n.cloneDeep(m),success:function(t){a.logger.log("subscribeStream createOffer success回调，返回jsep：",t),l.send({message:u,jsep:t,error:e=>c.reject(A({key:"ERR_SIGNAL_SEND",msg:e}))}),l.messageListen(z.EVENT.SUBREMOTEACK,t=>{if(a.state.subscribeAttaches[e.userId][z.ATTACHES_TYPE[e.type]].createOfferParams=m,a.state.subscribeAttaches[e.userId][z.ATTACHES_TYPE[e.type]].videostreamtype=e.type===z.STREAM_TYPE.AUDIO_ONLY?(null==d?void 0:d.videostreamtype)||null:e.type,0===(null==t?void 0:t.code))c.resolve(A("ERR_OK"));else{a.unsubscribe({userId:e.userId,type:e.type});const n=R(t);c.reject(n)}}),l.messageListen(z.EVENT.ERROR,t=>{a.logger.log("订阅失败：",null==t?void 0:t.msg),v(),a.state.subscribeAttaches[e.userId][z.ATTACHES_TYPE[e.type]]=null;const n=R(t);c.reject(n)})},error:function(e){a.logger.error("subscribeStream createOffer error回调:",e),v(),c.reject(A({key:"ERR_SUBSCRIBE_FAIL",msg:e}))}})}function v(){var t;if(e.type!==z.STREAM_TYPE.SCREEN){var n;const{video:t,audio:r}=(null===(n=a.state.subscribeAttaches[e.userId])||void 0===n||null===(n=n[z.ATTACHES_TYPE[e.type]])||void 0===n||null===(n=n.createOfferParams)||void 0===n?void 0:n.media)||{};if(!!t+!!r>=1)return}null===(t=l)||void 0===t||t.detach(),a.state.subscribeAttaches[e.userId]&&(a.state.subscribeAttaches[e.userId][z.ATTACHES_TYPE[e.type]]=null)}return l&&e.refrush&&(l.detach(),this.state.subscribeAttaches[e.userId][z.ATTACHES_TYPE[e.type]]=null),this.logger.log("订阅音视频 createOfferParams：",m),!l||e.refrush?this.janusInstance.attach({plugin:"rtcgw.plugin.sts",opaqueId:this.config.opaqueId,success:t=>{var n;a.logger.log("subscribeStream attach success回调，返回订阅流句柄：",t),l=t,null!==(n=a.state.subscribeAttaches)&&void 0!==n&&n[e.userId]?a.state.subscribeAttaches[e.userId][z.ATTACHES_TYPE[e.type]]={pluginHandle:l}:a.state.subscribeAttaches[e.userId]={[z.ATTACHES_TYPE[e.type]]:{pluginHandle:l}},g()},error:function(e){a.logger.error("subscribeStream attach error回调：",e),c.reject(A({key:"ERR_SUBSCRIBE_FAIL",msg:e}))},consentDialog:function(e){a.logger.debug("subscribeStream consentDialog回调：",e)},iceState:function(e,t){switch(a.logger.log("subscribeStream iceState回调：",e),e){case"connected":a.iceTimeoutRestartWebsocket.cancel();break;case"disconnected":a.iceTimeoutRestartWebsocket(t)}},mediaState:function(e,t){a.logger.log("subscribeStream mediaState回调，Janus "+(t?"started":"stopped")+" receiving our "+e)},webrtcState:function(e){a.logger.log("subscribeStream webrtcState回调，Janus says our WebRTC PeerConnection is "+(e?"up":"down")+" now"),e&&a.pollingNetworkQuality()},slowLink:function(e,t){a.logger.warn("subscribeStream slowLink回调，Janus reports problems "+(e?"sending":"receiving")+" packets on this PeerConnection ("+t+" lost packets)")},onmessage:function(e,t){if(a.logger.log("subscribeStream onMessage回调，返回msg：",e,"返回jsep：",t),null!=t&&(a.logger.debug("Handling SDP as well..."),a.logger.debug(t),l.handleRemoteJsep({jsep:t})),e.rtcgw){l.messageTrigger(e.rtcgw,e);let t=e;"error"===e.rtcgw&&(t=R(e)),a.trigger(e.rtcgw,t)}},onlocalstream:function(e){a.logger.log("subscribeStream onlocalstream回调：",e)},onremotestream:function(t){a.logger.log("subscribeStream onremotestream回调：",t,"steamTracks：",null==t?void 0:t.getTracks()),null!=t&&t.active&&(e.type===z.STREAM_TYPE.SCREEN&&(this.countScreenStream=(this.countScreenStream||0)+1,this.countScreenStream>2)||(null!=e&&e.view&&a.playStream({domId:e.view,stream:t}),a.state.subscribeAttaches[e.userId][z.ATTACHES_TYPE[e.type]].mediaStream=t,a.trigger(z.EVENT.REMOTE_STREAM_AVAILABLE,{stream:t,streamtype:e.type,userId:e.userId})))},ondataopen:function(e){a.logger.log("subscribeStream ondataopen回调：",e)},ondata:function(e){a.logger.log("subscribeStream ondata回调：",e)},oncleanup:function(){a.logger.log("subscribeStream oncleanup回调")}}):g(),c.promise}async unsubscribe(e){var t;this.logger.log("取消订阅音视频，入参：",JSON.stringify(e));let n=k();const r=null===(t=this.state.subscribeAttaches)||void 0===t||null===(t=t[e.userId])||void 0===t?void 0:t[z.ATTACHES_TYPE[e.type]],s=this.settingMessageBody({cmdType:"unsubremote",streamtype:e.type,customId:e.userId});if(await this.subscribeAttachesQueueAwait(n),null!=r&&r.pluginHandle){var o;if(null===(o=r.pluginHandle)||void 0===o||o.send({message:s,error:e=>{n.reject(A({key:"ERR_SIGNAL_SEND",msg:e}))}}),8!==e.type){[1,4,5].includes(e.type)&&(r.createOfferParams.media.video=!1),2==e.type&&(r.createOfferParams.media.audio=!1);const{video:t,audio:n}=r.createOfferParams.media;t+n===0&&r.pluginHandle.detach({success:()=>this.state.subscribeAttaches[e.userId][z.ATTACHES_TYPE[e.type]]=null})}[8].includes(e.type)&&r.pluginHandle.detach({success:()=>this.state.subscribeAttaches[e.userId][z.ATTACHES_TYPE[e.type]]=null}),n.resolve(A("ERR_OK"))}else setTimeout(n.reject(A({key:"ERR_UNKNOWN",msg:"no handle"})),0);return n.promise}async subscribeMix(e){this.logger.log("订阅混音流");const t=k(),n=this,r=this.settingMessageBody({cmdType:"subremotemix",streamtype:z.STREAM_TYPE.AUDIO_ONLY});let s=null;return this.janusInstance.attach({plugin:"rtcgw.plugin.sts",opaqueId:this.config.opaqueId,success:e=>{n.logger.log("subscribeMix attach success回调，返回订阅流句柄：",e),s=this.state.roomInfo.amixer.pluginHandle=e,s.createOffer({media:{videoSend:!1,videoRecv:!1,audioSend:!1,audioRecv:!0,data:!1,video:!1,audio:!0},success:function(e){n.logger.log("subscribeMix createOffer success回调，返回jsep：",e),s.send({message:r,jsep:e,error:e=>t.reject(A({key:"ERR_SIGNAL_SEND",msg:e}))}),s.messageListen(z.EVENT.SUBREMOTEMIXACK,e=>{if(0===(null==e?void 0:e.code))t.resolve(A("ERR_OK"));else{n.unsubscribeMix();const r=R(e);t.reject(r)}}),s.messageListen(z.EVENT.ERROR,e=>{n.logger.log("订阅失败：",null==e?void 0:e.msg);const r=R(e);t.reject(r)})},error:function(e){n.logger.error("subscribeMix createOffer error回调:",e),t.reject(A({key:"ERR_SUBSCRIBE_FAIL",msg:e}))}})},error:function(e){n.logger.error("subscribeMix attach error回调：",e),t.reject(A({key:"ERR_SUBSCRIBE_FAIL",msg:e}))},consentDialog:function(e){n.logger.debug("subscribeMix consentDialog回调：",e)},iceState:function(e,t){switch(n.logger.log("subscribeMix iceState回调：",e),e){case"connected":n.iceTimeoutRestartWebsocket.cancel();break;case"disconnected":n.iceTimeoutRestartWebsocket(t)}},mediaState:function(e,t){n.logger.log("subscribeMix mediaState回调，Janus "+(t?"started":"stopped")+" receiving our "+e)},webrtcState:function(e){n.logger.log("subscribeMix webrtcState回调，Janus says our WebRTC PeerConnection is "+(e?"up":"down")+" now"),e&&n.pollingNetworkQuality()},slowLink:function(e,t){n.logger.warn("subscribeMix slowLink回调，Janus reports problems "+(e?"sending":"receiving")+" packets on this PeerConnection ("+t+" lost packets)")},onmessage:function(e,t){if(n.logger.log("subscribeMix onMessage回调，返回msg：",e,"返回jsep：",t),null!=t&&(n.logger.debug("Handling SDP as well..."),n.logger.debug(t),s.handleRemoteJsep({jsep:t})),e.rtcgw){s.messageTrigger(e.rtcgw,e);let t=e;"error"===e.rtcgw&&(t=R(e)),n.trigger(e.rtcgw,t)}},onlocalstream:function(e){n.logger.log("subscribeMix onlocalstream回调：",e)},onremotestream:function(t){n.logger.log("subscribeMix onremotestream回调：",t,"steamTracks：",null==t?void 0:t.getTracks()),null!=t&&t.active&&(n.state.roomInfo.amixer.streams[0]={streamtype:"amixer",mediaStream:t},null!=e&&e.view&&(n.state.roomInfo.amixer.streams[0].view=e.view,n.playStream({domId:e.view,stream:t})),n.trigger(z.EVENT.REMOTE_STREAM_AVAILABLE,{stream:t,streamtype:"amixer"}))},ondataopen:function(e){n.logger.log("subscribeMix ondataopen回调：",e)},ondata:function(e){n.logger.log("subscribeMix ondata回调：",e)},oncleanup:function(){n.logger.log("subscribeMix oncleanup回调")}}),t.promise}async unsubscribeMix(e){this.logger.log("取消订阅混音流");let t=k();const n=this.state.roomInfo.amixer.pluginHandle,r=this.settingMessageBody({cmdType:"unsubremotemix",streamtype:z.STREAM_TYPE.AUDIO_ONLY});return n?(n.send({message:r,error:e=>{t.reject(A({key:"ERR_SIGNAL_SEND",msg:e}))}}),n.detach({success:()=>this.state.roomInfo.amixer.pluginHandle=null}),t.resolve(A("ERR_OK"))):setTimeout(t.reject(A({key:"ERR_UNKNOWN",msg:"no handle"})),0),t.promise}setCameraDevice(e){var t;const n=this,r=k(),{publishAttaches:s,videoSettingParams:o}=this.state,i=null===(t=s[z.ATTACHES_TYPE[z.STREAM_TYPE.VIDEO_ONLY]])||void 0===t?void 0:t.pluginHandle,a=this.state.videoSettingParams.simulcast;var c;(this.state.videoSettingParams.cameraId=e.deviceId,this.state.profile.cameraId=e.deviceId,i)&&i.createOffer({media:{video:{deviceId:e.deviceId},replaceVideo:!0,audio:!(null===(c=s[z.ATTACHES_TYPE[z.STREAM_TYPE.VIDEO_ONLY]])||void 0===c||null===(c=c.createOfferParams)||void 0===c||null===(c=c.media)||void 0===c||!c.audio)},simulcast:a,bitrate:o.bitrate,frameRate:o.frameRate,success:function(e){n.logger.log("设置video deviceId成功，返回jsep：",e),r.resolve(A("ERR_OK"))},error:function(e){n.logger.error("设置video deviceId失败：",e),r.reject(A({key:"ERR_UNKNOWN",msg:e}))}});return r.promise}setMicrophoneDevice(e){var t;const n=this,r=k(),{publishAttaches:s,videoSettingParams:o}=this.state,i=null===(t=s[z.ATTACHES_TYPE[z.STREAM_TYPE.AUDIO_ONLY]])||void 0===t?void 0:t.pluginHandle,a=this.state.videoSettingParams.simulcast;var c;(this.state.audioSettingParams.microphoneId=e.deviceId,this.state.profile.microphoneId=e.deviceId,i)&&i.createOffer({media:{audio:{deviceId:e.deviceId},replaceAudio:!0,video:!(null===(c=s[z.ATTACHES_TYPE[z.STREAM_TYPE.AUDIO_ONLY]])||void 0===c||null===(c=c.createOfferParams)||void 0===c||null===(c=c.media)||void 0===c||!c.video)},simulcast:a,bitrate:o.bitrate,frameRate:o.frameRate,success:function(e){n.logger.log("设置audio deviceId成功，返回jsep：",e),r.resolve(A("ERR_OK"))},error:function(e){n.logger.error("设置audio deviceId失败：",e),r.reject(A({key:"ERR_UNKNOWN",msg:e}))}});return r.promise}setProfile(e){const{cameraId:t,microphoneId:n,width:r,height:s,frameRate:o,bitrate:i,simulcast:a}=e;this.state.profile=Object.assign(this.state.profile,e)}setVideoProfile(e){let t=k();return this.state.videoSettingParams={cameraId:e.cameraId||null,width:e.width||null,height:e.height||null,frameRate:e.frameRate||null,bitrate:e.bitrate?1e3*e.bitrate:null,simulcast:e.simulcast||!1,simulcastMaxBitrates:e.bitrate?{high:1e3*e.bitrate,medium:null,low:null}:null},t.resolve(A("ERR_OK")),t.promise}setAudioProfile(e){let t=k();return this.state.audioSettingParams={microphoneId:e.microphoneId||null},t.resolve(A("ERR_OK")),t.promise}pausePushStream(e){return this.controlStream(e,"suspend")}resumePushStream(e){return this.controlStream(e,"resume")}controlStream(e,t){const n=k(),r=this.state.publishAttaches[z.ATTACHES_TYPE[e.type]];null==r||r.pluginHandle;const s=null==r?void 0:r.mediaStream;let o=!1;return null==s||s.getTracks().forEach(r=>{([2].includes(e.type)&&"audio"==r.kind||[1,8].includes(e.type)&&"video"==r.kind)&&(r.enabled="resume"==t,o=!0,n.resolve(A("ERR_OK")))}),o||n.reject(A({key:"ERR_UNKNOWN",msg:"no matched track"})),n.promise}destroySubscribeAttach(e){if(e){var t;const n=null===(t=this.state.subscribeAttaches)||void 0===t?void 0:t[e];n&&Object.entries(n).forEach(t=>{var n;let[r,s]=t;null==s||null===(n=s.pluginHandle)||void 0===n||n.detach({success:()=>this.state.subscribeAttaches[e][r]=null})}),delete this.state.subscribeAttaches[e]}}resumePullPeerStream(e){var t;let n=k();const r=null===(t=this.state.subscribeAttaches)||void 0===t||null===(t=t[e.userId])||void 0===t?void 0:t[z.ATTACHES_TYPE[e.type]],s=this.settingMessageBody({cmdType:"resumesubremote",streamtype:e.type,customId:e.userId});return null!=r&&r.pluginHandle&&r.pluginHandle.send({message:s,success:()=>{n.resolve(A("ERR_OK"))},error:e=>{n.reject(A({key:"ERR_UNKNOWN",msg:e}))}}),n.promise}pausePullPeerStream(e){var t;let n=k();const r=null===(t=this.state.subscribeAttaches)||void 0===t||null===(t=t[e.userId])||void 0===t?void 0:t[z.ATTACHES_TYPE[e.type]];return null==r||r.pluginHandle.send({message:this.settingMessageBody({cmdType:"pausesubremote",streamtype:e.type,customId:e.userId}),success:()=>{n.resolve(A("ERR_OK"))},error:e=>{n.reject(A({key:"ERR_UNKNOWN",msg:e}))}}),n.promise}playStream(e){let t=k(),n=e.domId;return"string"==typeof e.domId&&(n=document.getElementById(e.domId)),n&&e.stream?(b.attachMediaStream(n,e.stream),n.play(),t.resolve(A("ERR_OK"))):t.reject(A({key:"ERR_UNKNOWN",msg:"play fail"})),t.promise}pollingNetworkQuality(){this.state.networkQualityPollingTimer||(this.state.networkQualityPollingTimer=setInterval(()=>{const{publishAttaches:e,subscribeAttaches:t}=this.state;let r=!0;if(e)for(let t=0;t<(null===(s=Object.values(e))||void 0===s?void 0:s.length);t++){var s;const n=Object.values(e)[t];var o;if(null!=n&&n.pluginHandle)if(r=!1,null!=n&&null!==(o=n.createOfferParams)&&void 0!==o&&null!==(o=o.media)&&void 0!==o&&o.video){var i;null===(i=n.pluginHandle)||void 0===i||i.getNetworkQuality(n.pluginHandle.id,e=>{const t=this.state.networkQuality.uplink.lastReports=this.state.networkQuality.uplink.currentReports,n=this.state.networkQuality.uplink.currentReports=e,r=this.getQuality({currentReports:n,lastReports:t},"up");(null!=r&&r.quality||0===(null==r?void 0:r.quality))&&Object.assign(this.state.networkQuality.uplink,{...r})});break}}if(t){Object.entries(t).forEach(e=>{let[t,n]=e;if(n)for(let e=0;e<(null===(s=Object.values(n))||void 0===s?void 0:s.length);e++){var s;const a=Object.values(n)[e];var o;if(null!=a&&a.pluginHandle)if(r=!1,null!=a&&null!==(o=a.createOfferParams)&&void 0!==o&&null!==(o=o.media)&&void 0!==o&&o.video){var i;null===(i=a.pluginHandle)||void 0===i||i.getNetworkQuality(a.pluginHandle.id,e=>{this.state.networkQuality.downlink.remotes[t]||(this.state.networkQuality.downlink.remotes[t]={currentReports:e});const n=this.state.networkQuality.downlink.remotes[t].lastReports=this.state.networkQuality.downlink.remotes[t].currentReports,r=this.state.networkQuality.downlink.remotes[t].currentReports=e,s=this.getQuality({currentReports:r,lastReports:n},"down");(null!=s&&s.quality||0===(null==s?void 0:s.quality))&&Object.assign(this.state.networkQuality.downlink.remotes[t],{...s})});break}}});const e=Object.values(this.state.networkQuality.downlink.remotes);Object.assign(this.state.networkQuality.downlink,e&&n.maxBy(e,e=>e.quality)||{})}r&&(clearInterval(this.state.networkQualityPollingTimer),this.state.networkQualityPollingTimer=null,this.logger.log("检测到流通道都关闭，停止网络质量轮询")),setTimeout(()=>this.reportNetWork(),500)},2e3))}getQuality(e){var t,n;let{currentReports:r,lastReports:s}=e,o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"up";const i=this,a="up"==o&&"video"===(null===(t=r["remote-inbound-rtp"])||void 0===t?void 0:t.kind),c="down"==o&&"video"===(null===(n=r["inbound-rtp"])||void 0===n?void 0:n.kind);if(a){if(r["remote-inbound-rtp"]&&s["remote-inbound-rtp"]&&r["outbound-rtp"]&&s["outbound-rtp"]){const{packetsSent:e}=r["outbound-rtp"],{packetsLost:t,jitter:n,roundTripTime:o,fractionLost:a}=r["remote-inbound-rtp"],{packetsSent:c}=s["outbound-rtp"],{packetsLost:d}=s["remote-inbound-rtp"];if(!o||!t&&0!==t||!n)return;const l=null!=a?a:0,u=null!=l?l:(t-d)/(e-c),h=1e3*n,m=1e3*o,g=u/.1*.3+h/100*.5+m/50*.2;return{quality:i.qualityLeavel(g)||0,packageLost:(null==u?void 0:u.toFixed(2))||null,jitter:(null==h?void 0:h.toFixed(2))||null,rtt:(null==m?void 0:m.toFixed(2))||null}}}else if(c&&r["inbound-rtp"]&&r["candidate-pair"]&&s["inbound-rtp"]){const{jitter:e,packetsLost:t,packetsReceived:n,nackCount:o,lastPacketReceivedTimestamp:a}=r["inbound-rtp"],{packetsLost:c,packetsReceived:d,nackCount:l}=s["inbound-rtp"],{currentRoundTripTime:u,lastPacketReceivedTimestamp:h,lastPacketSentTimestamp:m}=r["candidate-pair"];if(!u&&!h||!t&&0!==t||!e&&!a)return;if(!c&&0!==c)return;const g=t-c,v=n-d,p=o-l;if(0===v)return;const f=(g+p)/(v+g+p),_=1e3*(e||0),S=u?1e3*u:Math.abs(h-m),T=f/.1*.3+_/100*.5+S/50*.2;return{quality:i.qualityLeavel(T)||0,packageLost:(null==f?void 0:f.toFixed(2))||null,jitter:(null==_?void 0:_.toFixed(2))||null,rtt:(null==S?void 0:S.toFixed(2))||null}}}reportNetWork(){const e=this,{uplink:t,downlink:r}=this.state.networkQuality,{quality:s,reportedQuality:o,packageLost:i,jitter:a,rtt:c}=t,{quality:d,reportedQuality:l,packageLost:u,jitter:h,rtt:m}=r,g={cmdType:"sendnetquality",upquality:s,downquality:d};(t.quality>0||r.quality>0)&&this.trigger(z.EVENT.REPORT_NETWORK_QUALITY,n.cloneDeep({uplink:t.quality>0?t:null,downlink:r.quality>0?r:null})),s===o&&d===l||(this.trigger(z.EVENT.REPORT_NETWORK_QUALITY_CHANGE,n.cloneDeep({uplink:t,downlink:r})),this.state.networkQuality.uplink.reportedQuality=s,this.state.networkQuality.downlink.reportedQuality=d,this.usersInstance.updateUser({id:this.config.customId,networkQuality:{upquality:s,downquality:d}}),this.state.messagePluginHandle&&this.state.messagePluginHandle.send({message:g,success:()=>{e.logger.log("网络质量上报服务器成功：",{uplink:t,downlink:r})},error:t=>{e.logger.error("网络质量上报服务器失败，原因：",t)}}))}qualityLeavel(e){return e<=1?1:e<=2?2:e<=3?3:e<=4.8?4:e<=8?5:e>8?6:0}resettingConfig(){var e;this.resettingAttaches(),this.resettingNetworkQuality(),this.resettingAmixer(),null===(e=this.state.messagePluginHandle)||void 0===e||e.detach(),this.state.messagePluginHandle=null}resettingAttaches(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"all";if(["all","publish"].includes(e)){const e=this.state.publishAttaches;e&&Object.values(e).forEach(e=>{null!=e&&e.pluginHandle&&(e.pluginHandle.detach(),e.pluginHandle=null)}),this.state.publishAttaches={}}if(["all","subscribe"].includes(e)){const e=this.state.subscribeAttaches;e&&Object.keys(e).forEach(e=>{this.destroySubscribeAttach(e)}),this.state.subscribeAttaches={}}}resettingAmixer(){var e;null===(e=this.state.roomInfo.amixer.pluginHandle)||void 0===e||e.detach(),this.state.roomInfo.amixer.pluginHandle=null,this.state.roomInfo.amixer.streams=[]}resettingNetworkQuality(){this.state.networkQuality=n.cloneDeep(G)}getOrientation(){const e=this;let t=0;return window.addEventListener("orientationchange",function(n){if(e.logger.log("orientationchange",n),null!=n.orientation)t=n.orientation;else{let e=setTimeout(()=>{t=window.innerWidth>window.innerHeight?90:0,clearTimeout(e)},100)}}),e.logger.log("旋转角度orientation",t),t}removeOrientation(){const e=this;window.removeEventListener("orientationchange",function(t){e.logger.log("orientationchange",t)})}publishAttachesQueueAwait(e){if(this.state.publishAttachesQueue.push(e),Promise.race([w(2e3),e.promise]).finally(()=>{this.state.publishAttachesQueue.shift()}),this.state.publishAttachesQueue.length>1)return new Promise(e=>{this.state.publishAttachesQueue.at(-2).promise.finally(()=>{e()})})}subscribeAttachesQueueAwait(e){if(this.state.subscribeAttachesQueue.push(e),Promise.race([w(2e3),e.promise]).finally(()=>{this.state.subscribeAttachesQueue.shift()}),this.state.subscribeAttachesQueue.length>1)return new Promise(e=>{this.state.subscribeAttachesQueue.at(-2).promise.finally(()=>{e()})})}attachScreenBySafari(){var e,t;"safari"===(null===(e=b.webRTCAdapter)||void 0===e||null===(e=e.browserDetails)||void 0===e?void 0:e.browser)&&(null!==(t=this.state.publishAttaches[z.ATTACHES_TYPE[z.STREAM_TYPE.SCREEN]])&&void 0!==t&&t.pluginHandle&&(this.state.publishAttaches[z.ATTACHES_TYPE[z.STREAM_TYPE.SCREEN]].pluginHandle.detach(),this.state.publishAttaches[z.ATTACHES_TYPE[z.STREAM_TYPE.SCREEN]].pluginHandle=null),this.publishStream({type:z.STREAM_TYPE.SCREEN,attachOnly:!0}))}async startLive(e){let{accessToken:t,livePushUrl:n}=e;return C({url:`${this.domain||"https://open.ys7.com"}/api/service/rtc/live/start`,method:"POST",data:{appId:this.config.appId,roomId:this.config.strRoomId,livePushUrl:n||"rtmp://rtc-livepush.ys7.com/live/12345?txSecret=27d38948a44f550c8ab49769289ff761&txTime=67445AD9",liveConfig:JSON.stringify({mediaConfig:{videoStreamType:0,subUserId:["0",this.config.customId],subScreenStream:!0},mixConfig:{video:{width:1920,height:1080,fps:15,bitRate:2e3,mixMode:0},layout:[{uid:"0",position:[0,0,1920,1080],layer:1},{uid:`${this.config.customId}`,position:[1280,0,640,360],layer:2}],dividingline_config:{enableMode:2,selfConfig:{c:"0x4B0082",width:2}}}})},headerOptions:{accessToken:t||"at.b3vtqw9r8tiqsxfq0etpobmm6eqoorfv-3k81mibg7y-08ep5b5-4uysa14if"}})}},({e:[x],c:[z,U]}=function(e,t,n,r,s,o){function i(e,t,n){return function(r,s){return n&&n(r),e[t].call(r,s)}}function a(e,t){for(var n=0;n<e.length;n++)e[n].call(t);return t}function c(e,t,n,r){if("function"!=typeof e&&(r||void 0!==e))throw new TypeError(t+" must "+(n||"be")+" a function"+(r?"":" or undefined"));return e}function d(e,t,n,r,s,o,a,d,l,h,m,g,v){function p(e){if(!v(e))throw new TypeError("Attempted to access private element on non-instance")}var f,_=t[0],S=t[3],T=!d;if(!T){n||Array.isArray(_)||(_=[_]);var I={},E=[],b=3===s?"get":4===s||g?"set":"value";h?(m||g?I={get:u(function(){return S(this)},r,"get"),set:function(e){t[4](this,e)}}:I[b]=S,m||u(I[b],r,2===s?"":b)):m||(I=Object.getOwnPropertyDescriptor(e,r))}for(var y=e,R=_.length-1;R>=0;R-=n?2:1){var A=_[R],k=n?_[R-1]:void 0,w={},P={kind:["field","accessor","method","getter","setter","class"][s],name:r,metadata:o,addInitializer:function(e,t){if(e.v)throw Error("attempted to call addInitializer after decoration was finished");c(t,"An initializer","be",!0),a.push(t)}.bind(null,w)};try{if(T)(f=c(A.call(k,y,P),"class decorators","return"))&&(y=f);else{var C,O;P.static=l,P.private=h,h?2===s?C=function(e){return p(e),I.value}:(s<4&&(C=i(I,"get",p)),3!==s&&(O=i(I,"set",p))):(C=function(e){return e[r]},(s<2||4===s)&&(O=function(e,t){e[r]=t}));var D=P.access={has:h?v.bind():function(e){return r in e}};if(C&&(D.get=C),O&&(D.set=O),y=A.call(k,g?{get:I.get,set:I.set}:I[b],P),g){if("object"==typeof y&&y)(f=c(y.get,"accessor.get"))&&(I.get=f),(f=c(y.set,"accessor.set"))&&(I.set=f),(f=c(y.init,"accessor.init"))&&E.push(f);else if(void 0!==y)throw new TypeError("accessor decorators must return an object with get, set, or init properties or void 0")}else c(y,(m?"field":"method")+" decorators","return")&&(m?E.push(y):I[b]=y)}}finally{w.v=!0}}return(m||g)&&d.push(function(e,t){for(var n=E.length-1;n>=0;n--)t=E[n].call(e,t);return t}),m||T||(h?g?d.push(i(I,"get"),i(I,"set")):d.push(2===s?I[b]:i.call.bind(I[b])):Object.defineProperty(e,r,I)),y}function l(e,t){return Object.defineProperty(e,Symbol.metadata||Symbol.for("Symbol.metadata"),{configurable:!0,enumerable:!0,value:t})}if(arguments.length>=6)var m=o[Symbol.metadata||Symbol.for("Symbol.metadata")];var g=Object.create(null==m?null:m),v=function(e,t,n,r){var s,o,i=[],c=function(t){return function(e){if(Object(e)!==e)throw TypeError("right-hand side of 'in' should be an object, got "+(null!==e?typeof e:"null"));return e}(t)===e},l=new Map;function u(e){e&&i.push(a.bind(null,e))}for(var m=0;m<t.length;m++){var g=t[m];if(Array.isArray(g)){var v=g[1],p=g[2],f=g.length>3,_=16&v,S=!!(8&v),T=0==(v&=7),I=p+"/"+S;if(!T&&!f){var E=l.get(I);if(!0===E||3===E&&4!==v||4===E&&3!==v)throw Error("Attempted to decorate a public method/accessor that has the same name as a previously decorated public method/accessor. This is not currently supported by the decorators plugin. Property name was: "+p);l.set(I,!(v>2)||v)}d(S?e:e.prototype,g,_,f?"#"+p:h(p),v,r,S?o=o||[]:s=s||[],i,S,f,T,1===v,S&&f?c:n)}}return u(s),u(o),i}(e,t,s,g);return n.length||l(e,g),{e:v,get c(){var t=[];return n.length&&[l(d(e,[n],r,e.name,5,g,t),g),a.bind(null,t,e)]}}}(V,[[Y,18,"publishStream"],[j,18,"unpublishStream"],[$,18,"subscribeStream"],[H,18,"unsubscribe"],[F,18,"subscribeMix"],[q,18,"unsubscribeMix"],[Q,18,"controlStream"],[B,18,"resumePullPeerStream"],[K,18,"pausePullPeerStream"]],[function(e){e.prototype.on=function(e,t){this.listenList||(this.listenList={}),this.listenList[e]||(this.listenList[e]=[]),this.listenList[e].push(t)},e.prototype.once=function(e,t){const n=this;this.on(e,function r(){n.remove(e,r),t.apply(n,arguments)})},e.prototype.trigger=function(){var e;const t=Array.prototype.shift.call(arguments),n=null===(e=this.listenList)||void 0===e?void 0:e[t];if(!n||0===n.length)return!1;for(let e,t=0;e=n[t];t++)e.apply(this,arguments)},e.prototype.remove=function(e,t){var n;const r=null===(n=this.listenList)||void 0===n?void 0:n[e];if(!r)return!1;if(t)for(let e=r.length-1;e>=0;e--){r[e]===t&&r.splice(e,1)}else r&&(r.length=0)}},function(e){e.prototype.getVersion=function(){return Promise.resolve(O)},e.prototype.getSupport=function(){let e=k(),t={isWebrtcSupport:!0,isH264Support:!0};var n=document.createElement("video");return n.canPlayType&&(n.canPlayType('video/mp4;codecs="avc1.64001E"')?t.isH264Support=!0:t.isH264Support=!1),navigator.mediaDevices&&navigator.mediaDevices.getUserMedia&&navigator.mediaDevices.getDisplayMedia?(t.isWebrtcSupport=!0,e.resolve(A({key:"ERR_OK",data:t}))):(t.isWebrtcSupport=!1,e.resolve(A({key:"ERR_OK",data:t}))),e.promise},e.prototype.isSupported=function(){var e,t,n;const r=!(null===(e=document.createElement("video"))||void 0===e||!e.canPlayType('video/mp4;codecs="avc1.64001E"')),s=!(null===(t=navigator.mediaDevices)||void 0===t||!t.getUserMedia),o=!(null===(n=navigator.mediaDevices)||void 0===n||!n.getDisplayMedia),i=/^(https:\/\/|file:\/\/|http:\/\/localhost|http:\/\/127\.0\.0\.1).*$/.test(window.location.origin);return A({key:"ERR_OK",data:{result:r&&s&&o&&i,detail:{isSupportH264:r,isSupportMedia:s,isSupportScreen:o,isSupportWebmain:i}}})},e.prototype.getMediaList=function(){let t=k();return navigator.mediaDevices?(e.log("获取媒体设备：",navigator.mediaDevices.enumerateDevices()),navigator.mediaDevices.enumerateDevices().then(e=>{t.resolve(A({key:"ERR_OK",data:e}))})):t.reject(A({key:"ERR_UNKNOWN",msg:"no devices"})),t.promise},e.prototype.getCamerasList=function(){let e=k();return navigator.mediaDevices?navigator.mediaDevices.enumerateDevices().then(t=>{let n=[];t.map(e=>{"videoinput"==e.kind&&n.push(e)}),e.resolve(A({key:"ERR_OK",data:n}))}):e.reject(A({key:"ERR_UNKNOWN",msg:"no devices"})),e.promise},e.prototype.getMicrophonesList=function(){let e=k();return navigator.mediaDevices?navigator.mediaDevices.enumerateDevices().then(t=>{let n=[];t.map(e=>{"audioinput"==e.kind&&n.push(e)}),e.resolve(A({key:"ERR_OK",data:n}))}):e.reject(A({key:"ERR_UNKNOWN",msg:"no devices"})),e.promise},e.prototype.getSpeakerList=function(){let e=k();return navigator.mediaDevices?navigator.mediaDevices.enumerateDevices().then(t=>{let n=[];t.map(e=>{"audiooutput"==e.kind&&n.push(e)}),e.resolve(A({key:"ERR_OK",data:n}))}):e.reject(A({key:"ERR_UNKNOWN",msg:"no devices"})),e.promise},e.prototype.getCameraPermission=function(){return new Promise((e,t)=>{navigator.mediaDevices.getUserMedia({video:!0}).then(t=>{t.getTracks().forEach(e=>{e.stop()}),e(A({key:"ERR_OK",data:!0}))}).catch(e=>{t(A({key:"ERR_UNKNOWN",data:!1,msg:e}))})})},e.prototype.getMicrophonePermission=function(){return new Promise((e,t)=>{navigator.mediaDevices.getUserMedia({audio:!0}).then(t=>{t.getTracks().forEach(e=>{e.stop()}),e(A({key:"ERR_OK",data:!0}))}).catch(e=>{t(A({key:"ERR_UNKNOWN",data:!1,msg:e}))})})}}])),W=V,M=class extends l{constructor(){super(z),d(this,"VERSION","1.4"),d(this,"STREAM_TYPE",{VIDEO_ONLY:1,AUDIO_ONLY:2,AUDIO_AND_VIDEO:3,VIDEO_SIMULCAST_LITTLE:4,VIDEO_SIMULCAST_LARGE:5,SCREEN:8}),d(this,"ATTACHES_TYPE",{[z.STREAM_TYPE.VIDEO_ONLY]:"default",[z.STREAM_TYPE.AUDIO_ONLY]:"default",[z.STREAM_TYPE.AUDIO_AND_VIDEO]:"default",[z.STREAM_TYPE.VIDEO_SIMULCAST_LITTLE]:"default",[z.STREAM_TYPE.VIDEO_SIMULCAST_LARGE]:"default",[z.STREAM_TYPE.SCREEN]:"screen"}),d(this,"EVENT",{ROOM_INFO_CHANGE:"ROOM_INFO_CHANGE",CONNECT_STATE_CHANGE:"CONNECT_STATE_CHANGE",USERS_CHANGE:"EVENT_USERS_CHANGE",LOCAL_STREAM_AVAILABLE:"EVENT_LOCAL_STREAM_AVAILABLE",REMOTE_STREAM_AVAILABLE:"EVENT_REMOTE_STREAM_AVAILABLE",REPORT_NETWORK_QUALITY:"REPORT_NETWORK_QUALITY",REPORT_NETWORK_QUALITY_CHANGE:"REPORT_NETWORK_QUALITY_CHANGE",ERROR:"error",VIDEO_ROTATION:"video-rotation",AUDIOLEVEL:"audioleve",ENTERROOMACK:"enterRoomack",EXITROOMACK:"exitRoomack",CLIENTJOIN:"clientJoin",CLIENTLEAVE:"clientLeave",STREAM_ADDED:"stream-added",STREAM_REMOVED:"stream-removed",PUBLISHSCREENSTREAMACK:"publishscreenstreamack",NETWORKQUALITY:"networkquality",CLIENT_PERMISSION:"client-permission",SUB_PERMISSION:"sub-permission",PUBLISHLOCALSTREAMACK:"publishlocalstreamack",UNPUBLISHLOCALSTREAMACK:"unpublishlocalstreamack",SUBREMOTEACK:"subremoteack",UNSUBREMOTEACK:"unsubremoteack",SUBREMOTEMIXACK:"subremotemixack"}),d(this,"INNER_EVENT",{CUSTOMIZE_AUDIO_TRACK:"CUSTOMIZE_AUDIO_TRACK"}),d(this,"plugins",[]),U()}},d(M,W,void 0),M);class X extends z{constructor(e){super(e)}startLocalVideo(){return super.publishStream({type:z.STREAM_TYPE.VIDEO_ONLY})}stopLocalVideo(){return super.unpublishStream({type:z.STREAM_TYPE.VIDEO_ONLY})}pauseLocalVideo(){return super.pausePushStream({type:z.STREAM_TYPE.VIDEO_ONLY})}resumeLocalVideo(){return super.resumePushStream({type:z.STREAM_TYPE.VIDEO_ONLY})}startLocalAudio(){return super.publishStream({type:z.STREAM_TYPE.AUDIO_ONLY})}stopLocalAudio(){return super.unpublishStream({type:z.STREAM_TYPE.AUDIO_ONLY})}pauseLocalAudio(){return super.pausePushStream({type:z.STREAM_TYPE.AUDIO_ONLY})}resumeLocalAudio(){return super.resumePushStream({type:z.STREAM_TYPE.AUDIO_ONLY})}startScreenShare(e){return super.publishStream({type:z.STREAM_TYPE.SCREEN,...e})}stopScreenShare(){return super.unpublishStream({type:z.STREAM_TYPE.SCREEN})}getUsers(){var e;return null===(e=this.usersInstance)||void 0===e?void 0:e.getUsers()}getVideoSettingParams(){return this.state.videoSettingParams}}class Z extends X{constructor(e){super(e),this.deviceInfo={deviceSerial:null,channelNo:null,token:null,deviceRtcToken:null,appKey:null},this.bindMessageEvent()}deviceInit(e){const t=`${e.deviceSerial}_${e.channelNo}_${e.userId}`;return Object.assign(this.deviceInfo,e),Promise.all([this.getDeviceToken(e),super.initConfig({...e,roomId:t,timeout:15})])}enterRoom(e){return super.enterRoom(e||this.config)}async endTalk(){try{const e=await Promise.allSettled([this.kickoutDevice(),super.leaveRoom()]);if("fulfilled"===e[1].status)return this.logger.log("结束对讲成功"),Promise.resolve({code:0,message:"success",data:null});{const t=e[1].reason||"leaveroom error";return this.logger.log("结束对讲失败：",t),Promise.reject(t)}}catch(e){return this.logger.log("结束对讲失败：",e),Promise.reject(e)}}async inviteDevice(e){const t=k(),n={accessToken:this.config.accessToken,strRoomId:this.config.strRoomId,appId:this.config.appId,deviceSerial:this.deviceInfo.deviceSerial,channelNo:this.deviceInfo.channelNo,streamType:this.deviceInfo.streamType||1,mode:this.deviceInfo.mode||2,maxActiveSeconds:this.deviceInfo.maxActiveSeconds||-1,devProtocol:this.deviceInfo.devProtocol||"ysproto",authToken:this.deviceInfo.deviceRtcToken,token:this.deviceInfo.token,authType:23};return C({url:`${this.domain||"https://open.ys7.com"}/api/v3/conference/device/invite`,method:"POST",data:n}).then(e=>{var n;if(200===(null===(n=e.meta)||void 0===n?void 0:n.code))t.resolve({code:0,message:"success",data:null}),this.logger.log("邀请设备入会成功：",e);else{var r;const n=(null===(r=e.meta)||void 0===r?void 0:r.message)||e.msg||"未知错误";t.reject(n),this.logger.log("邀请设备入会失败：",n)}}).catch(e=>{this.logger.log("邀请设备入会失败：",e),t.reject(e)}),t.promise}kickoutDevice(e){const t=k(),n={accessToken:this.config.accessToken,strRoomId:this.config.strRoomId,appId:this.config.appId,deviceSerial:this.deviceInfo.deviceSerial,channelNo:this.deviceInfo.channelNo,token:this.deviceInfo.token,authToken:this.deviceInfo.deviceRtcToken,authType:23},r=`${n.deviceSerial}_${n.channelNo}`;return C({url:`${this.domain||"https://open.ys7.com"}/api/v3/conference/device/kickout`,method:"POST",data:n}).then(e=>{var n;if(200===(null===(n=e.meta)||void 0===n?void 0:n.code)){var s;null===(s=this.state.subscribeAttaches[r])||void 0===s||null===(s=s[X.ATTACHES_TYPE[X.STREAM_TYPE.AUDIO_ONLY]])||void 0===s||null===(s=s.pluginHandle)||void 0===s||s.detach(),this.state.subscribeAttaches[r]=null,super.unpublishStream({type:X.STREAM_TYPE.AUDIO_ONLY}),t.resolve({code:0,message:"success",data:null}),this.logger.log("强制设备退出成功：",e)}else{var o;const n=(null===(o=e.meta)||void 0===o?void 0:o.message)||e.msg||"未知错误";t.reject(n),this.logger.log("强制设备退出失败：",n)}}).catch(e=>{this.logger.log("强制设备退出失败：",e),t.reject(e)}),t.promise}openDeviceAudio(){var e,t;const n=k(null),r=`${this.deviceInfo.deviceSerial}_${this.deviceInfo.channelNo}`,s=this.state.publishAttaches[X.ATTACHES_TYPE[X.STREAM_TYPE.AUDIO_ONLY]];return null===(e=this.state.subscribeAttaches)||void 0===e||null===(e=e[r])||void 0===e||e[X.ATTACHES_TYPE[X.STREAM_TYPE.AUDIO_ONLY]],null!=s&&null!==(t=s.createOfferParams)&&void 0!==t&&null!==(t=t.media)&&void 0!==t&&t.audio?super.resumePushStream({type:X.STREAM_TYPE.AUDIO_ONLY}):(super.publishStream({type:X.STREAM_TYPE.AUDIO_ONLY}).then(()=>{n.resolve({code:0,message:"success",data:null})}).catch(e=>{this.logger.log("打开语音失败：",e),n.reject(e)}),n.promise)}closeDeviceAudio(e){var t;const n=k(null),r=this.state.publishAttaches[X.ATTACHES_TYPE[X.STREAM_TYPE.AUDIO_ONLY]];return null!=r&&null!==(t=r.createOfferParams)&&void 0!==t&&null!==(t=t.media)&&void 0!==t&&t.audio?super.pausePushStream({type:X.STREAM_TYPE.AUDIO_ONLY}):(this.logger.log("关闭语音失败：","no audio stream"),n.reject("no audio stream"),n.promise)}getDeviceToken(e){const t=k();return C({url:`${this.domain||"https://open.ys7.com"}/api/user/token`,method:"POST",data:{accessToken:e.accessToken||this.config.accessToken,appKey:e.appKey||this.deviceInfo.appKey,clientType:"0",osVersion:"wins",sdkVersion:"v2.2.0.20230602",count:1,featureCode:"f24940e782454a0ca7cbf7c2a292a6c7",netType:"UNKNOWN"}}).then(e=>{"200"===e.resultCode?(this.logger.log("获取设备取流token成功：",e),this.deviceInfo.token=e.tokenArray[0],t.resolve(e.tokenArray[0])):(this.logger.log("获取设备取流token失败，接口报错：",e),t.reject(e.resultMsg||e.msg||"未知错误"))}).catch(e=>{this.logger.log("获取设备取流token失败：",e),t.reject(e)}),t.promise}async startDeviceTalk(e){var t,n;const r=`${e.deviceSerial}_${e.channelNo}`,s=null===(t=this.state.subscribeAttaches)||void 0===t||null===(t=t[r])||void 0===t?void 0:t[X.ATTACHES_TYPE[X.STREAM_TYPE.AUDIO_ONLY]],o=e.deviceSerial===this.deviceInfo.deviceSerial&&e.channelNo===this.deviceInfo.channelNo;if(o&&null!=s&&s.pluginHandle&&(null===(n=this.usersInstance)||void 0===n||null===(n=n.getUsers())||void 0===n?void 0:n.length)>1)return this.openDeviceAudio();try{var i,a;return o&&null!==(i=this.janusInstance)&&void 0!==i&&i.isConnected()||await this.deviceInit(e),null!==(a=this.janusInstance)&&void 0!==a&&a.isConnected()||await super.connectWebsocket(),await this.inviteDevice(),this.state.messagePluginHandle||await super.attachRoom(),await this.waitStreamAdded(),await this.openDeviceAudio(),Promise.resolve({code:0,message:"success",data:null})}catch(e){return Promise.reject(e)}}waitStreamAdded(){return new Promise(e=>{var t;null===(t=this.state.messagePluginHandle)||void 0===t||t.messageListen("stream-added",t=>{e(t)})})}bindMessageEvent(){super.on(X.EVENT.STREAM_ADDED,e=>{const{customId:t,streamtype:n}=e;t===`${this.deviceInfo.deviceSerial}_${this.deviceInfo.channelNo}`&&n===X.STREAM_TYPE.AUDIO_ONLY&&this.subscribeStream({userId:t,type:X.STREAM_TYPE.AUDIO_ONLY})})}}d(Z,"VERSION","1.0");const ee=function(){let e={};return e.promise=new Promise((t,n)=>{e.resolve=t,e.reject=n}),e};class te{constructor(e){return this._ertcIns=new z({...e}),this._vcsIns=e.vcsIns,this._rtcType=localStorage.getItem("mrtc-rtcType")||null,this._globalParams=e,this._transactions={},this._vcsBeforeEnterRoomEventTransactions={},this._vcsConnectIdMapErtcPluginHandle={},this._mqttNetworkState=null,this._initFunction(),this._initVcsEvent(),this._initErtcEvent(),new Proxy(this,{get:function(e,t){const n=!(t in e),r="vcs"===e._rtcType,s=["_ertcIns","_vcsIns","_globalParams","_rtcType","_transactions","_vcsBeforeEnterRoomEventTransactions","_vcsConnectIdMapErtcPluginHandle","_mqttNetworkState"].includes(t),o=["_listenVcsBeforeEnterRoomEvent"].includes(t),i=["enterRoom"].includes(t),a=["getRtcType"].includes(t);return s||o||i||a||!n&&!r?e[t]:"function"==typeof e._vcsIns[t]?e._vcsIns[t].bind(e._vcsIns):e._vcsIns[t]},set:function(e,t,n){return!(t in e)?e._vcsIns[t]=n:e[t]=n,!0}})}_initFunction(){}_resetVcsFunction(){var e=this;const t=this._vcsIns.onMqttState.bind(this._vcsIns);this._vcsIns.onMqttState=function(){return"mqtt"===(arguments.length<=0?void 0:arguments[0])&&"network"===(arguments.length<=1?void 0:arguments[1])&&!1===(arguments.length<=2?void 0:arguments[2])&&(e._mqttNetworkState="offline"),"mqtt"===(arguments.length<=0?void 0:arguments[0])&&"network"===(arguments.length<=1?void 0:arguments[1])&&(arguments.length<=2?void 0:arguments[2])&&(e._mqttNetworkState="online",e._transactions.ertc_reconnect&&setTimeout(()=>{e._ertcIns.logger.log("mqtt重连成功，执行ertc重连事务"),e._transactions.ertc_reconnect(),delete e._transactions.ertc_reconnect},500)),t(...arguments)}}_initVcsEvent(){}_initErtcEvent(){Object.values(z.EVENT).forEach(e=>{let t=null;[z.EVENT.STREAM_ADDED,z.EVENT.STREAM_REMOVED].includes(e)&&(t=t=>{if([z.STREAM_TYPE.VIDEO_ONLY,z.STREAM_TYPE.AUDIO_ONLY].includes(t.streamtype)){var r;const e=n.cloneDeep(this._vcsIns.getRoom());null===(r=e.persons)||void 0===r||r.forEach(e=>{if(e.id===t.customId){const n=this._ertcIns.usersInstance.query({id:t.customId});this._ertcIns.logger.log("mrtc接收到ertc的stream-add/remove事件后，要替换的用户信息id：",t.customId),this._ertcIns.logger.log(`person.vstate：${e.vstate} person.astate：${e.astate}`),this._ertcIns.logger.log(`ertcPerson.vstate：${n.vstate} ertcPerson.astate：${n.astate}`),n&&(e.vstate=n.vstate?0:1,e.astate=n.astate?0:1,this._vcsIns.roomInfo.setVideoState(e.id.toString(),e.vstate),this._vcsIns.roomInfo.setAudioState(e.id.toString(),e.astate))}});const s=()=>{this._ertcIns.logger.log("mrtc触发vcs音视频流更新"),this._vcsIns.roomInfo.event_roomMemberInfoNotice(e)};"offline"===this._mqttNetworkState?this._addErtcReconnect(s):s()}if([z.STREAM_TYPE.SCREEN].includes(t.streamtype)&&[z.EVENT.STREAM_ADDED].includes(e)){const e=()=>{this._ertcIns.logger.log("mrtc触发vcs屏幕共享"),this._vcsIns.roomInfo.event_startSharingScreen({id:t.customId,index:null,type:3,isFromStreamAdded:!0})};"offline"===this._mqttNetworkState?this._addErtcReconnect(e):e()}}),e===z.EVENT.REMOTE_STREAM_AVAILABLE&&(t=e=>{let t="amixer"===e.streamtype?"amixer":`${e.userId}-${e.streamtype}`;if(null!=t){var n=this._transactions[t];null!=n&&this._transactions[t](e),delete this._transactions[t]}}),e===z.EVENT.VIDEO_ROTATION&&(t=e=>{var t;const{rotate:n,customId:r}=e,s={0:0,90:90,270:270}[n],o=this._vcsIns.getRoom();null===(t=o.persons)||void 0===t||t.forEach(e=>{e.id===r&&e.streams.forEach(e=>{e.angle=s})}),this._ertcIns.logger.log("屏幕转动，mrtc触发vcs房间信息更新"),this._vcsIns.roomInfo.event_roomMemberInfoNotice(o)}),e===z.EVENT.CONNECT_STATE_CHANGE&&(t=e=>{"reconnect success"===e.msg||"reconnecting"===e.msg&&(this._vcsIns.personsNewStreamMap={})}),t&&this._ertcIns.on(e,t)})}enterRoom(e){const t=ee();this._listenVcsBeforeEnterRoomEvent();return this._vcsIns.enterRoom(e.vcsParams.roomOption,e.vcsParams.amixer,e.vcsParams.accountData,e.vcsParams.inviterUid,e.vcsParams.webinar_invitation_link_code).then(r=>{const s=this._vcsIns.getEnterRoomData();this._ertcIns.logger.log("风远加入房间成功：",r),1===(null==s?void 0:s.rtc_mode)?(this._rtcType="ertc",e.ertcParams.domain&&(this._ertcIns.domain=e.ertcParams.domain),this._ertcIns.enterRoom(e.ertcParams).then(async s=>{if(localStorage.setItem("mrtc-enterRoomParams",JSON.stringify(e)),0===s.code){const e=n.cloneDeep(r);t.resolve(e),setTimeout(()=>{this._triggerVcsBeforeEnterRoomEvent(),n.cloneDeep(this._vcsIns.roomInfo._room)},1e3)}else this.leave(),t.reject({code:"100001",msg:s.msg})}).catch(e=>{this.leave(),t.reject({code:"100001",msg:e})})):(this._rtcType="vcs",t.resolve(r)),localStorage.setItem("mrtc-rtcType",this._rtcType),this._ertcIns.logger.log(`当前会议类型：${this._rtcType}`,null==s?void 0:s.rtc_mode)}).catch(t.reject),t.promise}leave(){const e=ee(),t=this._vcsIns.leave(),n=this._ertcIns.leaveRoom();return this._resetRoomStatus(),Promise.all([t,n]).then(t=>{t[1]&&e.resolve(!0)}).catch(e.reject),e.promise}refreshRoom(){const e=ee(),t=this._vcsIns.refreshRoom(),n=this._vcsIns.enterRoomLoading||this._vcsIns.enterRoomData&&this._vcsIns.enterRoomData.room;return t.then(t=>{if(n)return void e.resolve(t);const r=JSON.parse(localStorage.getItem("mrtc-enterRoomParams"));r.ertcParams.domain&&(this._ertcIns.domain=r.ertcParams.domain),this._ertcIns.enterRoom(r.ertcParams).then(async n=>{0===n.code?e.resolve(t):(this.leave(),e.reject({code:"100001",msg:`自研入房失败：${n.msg}`}))}).catch(t=>{this.leave(),e.reject({code:"100001",msg:`自研入房失败：${t}`})})}).catch(e.reject),e.promise}publishSelfVideo(){var e;let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;this._ertcIns.logger.log("进入 publishSelfVideo 函数");const n=ee();if(2==this._vcsIns.controlsAccount.video_state){const e=this._vcsIns.vcsErr.throwErr(707,`推流失败${t}：视频权限被主持人禁用。`,"publishSelfVideo");return Promise.reject(e)}const r=this._vcsIns.videoStreams[t]?null===(e=this._vcsIns.videoStreams[t])||void 0===e?void 0:e.streamID:void 0;if(!r){const e=this._vcsIns.vcsErr.throwErr(9001,`推流失败${t}：流编号错误。`,"publishSelfVideo");return Promise.reject(e)}return this._vcsIns.media.getStream(r).then(e=>{this._ertcIns.publishStream({type:z.STREAM_TYPE.VIDEO_ONLY,stream:e,simulcast:!0,isSingleConnect:!0}).then(s=>{if(0===s.code){const s=b.randomString(12);this._vcsIns.videoStreams[t]&&(this._vcsIns.videoStreams[t].connectID=s),this._vcsIns._updateSocket_addVideoTrack(t),this._vcsIns.notice(this._globalParams.vcsTypes.NoticeType.peerPublish,{account:this._vcsIns.account,srcObject:e}),this._vcsIns.controlsAccount.connections||(this._vcsIns.controlsAccount.connections=new Array),this._vcsIns.controlsAccount.connections.push({connectID:s,streamID:r,index:t,type:1,stream:e}),this._vcsIns.roomClient&&setTimeout(()=>{this._vcsIns.roomClient.heartbeat()},500),n.resolve(e)}else n.reject(s)})}),n.promise}stopPublishSelfVideo(){var e;let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;this._ertcIns.logger.log("进入 stopPublishSelfVideo 函数");const n=ee();this._vcsIns.controlsAccount&&(this._vcsIns.controlsAccount.video_state=1);const r=null===(e=this._vcsIns.videoStreams[t])||void 0===e?void 0:e.connectID;return r?(this._ertcIns.unpublishStream({type:z.STREAM_TYPE.VIDEO_ONLY,isSingleConnect:!0}).then(e=>{0===e.code?(this._vcsIns._updateSocket_removeVideoTrack(t),this._vcsIns.videoStreams[t]&&(this._vcsIns.videoStreams[t].connectID=void 0),this._vcsIns.controlsAccount.connections=this._vcsIns.controlsAccount.connections.filter(e=>e.connectID!==r),n.resolve()):n.reject(e)}),n.promise):(console.error(`停止推流视频${t}出错：没有相应的连接ID。stopPublishSelfVideo`),Promise.resolve())}publishSelfAudio(){var e;let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;this._ertcIns.logger.log("进入 publishSelfAudio 函数");const n=ee();if(2==this._vcsIns.controlsAccount.audio_state){const e=this._vcsIns.vcsErr.throwErr(707,`推流失败${t}：音频权限被主持人禁用。`,"publishSelfAudio");return Promise.reject(e)}const r=this._vcsIns.audioStreams[t]?null===(e=this._vcsIns.audioStreams[t])||void 0===e?void 0:e.streamID:void 0;if(!r){const e=this._vcsIns.vcsErr.throwErr(9001,`推流失败${t}：流编号错误。`,"publishSelfAudio");return Promise.reject(e)}return this._vcsIns.media.getStream(r).then(e=>{this._ertcIns.publishStream({type:z.STREAM_TYPE.AUDIO_ONLY,stream:e,isSingleConnect:!0}).then(s=>{if(0===s.code){const s=b.randomString(12);this._vcsIns.audioStreams[t]&&(this._vcsIns.audioStreams[t].connectID=s),this._vcsIns._updateSocket_addAudioTrack(),this._ertcIns.logger.log(`推送音频流${t}成功。`),this._vcsIns.controlsAccount.connections||(this._vcsIns.controlsAccount.connections=new Array),this._vcsIns.controlsAccount.connections.push({connectID:s,streamID:r,index:t,type:0}),n.resolve(e)}else n.reject(s)}).catch(e=>{console.error(`推送音频流${t}错误：SDP协商出错。`),n.reject(e)})}),n.promise}stopPublishSelfAudio(){var e;let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;const n=ee();this._vcsIns.controlsAccount&&(this._vcsIns.controlsAccount.audio_state=1);const r=null===(e=this._vcsIns.audioStreams[t])||void 0===e?void 0:e.connectID;return r?(this._ertcIns.unpublishStream({type:z.STREAM_TYPE.AUDIO_ONLY,isSingleConnect:!0}).then(e=>{0===e.code?(this._vcsIns._updateSocket_removeAudioTrack(t),this._vcsIns.audioStreams[t]&&(this._vcsIns.audioStreams[t].connectID=void 0),this._vcsIns.controlsAccount.connections=this._vcsIns.controlsAccount.connections.filter(e=>e.connectID!==r),n.resolve()):n.reject(e)}),n.promise):(console.error(`停止推流音频${t}出错：没有相应的连接ID。stopPublishSelfAudio`),Promise.resolve())}publishSelfScreen(e){var t;const n=ee(),r=this._vcsIns.screenStreams[e]?null===(t=this._vcsIns.screenStreams[e])||void 0===t?void 0:t.streamID:void 0;if(!r){const t=this._vcsIns.vcsErr.throwErr(9002,`推流失败${e}：流编号错误。`,"publishSelfScreen");return Promise.reject(t)}return this._vcsIns.media.getStream(r).then(t=>{this._ertcIns.publishStream({type:z.STREAM_TYPE.SCREEN,stream:t}).then(()=>{const s=b.randomString(12);this._vcsIns.screenStreams[e]&&(this._vcsIns.screenStreams[e].connectID=s),this._vcsIns._updateSocket_addScreenTrack(e),this._vcsIns.controlsAccount.connections||(this._vcsIns.controlsAccount.connections=new Array),this._vcsIns.controlsAccount.connections.push({connectID:s,streamID:r,index:e,type:2}),n.resolve(t)}).catch(e=>{n.reject(e)})}),n.promise}stopPublishSelfScreen(e){var t;const n=ee(),r=null===(t=this._vcsIns.screenStreams[e])||void 0===t?void 0:t.connectID;return r?(this._vcsIns.screenStreams[e]&&(this._vcsIns.screenStreams[e].connectID=void 0),this._vcsIns._updateSocket_removeScreenTrack(e),this._ertcIns.unpublishStream({type:z.STREAM_TYPE.SCREEN}).then(e=>{this._vcsIns.controlsAccount.connections=this._vcsIns.controlsAccount.connections.filter(e=>e.connectID!==r),n.resolve()}),n.promise):(this._vcsIns.vcsErr.throwErr(1003,`停止推流桌面${e}出错：没有相应的连接ID。`,"stopPublishSelfScreen"),Promise.resolve())}pullPeerMixerAudioStream(e){const t=ee();let n=!1,r=!1;return this._ertcIns.subscribeMix(e).then(e=>{0===e.code?(n=!0,r&&t.resolve(r)):t.reject(e)}),this._transactions.amixer=e=>{r=e,n&&t.resolve({connectID:null,stream:e.stream})},t.promise}stopPullPeerMixerAudioStream(){return this._ertcIns.unsubscribeMix()}pullPeerVideoStream(e,t){const n=ee(),r=this._vcsIns.pullPeerVideoStream(e,t),s=this._ertcIns.subscribeStream({userId:e,type:z.STREAM_TYPE.VIDEO_ONLY});let o=!1,i=!1,a=null;return Promise.all([r,s]).then(t=>{var r;0===(null===(r=t[1])||void 0===r?void 0:r.code)?(o=!0,a=t[0].connectID,this._vcsConnectIdMapErtcPluginHandle[a]={userId:e,pluginHandle:this._ertcIns.state.subscribeAttaches[e].default.pluginHandle},i&&n.resolve({connectID:a,stream:i.stream})):n.reject(t[1])}).catch(n.reject),this._transactions[`${e}-${z.STREAM_TYPE.VIDEO_ONLY}`]=e=>{i=e,o&&n.resolve({connectID:a,stream:e.stream})},n.promise}stopPullPeerVideoStreamByPersonId(e,t){const n=ee(),r=this._vcsIns.stopPullPeerVideoStreamByPersonId(e,t),s=this._ertcIns.unsubscribe({userId:e,type:z.STREAM_TYPE.VIDEO_ONLY});return Promise.all([r,s]).then(e=>{var t;0===(null===(t=e[1])||void 0===t?void 0:t.code)?n.resolve():n.reject(e[1])}).catch(n.reject),n.promise}stopPullPeerVideoStream(e){const t=this._vcsIns.roomInfo.getIDByConnectID(e);return this.stopPullPeerVideoStreamByPersonId(t)}pullPeerScreenStream(e,t){const n=ee(),r=this._vcsIns.pullPeerScreenStream(e,t),s=this._ertcIns.subscribeStream({userId:e,type:z.STREAM_TYPE.SCREEN});let o=!1,i=!1,a=null;return Promise.all([r,s]).then(e=>{var t;0===(null===(t=e[1])||void 0===t?void 0:t.code)?(o=!0,a=e[0].connectID,i&&n.resolve({connectID:a,stream:i.stream})):n.reject(e[1])}).catch(n.reject),this._transactions[`${e}-${z.STREAM_TYPE.SCREEN}`]=e=>{i=e,o&&n.resolve({connectID:a,stream:e.stream})},n.promise}stopPullPeerScreenStream(e){const t=ee(),n=this._vcsIns.roomInfo.getIDByConnectID(e),r=this._vcsIns.stopPullPeerScreenStream(e),s=this._ertcIns.unsubscribe({userId:n,type:z.STREAM_TYPE.SCREEN});return Promise.all([r,s]).then(e=>{var n;0===(null===(n=e[1])||void 0===n?void 0:n.code)?t.resolve():t.reject(e[1])}).catch(t.reject),t.promise}getRtcType(){return this._rtcType}on(e,t){let n=t;"ertc"===this._rtcType?("throwStreamNetworkState"===e&&(n=async e=>{var n;let r=e;return!r.closed&&null!==(n=this._vcsConnectIdMapErtcPluginHandle)&&void 0!==n&&n[r.id]&&(r=await this._replaceConnectionStateState(r,this._vcsConnectIdMapErtcPluginHandle[r.id])),t(r)}),"onPeerSharingScreenStart"===e&&(n=e=>{if(null!=e&&e.isFromStreamAdded||e.id===this._vcsIns.getAccount().id)return t(e);this._ertcIns.logger.log("onPeerSharingScreenStart 事件被拦截，此次事件不是由stream-added触发")}),"onRoomMemberInfoChange"===e&&(n=e=>(e.persons=this._replacePersons(e.persons),t(e))),this._vcsIns.on(e,n)):this._vcsIns.on(e,n)}_listenVcsBeforeEnterRoomEvent(){var e=this;this._vcsIns.once("onSelfAccountChange",function(){for(var t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];e._vcsBeforeEnterRoomEventTransactions.onSelfAccountChange=n})}_triggerVcsBeforeEnterRoomEvent(){Object.entries(this._vcsBeforeEnterRoomEventTransactions).forEach(e=>{let[t,n]=e;this._vcsIns.eventBus.emit(t,...n),delete this._vcsBeforeEnterRoomEventTransactions[t]})}_replacePersons(e){this._ertcIns.logger.log("vcsPersons转换前数据：",e);const t=n.cloneDeep(e);return null==t||t.forEach(e=>{var t;const n=null===(t=this._ertcIns.usersInstance)||void 0===t?void 0:t.query({id:e.id});n&&this._replacePerson(e,n)}),t}_replacePerson(e,t){return e.id!==this._vcsIns.getAccount().id&&(e.vstate=null!=t&&t.vstate?0:1,e.astate=null!=t&&t.astate?0:1,this._vcsIns.roomInfo.checkPeer(e.id)&&this._vcsIns.roomInfo.getVideoState(e.id)!==e.vstate&&this._vcsIns.roomInfo.setVideoState(e.id.toString(),e.vstate),this._vcsIns.roomInfo.checkPeer(e.id)&&this._vcsIns.roomInfo.getAudioState(e.id)!==e.astate&&this._vcsIns.roomInfo.setAudioState(e.id.toString(),e.astate)),e}_replaceConnectionStateState(e,t){return new Promise(n=>{var r;const s=e;null===(r=t.pluginHandle)||void 0===r||null===(r=r.webrtcStuff)||void 0===r||null===(r=r.pc)||void 0===r||r.getStats().then(e=>{e.forEach(e=>{if("candidate-pair"===e.type&&(s.candidateState=e.state),"transport"===e.type&&(s.dtlsState=e.dtlsState),"media-source"===e.type&&e.audioLevel&&-1!=e.audioLevel&&(s.audioLevel=e.audioLevel),e.audioLevel&&-1!=e.audioLevel&&(s.audioLevel=e.audioLevel),"inbound-rtp"===e.type){s.type=e.mediaType,s.keyFramesDecoded=e.keyFramesDecoded;const n=e.packetsReceived-t.packetsReceived,r=e.nackCount-t.nackCount,o=r/(n+r),i=(e.packetsLost-t.packersLost)/n,a=e.bytesReceived-t.bytesReceived;s.keyFramesDecodedGap=e.keyFramesDecoded-t.keyFramesDecoded,s.afterPackersLost=i||0,s.beforePackersLost=o||0,s.packetsReceived=e.packetsReceived,s["bytesReceived/s"]=a/1024/2,t.keyFramesDecoded=e.keyFramesDecoded,t.nackCount=e.nackCount,t.packetsReceived=e.packetsReceived,t.packersLost=e.packetsLost,t.bytesReceived=e.bytesReceived}if("outbound-rtp"===e.type){s.keyFramesEncoded=e.keyFramesEncoded,s.packetsSent=e.packetsSent;const n=e.bytesSent-t.bytesSent;s["bytesSent/s"]=n/1024/2*8,t.packetsSent=e.packetsSent,t.bytesSent=e.bytesSent}}),n(s)})})}_resetRoomStatus(){this._rtcType=null,this._transactions={}}_addErtcReconnect(e){if(this._ertcIns.logger.log("add ertc reconnect"),this._transactions.ertc_reconnect){const t=this._transactions.ertc_reconnect.bind(this);this._transactions.ertc_reconnect=()=>{t(),e()}}else this._transactions.ertc_reconnect=e.bind(this)}}function ne(e,t,n,r){return new(n||(n=Promise))(function(s,o){function i(e){try{c(r.next(e))}catch(e){o(e)}}function a(e){try{c(r.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(i,a)}c((r=r.apply(e,t||[])).next())})}d(te,"EVENT",{}),"function"==typeof SuppressedError&&SuppressedError;class re{constructor(e){this.sign="",this.sign=e||"Finger"}success(e,t){return this.print("success",e,t)}info(e,t){return this.print("info",e,t)}warn(e,t){return this.print("warn",e,t)}error(e,t){return this.print("error",e,t)}wsSignalError(e,t,n,r,s=!0){s&&this.error("code: "+e+"\nmessage: "+t+"\nfileName: "+n+"\nmethodName: "+r);return{code:e,message:t,fileName:n,methodName:r}}print(e,t,n){n?this.debug&&window.log(`[${this.sign}]`,n):this.debug}}const se=new re("WSSignalingRequest");se.debug=!0;let oe={prefix:"",reRequestQuery:{userID:"",serv:"",conf:"",token:"",amixer:!1}};function ie(e,t,n){oe.prefix=e.prefix?e.prefix:oe.prefix,n&&(oe.prefix=n),t&&(oe.reRequestQuery.userID=t.userID,oe.reRequestQuery.serv=t.serv,oe.reRequestQuery.conf=t.conf,oe.reRequestQuery.token=t.token,oe.reRequestQuery.amixer=t.amixer);let r="";if(e.data&&"object"==typeof e.data){let t=Object.keys(e.data);r=t.reduce((t,n)=>"amixer"===n?`${t}${n}=${e.data[n]?1:0}\r\n`:`${t}${n}=${e.data[n]}\r\n`,"")}else r=e.data;let s="";if(e.params){let t=Object.keys(e.params).filter(t=>null!==e.params[t]&&void 0!==e.params[t]);s=t.map(t=>`${t}=${e.params[t]}`).join("&")}return new Promise((t,n)=>{try{fetch(`${oe.prefix}${e.path}${s?"?"+s:""}`,{headers:Object.assign({"Content-Type":"application/json"},null==e?void 0:e.headers),method:e.method,body:r}).then(e=>e.json()).then(r=>{0!==r.code&&console.error("信令请求失败:",`${oe.prefix}${e.path}${s?"?"+s:""}`,r),-2002!=r.code||e.path.includes("hangup")||e.path.includes("free")?t(r):ie({path:`/create/${oe.reRequestQuery.userID}`,method:"POST",data:{serv:oe.reRequestQuery.serv,conf:oe.reRequestQuery.conf,token:oe.reRequestQuery.token,amixer:oe.reRequestQuery.amixer&&1},prefix:e.prefix}).then(()=>ne(this,void 0,void 0,function*(){const n=yield ie(e);t(n)})).catch(e=>{n(e)})}).catch(e=>{const t=se.wsSignalError(1,"request error: "+e,"WSSignalingRequest","request");n(t)})}catch(e){n(e)}})}let ae={userID:""};class ce{constructor(){}static createIceProxy(e){return new Promise(t=>{ae.userID=e.userID;const n=`/free/${ae.userID}`;fetch(`${e.prefix}${n}`,{headers:{"Content-Type":"application/json"},method:"POST"}).finally(()=>{const n=ie({path:`/create/${ae.userID}`,method:"POST",data:{serv:e.serv,conf:e.conf,token:e.token,amixer:e.amixer},prefix:e.prefix},{userID:e.userID,serv:e.serv,conf:e.conf,token:e.token,amixer:e.amixer});t(n)})})}static freeIceProxy(e,t){return ie({path:`/free/${ae.userID}`,method:"POST"},e,t)}static requestOffer(e,t=0,n=0,r="error"){const s=["video","audio",void 0,"multi_audio"][n],o={mode:e?"sendonly":"recvonly"};return s&&(o.type=s),console.log("请求Offer","SignalingState.userID",ae.userID,"session",r),ie({path:`/offer/${ae.userID}`,method:"POST",params:{peer:e,track:t,session:r},data:o})}static sendAnswer(e,t,n="error"){const r={peer:e,session:n};return ie({path:`/answer/${ae.userID}`,method:"POST",params:r,data:t})}static hangup(e=0,t="error"){const n={peer:e};return ie({path:`/hangup/${ae.userID}`,method:"POST",params:{session:t},data:n})}static switchTrack(e=0,t,n="error"){return ie({path:`/setting/${ae.userID}`,method:"POST",params:{peer:e,session:n},data:JSON.stringify({type:"track",setting:{track:t}})})}static settingMCU(e=0,t,n="error"){let r;return r=0===t?"0x01":1===t?"0x02":"0x04",ie({path:`/setting/${ae.userID}`,method:"POST",params:{peer:ae.userID,session:n},data:JSON.stringify({type:"deftrack",setting:{mmask:r}})})}static mediaStateChange2(e,t,n="error"){const r={};return e>-1&&(r.audio=e),t>-1&&(r.video=t),console.log("媒体状态变更",r),ie({path:`/setting/${ae.userID}`,method:"POST",params:{peer:ae.userID,session:n},data:JSON.stringify({type:"media",setting:Object.assign({},r)})})}static mediaStateChange(e,t,n="error"){return ie({path:`/setting/${ae.userID}`,method:"POST",params:{peer:ae.userID,session:n},data:JSON.stringify({type:"media",setting:{audio:e,video:t}})})}static getUserID(){return ae.userID}static getCdnUrl(e){return C({url:`${oe.prefix}/api/v3/ertc/live/audience/info`,method:"POST",data:{customId:e.customId,subCustomIds:e.subCustomIds,appId:e.appId,strRoomId:e.strRoomId,cdnStreamTypes:e.cdnStreamTypes,cdnPlatformAbility:1},headerOptions:{accessToken:e.accessToken}})}}const de=new re("WSPeerConnection");var le;de.debug=!0,function(e){e[e.Video=0]="Video",e[e.Audio=1]="Audio",e[e.Audio_Video=2]="Audio_Video",e[e.Multi_Audio=3]="Multi_Audio",e[e.Screen_Video=4]="Screen_Video"}(le||(le={}));class ue{constructor(e,t,n=0,r,s,o,i,a,c,d,l,u,h){this.descOption=t,this._id=o,this._peerID=e,this._stream=s,this._trackID=n,this._preTrackId=null,this._offerType=r,this.SDKNO=i,this.cdnPrefix=a,this.cdnUrl=null,this.packetsReceived=0,this.nackCount=0,this.packersLost=0,this.keyFramesDecoded=0,this.QosValue=0,this.bytesReceived=0,this._event_signaling_change=c,this._event_network_change=d,this.person=l,this.createTime=new Date,this.ertcParams=u,this.cdnStreamTypes=h}setReconnectCb(e){this.reconnectCb=e}setGetAccount(e){this.getAccount=e}setDisconnectCb(e){this.disconnectCb=e}setUserStreamTrackCb(e){this.userStreamTrackCb=e}connect(e){if(this._peerConnection=this._createPeerConnection(this._peerID),this.userStreamTrackCb(this.person,this._offerType,{text:"连接对等端 ",desc:"连接对等端"}),this._peerID)this._peerConnection.ontrack=e=>{this.userStreamTrackCb(this.person,this._offerType,{text:"PeerConnection绑定轨道",desc:`PeerConnection绑定轨道：${this._stream.id}`}),this._stream.addTrack(e.track)};else{if(!this._peerConnection||!this._stream)throw de.wsSignalError(2,"create RTCPeerConnection error: no RTCPeerConnection or MediaStream.","WSPeerConnection","constructor");this._bindStream(this._stream)}return new Promise((t,n)=>ne(this,void 0,void 0,function*(){return e&&"closed"===e.state?n("4 已经停止拉流"):(e&&"normal"===e.state&&e.setTask(!0,"beforeRequestOffer"),this.userStreamTrackCb(this.person,this._offerType,{text:"请求offer",desc:" 请求offer"}),this._peerConnection.onicecandidate=e=>{if(e)try{console.log("this._peerConnection.onicecandidate",this.descOption.desc,this.person?this.person.nickname:"没有person","本地端口",e.candidate.port)}catch(e){}},console.log("请求offer, ",this.descOption.desc,this.person?this.person.nickname:"没有person"),ce.requestOffer(this._peerID,this._trackID,this._offerType,this._id).then(r=>ne(this,void 0,void 0,function*(){console.log("请求offer返回, ",this._offerType,this.descOption.desc,r),this.userStreamTrackCb(this.person,this._offerType,{text:"请求offer返回",desc:` 请求offer返回, ${r.sdp}`});const s=r.sdp;if(this._offerType!==le.Audio_Video&&this._offerType!==le.Video&&this._offerType!==le.Screen_Video||(yield ce.settingMCU(this._peerID,this._trackID,this._id)),!s||!s.startsWith("v="))return void setTimeout(()=>this._reconnect(t,n),300);const o=new RTCSessionDescription({sdp:s,type:"offer"});if(e&&"closed"===e.state)return n("5已经调用停止推流");e&&"normal"===e.state&&e.setTask(!0,"beforeSetRemoteDescription"),this._peerConnection.setRemoteDescription(o).then(()=>ne(this,void 0,void 0,function*(){return e&&"closed"===e.state?n("6已经调用停止推流"):(e&&"normal"===e.state&&e.setTask(!0,"beforeCreateAnswer"),yield this._peerConnection.createAnswer())})).then(t=>(this.userStreamTrackCb(this.person,this._offerType,{text:"设置本地description",desc:` 设置本地description, ${t}`}),e&&"closed"===e.state?n("7已经调用停止推流"):(e&&"normal"===e.state&&e.setTask(!0,"beforeSetLocalDescription"),this._peerConnection.setLocalDescription(t)))).then(()=>e&&"closed"===e.state?n("8已经调用停止推流"):(e&&"normal"===e.state&&e.setTask(!0,"beforeOniceconnectionstatechange"),this._peerConnection?(console.log("绑定事件",this.descOption.desc),this.userStreamTrackCb(this.person,this._offerType,{text:"注册事件监听",desc:" 注册事件监听"}),void(this._peerConnection.oniceconnectionstatechange=r=>{var s;if(this._peerConnection?this.userStreamTrackCb(this.person,this._offerType,{text:`触发oniceconnectionstatechange事件，iceConnectionState: ${this._peerConnection.iceConnectionState}`,desc:`触发oniceconnectionstatechange事件，iceConnectionState: ${this._peerConnection.iceConnectionState}`}):this.userStreamTrackCb(this.person,this._offerType,{text:"触发oniceconnectionstatechange事件，this._peerConnection不存在了",desc:"触发oniceconnectionstatechange事件，this._peerConnection不存在了"}),!this._peerConnection)return n("this._peerConnection不存在");if(e&&"closed"===e.state)return n("9已经调用停止推流");if(e&&"normal"===e.state&&e.setTask(!0,"oniceconnectionstatechangeing"),de.info(`connectionID: ${this._id} stream_id: ${this._peerID?this._peerID:"self"} ice connection state chanage`,this._peerConnection.iceConnectionState),"disconnected"!=this._peerConnection.iceConnectionState&&"closed"!=this._peerConnection.iceConnectionState&&"failed"!=this._peerConnection.iceConnectionState&&"new"!=this._peerConnection.iceConnectionState||(console.log("流媒体连接断开",this.person?this.person.nickname:"",this.descOption.desc,this._peerConnection.iceConnectionState),this.disconnectCb&&this.disconnectCb(this),de.warn(`开启重连倒计时。${this._peerID}`),this._clearReconnectTimer(),this._reconnectTimer=setTimeout(()=>{console.log("调用重连 this._peerConnection.iceConnectionState",this._peerConnection.iceConnectionState),this._reconnect(t,n)},5e3)),"connected"==this._peerConnection.iceConnectionState){if(this.reconnectCb&&this.reconnectCb(this),this._clearReconnectTimer(),e&&"closed"===e.state)return e.setTask(!1,"close"),n("10已经调用停止推流");e&&"normal"===e.state&&e.setTask(!0,"beforeOniceconnectionstatechange"),this.startConnectTime=(new Date).getTime(),ce.sendAnswer(this._peerID,null===(s=this._peerConnection.localDescription)||void 0===s?void 0:s.sdp,this._id).then(()=>{this.userStreamTrackCb(this.person,this._offerType,{text:"发送Answer",desc:" 发送Answer"}),this._signaling_change_Timer&&clearInterval(this._signaling_change_Timer),this._signaling_change_Timer=setInterval(()=>ne(this,void 0,void 0,function*(){this._peerConnection&&this._peerConnection.iceConnectionState,this._getSignalingState()}),2e3),setTimeout(()=>{this._peerConnection&&this._peerConnection.getStats().then(e=>{e.forEach(e=>{"remote-candidate"===e.type&&console.log(this.descOption.desc,"远端端口信息:",e.port,"服务地址",e.address)})})},2e3),this.QosTimer&&(console.log("清理Qostimer333",this.descOption),clearInterval(this.QosTimer),this.QosTimer=null,console.log("修改了QosValue值 1"),this.QosValue=0);const e=this;return this.QosTimer=setInterval(()=>ne(this,void 0,void 0,function*(){he(this.descOption.desc,this._peerConnection).then(t=>{e.descOption.desc,e.QosValue===t?"pullPeerMixerAudioStream"===e.descOption.desc||"pullPeerScreenStream"===e.descOption.desc||"pullPeerVideoStream"===e.descOption.desc||"publishSelfVideo"!==e.descOption.desc&&"publishSelfScreen"!==e.descOption.desc||e._stream.getTracks().forEach(t=>{e.userStreamTrackCb(e.person,e._offerType,{text:"调用轨道关闭",desc:`调用轨道关闭: track.onended:${t.onended}`}),t.stop(),t.onended&&(t.onended({customerType:"noFrame"}),console.log("清理Qostimer",this.descOption,this.person),clearInterval(e.QosTimer),e.QosTimer=null,e.QosValue=0)}):t>=0&&(e.QosValue=t)})}),6e4),"publishSelfAudio"===this.descOption.desc&&this._peerConnection.getSenders().forEach(e=>{try{const t=e.getParameters();t.encodings&&0!==t.encodings.length||(t.encodings=[{}]),t.encodings[0].priority="high",e.setParameters(t),console.log("设置发音频优先级成功, ",t)}catch(e){console.error("设置发音频优先级失败, ",e)}}),setTimeout(()=>{},500),t()}).catch(e=>{const t=de.wsSignalError(3,"SDP协商错误 : "+e,"WSPeerConnection","connect");return n(t)})}})):n("this._peerConnection不存在"))).catch(e=>{throw console.error("拉流失败",e),e})})).catch(e=>{console.error("-------ws--peer---",e),setTimeout(()=>{this._reconnect(t,n)},300),t()}))}))}connectCDN(){return ne(this,void 0,void 0,function*(){const e=1===this._offerType?"audio":"video";let t;if(t="audio"===e?`vcs_a_room_${this.SDKNO}`:`vcs_v_user_${this.SDKNO}_${this._peerID}_${this._trackID}`,this._peerConnection=this._createPeerConnection(this._peerID),!this._peerID){if(console.log("根本走不进来吧"),!this._peerConnection||!this._stream)throw de.wsSignalError(2,"create RTCPeerConnection error: no RTCPeerConnection or MediaStream.","WSPeerConnection","constructor");this._bindStream(this._stream)}return new Promise((n,r)=>ne(this,void 0,void 0,function*(){this._peerConnection.addTransceiver(e,{direction:"recvonly"}),this._peerConnection.addEventListener("negotiationneeded",()=>{this.connectPC(t).catch(e=>{r(e)})});const s=this._peerConnection,o=this._stream;this._peerConnection.ontrack=e=>{o&&(o.addTrack(e.track),e.streams[0].onremovetrack=e=>{console.info(`onremovetrack: ${e.track.kind} track removed`,e.track,o),o.removeTrack(e.track)})};const i=this;this._peerConnection.onconnectionstatechange=e=>{switch(s.connectionState){case"disconnected":case"failed":case"closed":console.info(`拉流${t} 断开`),console.log("ICE connection error:",s),i._clearReconnectTimer(),i._reconnectTimer=setTimeout(()=>{console.log("触发 重连---"),i._reconnect(n,r)},5e3);break;case"connected":console.info(`cdn拉流----${t} 已连接`),i.descOption&&(i._signaling_change_Timer&&clearInterval(i._signaling_change_Timer),i._signaling_change_Timer=setInterval(()=>ne(this,void 0,void 0,function*(){i._getSignalingState()}),2e3)),i.QosTimer&&(console.log("清理Qostimer333",i.descOption),clearInterval(i.QosTimer),i.QosTimer=null,console.log("修改了QosValue值2"),i.QosValue=0),i.QosTimer=setInterval(()=>ne(this,void 0,void 0,function*(){he(i.descOption.desc,i._peerConnection).then(e=>{i.QosValue===e?"pullPeerMixerAudioStream"===i.descOption.desc||"pullPeerVideoStream"===i.descOption.desc?console.log("拉流时，10秒，无数据，触发重连",i.descOption,i.person):"publishSelfAudio"!==i.descOption.desc&&"publishSelfVideo"!==i.descOption.desc&&"publishSelfScreen"!==i.descOption.desc||i._stream.getTracks().forEach(e=>{console.log("调用track 的end",i.descOption),e.stop(),e.onended&&(i.userStreamTrackCb(i.person,i._offerType,{text:"调用轨道关闭",desc:`调用轨道关闭: track.onended:${e.onended}`}),e.onended({customerType:"noFrame"}),console.log("清理Qostimer",i.descOption,i.person),clearInterval(i.QosTimer),i.QosTimer=null)}):i.QosValue=e})}),6e4),n()}}}))})}disconnect(e=!1){if(console.log("断连对等端 ",this.descOption.desc,this.person?this.person.nickname:""),this.userStreamTrackCb(this.person,this._offerType,{text:"断连对等端",desc:"断连对等端"}),(new Date).getTime(),this.keyframeTimer&&(clearTimeout(this.keyframeTimer),this.keyframeTimer=null),this.QosTimer&&(console.log("清理Qostimer222",this.descOption,this.person),clearTimeout(this.QosTimer),this.QosTimer=null,console.log("修改了QosValue值 3"),this.QosValue=0),this._event_signaling_change){const e={id:this._id,closed:!0};this._event_signaling_change(e)}return this.cdnPrefix?new Promise(t=>(clearInterval(this._signaling_change_Timer),this._clearStream(e),this._peerConnection?(this._peerConnection.close(),this._peerConnection=void 0,this._senders=void 0,t()):t())):new Promise(t=>{ce.hangup(this._peerID,this._id).then(()=>{this.userStreamTrackCb(this.person,this._offerType,{text:"断连对等端成功",desc:"断连对等端成功"})}).finally(()=>(clearInterval(this._signaling_change_Timer),this._clearStream(e),this._peerConnection?(this._peerConnection.close(),this._peerConnection=void 0,this._senders=void 0,this.userStreamTrackCb(this.person,this._offerType,{text:`断连对等端成功后，清理流，关闭peerConnection， this._peerConnection ${this._peerConnection}`,desc:`断连对等端成功后，清理流，关闭peerConnection， this._peerConnection ${this._peerConnection}`}),de.info(`销毁一个PeerConnection connectionID: ${this._id} stream_id: ${this._peerID?this._peerID:"self"}`),t()):t()))})}switchTrack(e){return ne(this,void 0,void 0,function*(){return console.log("切流switchTrack",e),this.userStreamTrackCb(this.person,this._offerType,{text:`切换轨道 轨道：${e}`,desc:`切换轨道 轨道：${e}`}),this.cdnPrefix?(yield this.disconnect(!0),this._trackID=e>0?1:e,void(yield this.connectCDN())):new Promise((t,n)=>{ce.switchTrack(this._peerID,e,this._id).then(()=>(this.userStreamTrackCb(this.person,this._offerType,{text:`切换轨道成功 轨道：${e}`,desc:`切换轨道成功 轨道：${e}`}),this._trackID=e,t())).catch(e=>n(e))})})}mediaStateChange(e,t){return this.userStreamTrackCb(this.person,this._offerType,{text:`通知信令媒体状态 audioState: ${e}, videoState: ${t}`,desc:`通知信令媒体状态 audioState: ${e}, videoState: ${t}`}),ce.mediaStateChange(e,t,this._id)}getPeerConnectionID(){return this._id}getPeerID(){return this._peerID}_createPeerConnection(e){if(this._peerConnection)return this._peerConnection;let t=new RTCPeerConnection({});return de.info(`创建一个PeerConnection: connectionID: ${this._id} stream_id: ${this._peerID?this._peerID:"self"},类型：${this.descOption.desc}`),t}_reconnect(e,t){console.log("触发重连",this.descOption.desc,new Date,this.person?this.person.nickname:""),this.userStreamTrackCb(this.person,this._offerType,{text:"触发重连",desc:"触发重连"}),this.QosTimer&&(console.log("触发重连,关闭质量监测的时间函数",this.descOption),clearInterval(this.QosTimer),this.QosTimer=null,this.QosValue=0),this._peerConnection?this.disconnect(!0).finally(()=>ne(this,void 0,void 0,function*(){(this.cdnPrefix?this.connectCDN.bind(this):this.connect.bind(this))().then(()=>{if(console.log("this.descOption.desc",this.descOption.desc),"publishSelfAudio"===this.descOption.desc||"publishSelfVideo"===this.descOption.desc||"publishSelfScreen"===this.descOption.desc){console.log("获取account信息",this.getAccount());const{vstate:e,astate:t}=this.getAccount();this.mediaStateChange(t,e)}0!=this._trackID&&"pullPeerScreenStream"!==this.descOption.desc&&this.switchTrack(this._trackID),this._clearReconnectTimer(),console.log("重连成功 执行 , this.reconnectCb",this),this.reconnectCb&&this.reconnectCb(this),de.success(`重连成功 peerID: ${this._peerID} , 类型: ${this.descOption.desc}`,this.person),e()}).catch(n=>{console.error("重连失败",n),this.userStreamTrackCb(this.person,this._offerType,{text:"触发重连失败",desc:"触发重连失败"}),console.error(`重连失败 peerID: ${this._peerID}`,this.person),this._clearReconnectTimer(),this._reconnectTimer=setTimeout(()=>{console.log(`重连失败 peerID: ${this._peerID}`,this.person),this._reconnect(e,t)},5e3),t()})})):console.log("当前流不存在peerConnection，认为已经调用关闭了")}_bindStream(e){this._senders=new Array,e.getTracks().forEach(e=>{const t=this._peerConnection.addTrack(e);this._senders.push(t)})}_clearStream(e=!1){if(this._senders){let e=this._senders.length;for(let t=0;t<e;t++){let e=this._senders.shift();if(e)try{this._peerConnection.removeTrack(e)}catch(e){console.log("清空流报错",e)}}}this._peerID&&this._stream&&this._stream.getTracks().forEach(e=>{this._stream.removeTrack(e)}),!e&&this._stream&&(this._stream=void 0,this._clearReconnectTimer())}_clearReconnectTimer(){this._reconnectTimer&&(clearTimeout(this._reconnectTimer),console.log("清除重连定时器",this.descOption.desc)),this._reconnectTimer=void 0}connectPC(e){return ne(this,void 0,void 0,function*(){var e,t,n;let r=yield this._peerConnection.createOffer();if(yield this._peerConnection.setLocalDescription(r),this.cdnPrefix&&(!this.cdnUrl||this._trackID!==this._preTrackId)){console.log("是cdn拉流，获取cdn拉流地址");const r=1===this.cdnStreamTypes||2===this.cdnStreamTypes,s=1===this._trackID?2:1,o=r?s:this.cdnStreamTypes,i=yield ce.getCdnUrl({customId:this.ertcParams.userId,subCustomIds:this._peerID||null,appId:this.ertcParams.appId,strRoomId:this.ertcParams.roomId,cdnStreamTypes:o,cdnPlatformAbility:1,accessToken:this.ertcParams.accessToken});if(200===(null===(e=null==i?void 0:i.meta)||void 0===e?void 0:e.code)){const e=i.data.cdnEndpoint,r=null===(n=null===(t=i.data.streamInfos)||void 0===t?void 0:t[0])||void 0===n?void 0:n.streamUrls;r&&Object.keys(r).forEach(t=>{this.cdnUrl=`${e}${r[t]}`}),this._preTrackId=this._trackID}}let s=yield fetch(`${this.cdnUrl}`,{method:"POST",headers:{},body:JSON.stringify({version:"v1.0",sessionId:"sidtest",localSdp:r}),mode:"cors"}),o=yield s.json();if(200!=o.code)throw s;if(this._peerConnection)return this._peerConnection.setRemoteDescription(o.remoteSdp)})}_getSignalingState(){this._peerConnection&&this._peerConnection.getStats().then(e=>{if(!this._peerConnection)return void console.log("调用this._peerConnection.getStats()失败, 没有this._peerConnection",this.descOption.desc,this.person?this.person.nickname:"");const t=this._peerConnection.connectionState,n=this._peerConnection.iceConnectionState;"closed"!==t&&"failed"!==t&&"disconnected"!==t&&"closed"!==n&&"disconnected"!==n&&"failed"!==n||(this._peerConnection.oniceconnectionstatechange?(this._peerConnection.oniceconnectionstatechange({}),clearInterval(this._signaling_change_Timer),this._signaling_change_Timer=null):this._peerConnection.onconnectionstatechange?(this._peerConnection.onconnectionstatechange({}),clearInterval(this._signaling_change_Timer),this._signaling_change_Timer=null):console.log("没有注册oniceconnectionstatechange 函数",this.descOption.desc));const r={id:this._id,customType:this.descOption.desc,time:(new Date).getTime(),startConnectTime:this.startConnectTime,connectionState:this._peerConnection.connectionState,iceConnectionState:this._peerConnection.iceConnectionState,person:this.person};e.forEach(e=>{if("candidate-pair"===e.type&&(r.candidateState=e.state),"transport"===e.type&&(r.dtlsState=e.dtlsState),"media-source"===e.type&&e.audioLevel&&-1!=e.audioLevel&&(r.audioLevel=e.audioLevel),e.audioLevel&&-1!=e.audioLevel&&(r.audioLevel=e.audioLevel),"inbound-rtp"===e.type){if(!this.descOption)return;r.type=e.mediaType,r.keyFramesDecoded=e.keyFramesDecoded;const t=e.packetsReceived-this.packetsReceived,n=e.nackCount-this.nackCount,s=n/(t+n),o=(e.packetsLost-this.packersLost)/t,i=e.bytesReceived-this.bytesReceived;if(r.keyFramesDecodedGap=e.keyFramesDecoded-this.keyFramesDecoded,r.afterPackersLost=o||0,r.beforePackersLost=s||0,r.packetsReceived=e.packetsReceived,r["bytesReceived/s"]=i/1024/2,this.keyFramesDecoded=e.keyFramesDecoded,this.nackCount=e.nackCount,this.packetsReceived=e.packetsReceived,this.packersLost=e.packetsLost,this.bytesReceived=e.bytesReceived,"pullPeerScreenStream"!==this.descOption.desc)return}if("outbound-rtp"===e.type){r.keyFramesEncoded=e.keyFramesEncoded,r.packetsSent=e.packetsSent;const t=e.bytesSent-this.bytesSent;r["bytesSent/s"]=t/1024/2*8,this.packetsSent=e.packetsSent,this.bytesSent=e.bytesSent}}),this.userStreamTrackCb(this.person,this._offerType,{text:"传输信息",desc:`${JSON.stringify({pcCandidateState:this._peerConnection?this._peerConnection.connectionState:"未连接",pcIceCandidateState:this._peerConnection?this._peerConnection.iceConnectionState:"未连接",candidateState:r.candidateState,dtlsState:r.dtlsState,icecandidateState:r.icecandidateState})}`}),this._event_signaling_change(r)})}}function he(e,t){return ne(this,void 0,void 0,function*(){if(!t)return console.log(e,"getQoSValue---- 不存在peerConnection 返回了0"),-1;const n="pullPeerMixerAudioStream"===e||"pullPeerVideoStream"===e||"pullPeerScreenStream"===e?"inbound-rtp":"outbound-rtp",r={publishSelfAudio:"packetsSent",publishSelfScreen:"keyFramesEncoded",pullPeerMixerAudioStream:"packetsReceived",pullPeerVideoStream:"keyFramesDecoded",publishSelfVideo:"keyFramesEncoded",pullPeerScreenStream:"keyFramesDecoded"};return new Promise((s,o)=>{t.getStats().then(t=>{let o=-1,i=0;return t.forEach(t=>{t.type===n&&(i++,o=t[r[e]])}),0===i&&console.log("getQoSValue---- 没有取导数据，返回了0"),s(o)})})})}const me=new re("WSSignaling");var ge;me.debug=!0,function(e){e[e.Video=0]="Video",e[e.Audio=1]="Audio",e[e.Audio_Video=2]="Audio_Video",e[e.Multi_Audio=3]="Multi_Audio",e[e.Screen_Video=4]="Screen_Video"}(ge||(ge={}));class ve{constructor(e,t){this.smallScreenPersons=[],this.connections={},String.prototype.hashCode=function(){if(Array.prototype.reduce)return this.split("").reduce(function(e,t){return(e=(e<<5)-e+t.charCodeAt(0))&e},0);var e=0;if(0===this.length)return e;for(var t=0;t<this.length;t++){e=(e<<5)-e+this.charCodeAt(t),e&=e}return e},t&&console.log("未启用代理");const n=s.v4(),r=e.userID,o=e.conf;this.roomNo=e.roomNo,this.SDKNO=e.conf,this.cdnPrefix=e.cdnPrefix;const i=e.amixer;this._confuuid=n+r+o+i,oe.prefix=e.prefix,this.smallScreenPersons=[],this.ertcParams=e.ertcParams}syncStream(e){this.smallScreenPersons=e}connect(e){return ne(this,arguments,void 0,function*({peerID:e,track:t=0,offerType:n,stream:r,isScreen:s=!1,descOption:o={desc:""},person:i,progress:a,cdnStreamTypes:c}){return new Promise((d,l)=>ne(this,void 0,void 0,function*(){n==ge.Video||ge.Screen_Video;const u=String(Math.abs((String(e)+String(t)+String(n)+this._confuuid+String(s?"screen":"normal")).hashCode()));ve.event_user_stream_track(i,n,{desc:`调用信令连接: peerID:${e} track: ${t}, connectionID:${u}, 连接方式${o.desc}, cdn: ${this.cdnPrefix}, SDKNO:${this.SDKNO}`,text:"调用信令连接"});let h=new ue(e,o,t,n,r,u,this.SDKNO,this.cdnPrefix,ve.event_signaling_change,()=>{},i,this.ertcParams,c);if(h.setReconnectCb(ve.event_reconnect_signaling),h.setDisconnectCb(ve.event_disconnect_signaling),h.setGetAccount(ve.event_get_account),h.setUserStreamTrackCb(ve.event_user_stream_track),a&&"closed"===a.state)return d("3.1已经停止拉流");a&&"normal"===a.state&&a.setTask(!0,"beforeSignalingInsDisConnect",{connectionID:u}),this.disconnect(u,!0).then(e=>{}).catch(e=>{}).finally(()=>{if(a&&"closed"===a.state)return d("3已经停止拉流");a&&"normal"===a.state&&a.setTask(!0,"beforeConnect");const r=h.getPeerConnectionID();this.connections[r]=h,this.cdnPrefix?h.connectCDN().then(()=>d(r)).catch(e=>(h.disconnect(),l(e))):h.connect(a).then(()=>d(r)).catch(r=>(ve.event_user_stream_track(i,n,{desc:`调用信令连接失败: error:${r}`,text:`调用信令连接失败: peerID:${e} track: ${t}, connectionID:${u}, 连接方式${o.desc}, cdn: ${this.cdnPrefix}, SDKNO:${this.SDKNO}`}),h.disconnect(),l(r)))})}))})}disconnect(e,t){return new Promise((n,r)=>{const s=this.connections[e];if(!s)return n();console.log("断开连接,id:",e,"类型",s.descOption.desc,"关闭用户：",s.person?s.person.nickname:"self"),s.disconnect().then(()=>(console.log("delete this.connections[cpID]; ",this.connections,e),t&&s&&s._reconnectTimer&&(clearTimeout(s._reconnectTimer),s._reconnectTimer=null),delete this.connections[e],n())).catch(e=>{console.error("peerConnection.disconnect() error: ",e)})})}freeSignaling(){console.log("释放ICE代理",this.connections);const e=Object.keys(this.connections);for(let t of e)this.disconnect(t,!0);this.timer&&(this.smallScreenPersons=[],clearImmediate(this.timer)),setTimeout(()=>{ce.freeIceProxy()},800)}switchTrack(e,t){return new Promise((n,r)=>{if(!this.connections[e]){const e=me.wsSignalError(8,"switch track is not connect.","WSSignaling","disconnect");return r(e)}this.connections[e].switchTrack(t).then(()=>{n()}).catch(e=>{r(e)})})}getUserID(){return ce.getUserID()}mediaStateChange(e=0,t,n){for(let e in this.connections)this.connections[e].getPeerID()||this.connections[e].mediaStateChange(t?1:0,n?1:0)}mediaStateChangeByPeerID(e=0,t,n){const r=this.connections[e];if(r&&!r.getPeerID())return r.mediaStateChange(t?1:0,n?1:0)}getConnections(){return this.connections}}const pe=T.proxy({name:"MRTC"}),fe=function(){let e={};return e.promise=new Promise((t,n)=>{e.resolve=t,e.reject=n}),e};class _e{constructor(e){return this._drtcIns=r.createClient(),this._vcsIns=e.vcsIns,this._rtcType=localStorage.getItem("mrtc-rtcType")||null,this._globalParams=e,this._enterRoomParams={},this._transactions={},this._role=null,this._vcsBeforeEnterRoomEventTransactions={},this._mqttNetworkState=null,this._drtcNetworkState=null,this._localVideoTrack=null,this._localAudioTrack=null,this._localScreenVideoTrack=null,this._remoteMixAudioStream=null,this._remoteMixAudioTrack=null,this._remoteScreenStream=null,this._remoteScreenTrack=null,this._remoteUserStreams={},this._remoteUserTracks={},this._remoteUserMicMuted={},this._drtcMediaReconnectFailTrackIds=[],this._initFunction(),this._resetVcsFunction(),this._initDrtcEvent(),r.setClientConfig({audioSFU:!1}),this._drtcIns.setRemoteDefaultVideoStreamType("low"),new Proxy(this,{get:function(e,t){const n=!(t in e),r="vcs"===e._rtcType,s=["_drtcIns","_vcsIns","_globalParams","_rtcType","_transactions","_vcsBeforeEnterRoomEventTransactions","_mqttNetworkState"].includes(t),o=["_listenVcsBeforeEnterRoomEvent"].includes(t),i=["enterRoom"].includes(t),a=["getRtcType"].includes(t);return s||o||i||a||!n&&!r?e[t]:"function"==typeof e._vcsIns[t]?e._vcsIns[t].bind(e._vcsIns):e._vcsIns[t]},set:function(e,t,n){return!(t in e)?e._vcsIns[t]=n:e[t]=n,!0}})}_initFunction(){}_resetVcsFunction(){var e=this;const t=this._vcsIns.onMqttState.bind(this._vcsIns);this._vcsIns.onMqttState=function(){for(var n=arguments.length,r=new Array(n),s=0;s<n;s++)r[s]=arguments[s];if(pe.log("mqtt状态变化：",r),"mqtt"===r[0]&&"network"===r[1]&&!1===r[2]&&(e._mqttNetworkState="offline"),"mqtt"===r[0]&&"network"===r[1]&&r[2]&&"offline"===e._mqttNetworkState){if(e._mqttNetworkState="online","disconnected"===e._drtcNetworkState)return pe.log("mqtt重连成功，检测到drtc已经disconnected, 直接报错退出"),e._vcsIns.notice(e._globalParams.vcsTypes.NoticeType.imposedExit,"网络连接超时，自动退出"),t(...r);if(e._drtcNetworkState&&"connected"!==e._drtcNetworkState)return pe.log("mqtt重连成功，添加待执行函数，等待drtc重连后执行"),void(e._transactions.mqtt_reconnect=()=>{t&&t(...r)});pe.log("mqtt重连成功，执行drtc重连事务"),setTimeout(e._transactions.drtc_reconnect,500)}return t(...r)}}_initDrtcEvent(){var e=this;["user-published","user-unpublished","user-info-updated","connection-state-change","sub-media-reconnect-started","sub-media-reconnect-succeeded","sub-media-reconnect-failed","pub-media-reconnect-started","pub-media-reconnect-succeeded","pub-media-reconnect-failed","user-mic-audio-muted","network-quality"].forEach(t=>{let r=null;["user-info-updated"].includes(t)&&(r=(e,t,r)=>{if(["mute-video","unmute-video"].includes(t)&&this._vcsIns.getAccount().stream_id!=e&&!r){var s,o;pe.log("mrtc接收到drtc的user-info-updated事件后，要替换视频的用户id：",e);const t=n.cloneDeep(this._vcsIns.getRoom()),r=null===(s=t.persons)||void 0===s?void 0:s.find(t=>t.stream_id===e),i=null===(o=this._drtcIns.remoteUsers)||void 0===o?void 0:o.find(t=>t.userId===e);pe.log(`vcs person.vstate：${r.vstate}`),pe.log(`remoteUser.hasVideo：${i.hasVideo} remoteUser.videoMuted：${i.videoMuted}`),pe.log("mrtc触发vcs视频更新"),this._vcsIns.notice(this._globalParams.vcsTypes.NoticeType.throwRoomMemberInfo,t)}}),["user-published","user-unpublished"].includes(t)&&(r=(e,n,r)=>{if(pe.log(t,`user：${JSON.stringify(e)}, mediaType：${n}, auxiliary：${r}`),"video"===n&&r&&["user-published"].includes(t)){var s;const t=null===(s=this._vcsIns.getRoom().persons)||void 0===s?void 0:s.find(t=>t.stream_id===e.userId);pe.log("mrtc触发vcs屏幕共享"),this._vcsIns.roomInfo.event_startSharingScreen({id:t.id,index:null,type:3,isFromMrtc:!0})}}),["user-mic-audio-muted"].includes(t)&&(r=(e,r)=>{if(this._vcsIns.getAccount().stream_id!=e){var s;pe.log(t,`uid：${e}, muted：${r}`),this._remoteUserMicMuted[e]=r;const o=n.cloneDeep(this._vcsIns.getRoom());null===(s=o.persons)||void 0===s||s.forEach(t=>{if(t.stream_id===e){var n;(null===(n=this._drtcIns.remoteUsers)||void 0===n?void 0:n.find(t=>t.userId===e))&&(pe.log(`vcs person.astate：${t.astate}`),pe.log(`remoteUser muted:${r}`),t.astate=r?1:0,this._vcsIns.roomInfo.setAudioState(t.id.toString(),t.astate))}}),pe.log("mrtc触发vcs音频更新"),this._vcsIns.notice(this._globalParams.vcsTypes.NoticeType.throwRoomMemberInfo,o)}}),["sub-media-reconnect-started","sub-media-reconnect-succeeded","sub-media-reconnect-failed"].includes(t)&&(r=function(){for(var n=arguments.length,r=new Array(n),s=0;s<n;s++)r[s]=arguments[s];if(pe.log(`drtc监听${t}事件：`,r),["sub-media-reconnect-succeeded","sub-media-reconnect-started"].includes(t))try{const n=r[0];var o;if(n===e._remoteMixAudioTrack.trackId)return pe.log("drtc 混音流重连，重新对混音流进行赋值",e._remoteMixAudioTrack.getMediaStreamTrack()),void e._updateStreamTrack(e._remoteMixAudioStream,null===(o=e._remoteMixAudioStream.getAudioTracks())||void 0===o?void 0:o[0],"sub-media-reconnect-succeeded"===t&&e._remoteMixAudioTrack.getMediaStreamTrack());const s=e._drtcIns.remoteUsers.find(e=>e.hasAuxiliary&&e.auxiliaryTrack&&e.auxiliaryTrack.trackId===n),c=e._drtcIns.remoteUsers.find(e=>e.hasVideo&&e.videoTrack&&e.videoTrack.trackId===n);var i,a;if(s)pe.log("远端有屏幕流，drtc重新对屏幕流进行赋值",s.auxiliaryTrack.getMediaStreamTrack()),e._updateStreamTrack(e._remoteScreenStream,null===(i=e._remoteScreenStream.getVideoTracks())||void 0===i?void 0:i[0],"sub-media-reconnect-succeeded"===t&&s.auxiliaryTrack.getMediaStreamTrack());if(c)pe.log(`更新用户${c.userId}的视频流`),e._updateStreamTrack(e._remoteUserStreams[c.userId],null===(a=e._remoteUserStreams[c.userId].getVideoTracks())||void 0===a?void 0:a[0],"sub-media-reconnect-succeeded"===t&&c.videoTrack.getMediaStreamTrack())}catch(e){pe.log("sub-media-reconnect-succeeded/started 报错：",e)}if(["sub-media-reconnect-failed"].includes(t)){const t=r[0];e._drtcMediaReconnectFailTrackIds.push(t)}}),["connection-state-change"].includes(t)&&(r=(e,t,n)=>{pe.log(`drtc连接状态变化，curState：${e} prevState：${t} reason：${n}`),this._drtcNetworkState=e,"connected"===e&&"reconnecting"===t&&("online"===this._mqttNetworkState&&this._transactions.mqtt_reconnect?(pe.log("drtc重连成功，执行mqtt重连事务"),this._transactions.mqtt_reconnect(),delete this._transactions.mqtt_reconnect,setTimeout(this._reconnectEffect.bind(this),500)):(pe.log("drtc重连成功，添加待执行函数，等待mqtt重连后执行"),this._transactions.drtc_reconnect=()=>this._reconnectEffect())),"disconnected"===e&&this._transactions.mqtt_reconnect&&(pe.log("drtc disconnected，且mqtt也已重连，执行报错退出操作"),this._vcsIns.notice(this._globalParams.vcsTypes.NoticeType.imposedExit,"网络连接超时，自动退出"),this._transactions.mqtt_reconnect(),delete this._transactions.mqtt_reconnect)}),["network-quality"].includes(t)&&(r=(e,t)=>{const n={0:"0",1:"4",2:"4",3:"3",4:"2",5:"1",6:"1"};n[e]!==this._lastUplinkNetworkQuality&&(pe.log("netwrok有变化，触发extend_info更新"),this._lastUplinkNetworkQuality=n[e],this._updateExtendInfo({nq:n[e]||"0"}),this._vcsIns.roomClient.heartbeat())}),r&&this._drtcIns.on(t,r)})}enterRoom(e){const t=fe();this._listenVcsBeforeEnterRoomEvent();return this._vcsIns.enterRoom(e.vcsParams.roomOption,e.vcsParams.amixer,e.vcsParams.accountData,e.vcsParams.inviterUid,e.vcsParams.webinar_invitation_link_code).then(n=>{const r=this._vcsIns.getEnterRoomData();pe.log("风远加入房间成功：",n),1===(null==r?void 0:r.rtc_mode)?(this._rtcType="drtc",this._enterRoomParams=e,pe.log("drtc加入房间信息：",e.drtcParams),this._vcsIns.roomClient.heartbeat(),localStorage.setItem("mrtc-enterRoomParams",JSON.stringify(e)),5===r.conf.type&&6===r.role?(pe.log("检测到当前为研讨会，身份是观众，不执行drtc入会"),this._role="audience",this._createSiganling(),t.resolve(n)):this._drtcIns.join(e.drtcParams).then(async e=>{t.resolve(n),setTimeout(()=>{this._triggerVcsBeforeEnterRoomEvent(),this._connectEffect(),this._joinEffect()},1e3),pe.log("drtc加入房间成功",this._drtcIns)}).catch(e=>{this.leave(),t.reject({code:"100001",msg:e.message||e})})):(this._rtcType="vcs",t.resolve(n)),localStorage.setItem("mrtc-rtcType",this._rtcType),pe.log(`当前会议类型：${this._rtcType}`,r)}).catch(t.reject),t.promise}leave(){const e=fe(),t=this._vcsIns.leave(),n=this._drtcIns.leave();return this._resetRoomStatus(),Promise.all([t,n]).then(t=>{e.resolve(!0)}).catch(e.reject),e.promise}refreshRoom(){pe.log("进入 refreshRoom 函数");const e=fe(),t=this._vcsIns.refreshRoom(),n=this._vcsIns.enterRoomLoading||this._vcsIns.enterRoomData&&this._vcsIns.enterRoomData.room;return t.then(t=>{if(n)return void e.resolve(t);const r=JSON.parse(localStorage.getItem("mrtc-enterRoomParams")),s=this._vcsIns.getEnterRoomData();if(this._enterRoomParams=r,5===s.conf.type&&6===s.role)return pe.log("研讨会 & 观众，refreshRoom之后不执行drtc入会"),this._role="audience",this._createSiganling(),void e.resolve(t);pe.log("refreshRoom刷新房间，drtc重新入会，参数：",r.drtcParams),this._drtcIns.join(r.drtcParams).then(async n=>{e.resolve(t),setTimeout(()=>{this._connectEffect(),this._joinEffect()},500)}).catch(t=>{this.leave(),e.reject({code:"100001",msg:`drtc入会失败：${t.message||t}`})})}).catch(e.reject),e.promise}_rejoin(){const e=JSON.parse(localStorage.getItem("mrtc-enterRoomParams"));this._localScreenVideoTrack&&(this._localScreenVideoTrack.close(),this._localScreenVideoTrack=null,this._vcsIns.setScreenEnable(!1,2)),this._drtcIns.join(e.drtcParams).then(async e=>{this._connectEffect(),this._rejoinEffect()}).catch(e=>{this.leave()})}publishSelfVideo(){var e;let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;pe.log("进入 publishSelfVideo 函数");const n=fe();if(2==this._vcsIns.controlsAccount.video_state){const e=this._vcsIns.vcsErr.throwErr(707,`推流失败${t}：视频权限被主持人禁用。`,"publishSelfVideo");return Promise.reject(e)}const s=this._vcsIns.videoStreams[t]?null===(e=this._vcsIns.videoStreams[t])||void 0===e?void 0:e.streamID:void 0;if(!s){const e=this._vcsIns.vcsErr.throwErr(9001,`推流失败${t}：流编号错误。`,"publishSelfVideo");return Promise.reject(e)}return this._vcsIns.media.getStream(s).then(async e=>{this._localVideoTrack=await r.createCustomVideoTrack({mediaStreamTrack:e.getVideoTracks()[0]}),this._drtcIns.publish(this._localVideoTrack).then(r=>{const o=P(12);this._vcsIns.videoStreams[t]&&(this._vcsIns.videoStreams[t].connectID=o),this._vcsIns._updateSocket_addVideoTrack(t),this._vcsIns.notice(this._globalParams.vcsTypes.NoticeType.peerPublish,{account:this._vcsIns.account,srcObject:e}),this._vcsIns.controlsAccount.connections||(this._vcsIns.controlsAccount.connections=new Array),this._vcsIns.controlsAccount.connections.push({connectID:o,streamID:s,index:t,type:this._globalParams.vcsTypes.IFConnectionType.Video,stream:e}),this._updateExtendInfo({vd:"1"}),this._vcsIns.roomClient&&setTimeout(()=>{this._vcsIns.roomClient.heartbeat()},500),n.resolve(e)}).catch(e=>{n.reject(e.message||e)})}),n.promise}stopPublishSelfVideo(){var e;let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;pe.log("进入 stopPublishSelfVideo 函数");const n=fe();this._vcsIns.controlsAccount&&(this._vcsIns.controlsAccount.video_state=1);const r=null===(e=this._vcsIns.videoStreams[t])||void 0===e?void 0:e.connectID;return r?(this._localVideoTrack.setMuted(!0),this._drtcIns.unpublish(this._localVideoTrack).then(e=>{var s;null===(s=this._localVideoTrack)||void 0===s||s.close(),this._localVideoTrack=null,this._vcsIns._updateSocket_removeVideoTrack(t),this._vcsIns.videoStreams[t]&&(this._vcsIns.videoStreams[t].connectID=void 0),this._vcsIns.controlsAccount.connections=this._vcsIns.controlsAccount.connections.filter(e=>e.connectID!==r),this._updateExtendInfo({vd:"0"}),n.resolve()}).catch(e=>{n.reject(e.message||e)}),n.promise):(console.error(`停止推流视频${t}出错：没有相应的连接ID。stopPublishSelfVideo`),Promise.resolve())}publishSelfAudio(){var e;let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;pe.log("进入 publishSelfAudio 函数");const n=fe();if(2==this._vcsIns.controlsAccount.audio_state){const e=this._vcsIns.vcsErr.throwErr(707,`推流失败${t}：音频权限被主持人禁用。`,"publishSelfAudio");return Promise.reject(e)}const s=this._vcsIns.audioStreams[t]?null===(e=this._vcsIns.audioStreams[t])||void 0===e?void 0:e.streamID:void 0;if(!s){const e=this._vcsIns.vcsErr.throwErr(9001,`推流失败${t}：流编号错误。`,"publishSelfAudio");return Promise.reject(e)}return this._vcsIns.media.getStream(s).then(async e=>{let o=null;this._localAudioTrack?(pe.log("检测到 _localAudioTrack 存在，跳过publish"),o=Promise.resolve()):(this._localAudioTrack=await r.createCustomAudioTrack({mediaStreamTrack:e.getAudioTracks()[0]}),o=this._drtcIns.publish(this._localAudioTrack)),o.then(r=>{this._drtcIns.mixAudioToGroup(this._localAudioTrack,!0),this._localAudioTrack.setMuted(!1);const o=P(12);this._vcsIns.audioStreams[t]&&(this._vcsIns.audioStreams[t].connectID=o),this._vcsIns._updateSocket_addAudioTrack(),pe.log(`推送音频流${t}成功。`),this._vcsIns.controlsAccount.connections||(this._vcsIns.controlsAccount.connections=new Array),this._vcsIns.controlsAccount.connections.push({connectID:o,streamID:s,index:t,type:this._globalParams.vcsTypes.IFConnectionType.Audio}),this._updateExtendInfo({ad:"1"}),n.resolve(e)}).catch(e=>{console.error(`推送音频流${t}错误：SDP协商出错。`),n.reject(e.message||e)})}),n.promise}stopPublishSelfAudio(){var e;let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;pe.log("进入 stopPublishSelfAudio 函数");const n=fe();this._vcsIns.controlsAccount&&(this._vcsIns.controlsAccount.audio_state=1);const r=null===(e=this._vcsIns.audioStreams[t])||void 0===e?void 0:e.connectID;return r?(this._localAudioTrack.setMuted(!0),this._drtcIns.unpublish(this._localAudioTrack).then(e=>{var s;null===(s=this._localAudioTrack)||void 0===s||s.close(),this._localAudioTrack=null,this._vcsIns._updateSocket_removeAudioTrack(t),this._vcsIns.audioStreams[t]&&(this._vcsIns.audioStreams[t].connectID=void 0),this._vcsIns.controlsAccount.connections=this._vcsIns.controlsAccount.connections.filter(e=>e.connectID!==r),this._updateExtendInfo({ad:"0"}),n.resolve()}).catch(e=>{n.reject(e.message||e)}),n.promise):(console.error(`停止推流音频${t}出错：没有相应的连接ID。stopPublishSelfAudio`),Promise.resolve())}publishSelfScreen(e){var t;const n=fe();pe.log("进入 publishSelfScreen 函数");const s=this._vcsIns.screenStreams[e]?null===(t=this._vcsIns.screenStreams[e])||void 0===t?void 0:t.streamID:void 0;if(!s){const t=this._vcsIns.vcsErr.throwErr(9002,`推流失败${e}：流编号错误。`,"publishSelfScreen");return Promise.reject(t)}return this._vcsIns.media.getStream(s).then(async t=>{this._localScreenVideoTrack=await r.createCustomVideoTrack({mediaStreamTrack:t.getVideoTracks()[0]},"screen-cast"),this._drtcIns.publish(this._localScreenVideoTrack).then(r=>{const o=P(12);this._vcsIns.screenStreams[e]&&(this._vcsIns.screenStreams[e].connectID=o),this._vcsIns._updateSocket_addScreenTrack(e),this._vcsIns.controlsAccount.connections||(this._vcsIns.controlsAccount.connections=new Array),this._vcsIns.controlsAccount.connections.push({connectID:o,streamID:s,index:e,type:this._globalParams.vcsTypes.IFConnectionType.MixtureOrScreen}),n.resolve(t)}).catch(e=>{n.reject(e.message||e)})}),n.promise}stopPublishSelfScreen(e){return pe.log("进入 stopPublishSelfScreen 函数"),new Promise((t,n)=>{var r;const s=null===(r=this._vcsIns.screenStreams[e])||void 0===r?void 0:r.connectID;if(!s)return this._vcsIns.vcsErr.throwErr(1003,`停止推流桌面${e}出错：没有相应的连接ID。`,"stopPublishSelfScreen"),t();(this._localScreenVideoTrack?this._drtcIns.unpublish(this._localScreenVideoTrack):Promise.resolve()).then(n=>{var r;pe.log("drtc unpublish screen 成功"),null===(r=this._localScreenVideoTrack)||void 0===r||r.close(),this._localScreenVideoTrack=null,this._vcsIns.screenStreams[e]&&(this._vcsIns.screenStreams[e].connectID=void 0),this._vcsIns._updateSocket_removeScreenTrack(e),this._vcsIns.controlsAccount.connections=this._vcsIns.controlsAccount.connections.filter(e=>e.connectID!==s),t()}).catch(e=>{pe.log("drtc unpulish screen 失败：",e),n(e)})})}async pullPeerMixerAudioStream(e){pe.log("进入pullPeerMixerAudioStream，订阅远端混音流");const t=fe();if("audience"===this._role){pe.log("观众，_signalingIns发起请求混音流cdn地址");const e=await this._vcsIns.media.createStream(1,!1,!1),n=await this._vcsIns.media.getStream(e);this._signalingIns.connect({peerID:"amixer",offerType:this._globalParams.vcsTypes.OfferType.Audio,stream:n,isScreen:!1,descOption:{desc:"pullPeerMixerAudioStream"},person:this._vcsIns.account,cdnStreamTypes:32}).then(r=>{pe.log("观众，拉取混音流成功"),this._vcsIns.roomInfo.connectMixerAudio(e,r,0,this._globalParams.vcsTypes.IFConnectionType.Audio,n),this._remoteMixAudioStream=n,t.resolve({connectID:r,stream:this._remoteMixAudioStream})}).catch(n=>{this._vcsIns.media.closeStream(e),t.reject((null==n?void 0:n.message)||n)})}else this._drtcIns.subscribe("mcu","audio").then(e=>{this._remoteMixAudioTrack=e,this._remoteMixAudioStream=new MediaStream([e.getMediaStreamTrack()]),t.resolve({connectID:null,stream:this._remoteMixAudioStream})}).catch(e=>{t.reject(e.message||e)});return t.promise}stopPullPeerMixerAudioStream(){var e,t;return pe.log("进入stopPullPeerMixerAudioStream，取消订阅远端混音流"),this._updateStreamTrack(this._remoteMixAudioStream,null===(e=this._remoteMixAudioStream)||void 0===e||null===(t=e.getAudioTracks)||void 0===t||null===(t=t.call(e))||void 0===t?void 0:t[0]),this._remoteMixAudioTrack=null,this._remoteMixAudioStream=null,new Promise((e,t)=>{if("audience"===this._role){const n=this._vcsIns.roomInfo.getMixerAudioConnectionID(),r=this._vcsIns.roomInfo.getMixerAudioStreamID();this._signalingIns.disconnect(n,!0).then(()=>{this._vcsIns.media.closeStream(r),this._vcsIns.roomInfo&&this._vcsIns.roomInfo.disconnectMixerAudio(),e()}).catch(t)}else this._drtcIns.unsubscribe("mcu","audio").then(e).catch(t)})}async pullPeerVideoStream(e,t){const n=fe(),r=this._vcsIns.roomInfo.getStreamID(e);if(pe.log(`订阅视频，personId:${e}, stream_id: ${r}`),"audience"===this._role){pe.log("观众，_signalingIns发起请求视频cdn地址");const s=this.roomInfo.getPeer(e),o=(null==t?void 0:t.index)||0,i=await this._vcsIns.media.createStream(1,!1,!1),a=await this._vcsIns.media.getStream(i),c=this.peerConnectionProgressQueue.createPeerConnectionProgress(e+o);c.setTask(!0,"beforecreateStream"),this._signalingIns.connect({peerID:r,track:o,offerType:this._globalParams.vcsTypes.OfferType.Video,stream:a,isScreen:!1,descOption:{desc:"pullPeerVideoStream",id:e},person:s,progress:c,cdnStreamTypes:1}).then(t=>{if(pe.log(`观众，拉取stream_id: ${r} 视频成功`),c&&"closed"===c.state)return n.reject("101已经停止拉流");c&&"normal"===c.state&&c.setTask(!0,"beforeRoomInfoConnect"),this._vcsIns.roomInfo.connect(e,i,t,o,this._globalParams.vcsTypes.IFConnectionType.Video,a),this._remoteUserStreams[r]=a,n.resolve({connectID:t,stream:a})}).catch(e=>{this._vcsIns.media.closeStream(i),n.reject(e.message||e)})}else{const s=this._vcsIns.pullPeerVideoStream(e,t),o=new Promise((e,t)=>{const n=this._drtcIns.remoteUsers.find(e=>e.userId===r);if(null!=n&&n.videoTrack)return pe.log("已存在订阅的视频流，直接返回remoteUser.videoTrack"),void e(n.videoTrack);this._drtcIns.subscribe(r,"video").then(e).catch(t)});Promise.all([s,o]).then(e=>{const t=e[1],s=e[0].connectID,o=new MediaStream([t.getMediaStreamTrack()]);this._remoteUserStreams[r]=o,this._remoteUserTracks[r]=t,n.resolve({connectID:s,stream:o})}).catch(e=>{n.reject(e.message||e)})}return n.promise}stopPullPeerVideoStreamByPersonId(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return pe.log("进入stopPullPeerVideoStreamByPersonId方法"),new Promise((n,r)=>{const s=this._vcsIns.roomInfo.getStreamID(e);if(pe.log(`取消订阅视频，personId:${e}, stream_id: ${s}`),"audience"===this._role){const o=this._vcsIns.peerConnectionProgressQueue.getPeerConnectionProgress(e+t);if(o){o.setTask(!1,"close");const t=o.getTask("beforeSignalingInsDisConnect").args.connectionID;this._signalingIns.disconnect(t).then(()=>{const r=this._vcsIns.roomInfo.getConnection(e,t);r&&this._vcsIns.media.closeStream(null==r?void 0:r.streamID),this._vcsIns.roomInfo.disconnect(e,t),n()}).catch(r)}else pe.log(`取消订阅视频，personId:${e}, stream_id: ${s}失败，progress为空`)}else{const o=this._vcsIns.stopPullPeerVideoStreamByPersonId(e,t),i=this._drtcIns.unsubscribe(s,"video");Promise.all([o,i]).then(e=>{delete this._remoteUserStreams[s],delete this._remoteUserTracks[s],n()}).catch(e=>{r(e.message||e)})}})}stopPullPeerVideoStream(e){const t=this._vcsIns.roomInfo.getIDByConnectID(e);return this.stopPullPeerVideoStreamByPersonId(t)}async pullPeerScreenStream(e,t){const n=fe(),r=this._vcsIns.roomInfo.getStreamID(e),s=this._vcsIns.roomInfo.getPeer(e);if(pe.log(`订阅屏幕共享流，personId:${e}, stream_id: ${r}`),"audience"===this._role){const o=await this._vcsIns.media.createStream(2,!1,!1),i=await this._vcsIns.media.getStream(o);this._signalingIns.connect({peerID:r,track:t,offerType:this._globalParams.vcsTypes.OfferType.Screen_Video,stream:i,isScreen:!1,descOption:{desc:"pullPeerScreenStream",id:e},person:s,cdnStreamTypes:4}).then(r=>(pe.log("观众 订阅屏幕共享流成功"),this._vcsIns.roomInfo.connect(e,o,r,t,this._globalParams.vcsTypes.IFConnectionType.MixtureOrScreen,i),n.resolve({connectID:r,stream:i}))).catch(e=>n.reject(e))}else{const s=this._vcsIns.pullPeerScreenStream(e,t),o=new Promise((e,t)=>{const n=this._drtcIns.remoteUsers.find(e=>e.userId===r);if(n.auxiliaryTrack)return pe.log("已存在订阅的屏幕共享流，直接返回remoteUser.auxiliaryTrack"),void e(n.auxiliaryTrack);pe.log("drtc发起屏幕共享流订阅"),this._drtcIns.subscribe(r,"video",!0).then(e).catch(t)});Promise.all([s,o]).then(e=>{pe.log("屏幕共享流订阅成功");const t=e[1];this._remoteScreenStream=new MediaStream([t.getMediaStreamTrack()]),this._remoteScreenTrack=t;const r=e[0].connectID;n.resolve({connectID:r,stream:this._remoteScreenStream})}).catch(e=>{n.reject(e.message||e)})}return n.promise}stopPullPeerScreenStream(e){return new Promise((t,n)=>{const r=this._vcsIns.roomInfo.getIDByConnectID(e),s=this._vcsIns.roomInfo.getStreamID(r);if(pe.log(`取消订阅屏幕共享流，personId:${r}, stream_id: ${s}`),"audience"===this._role)this._signalingIns.disconnect(e,!0).then(()=>{if(pe.log("观众 取消订阅屏幕共享流成功"),this._vcsIns.roomInfo.hasConnectionByConnectID(r,e)){const t=this._vcsIns.roomInfo.getConnection(r,e);r&&e&&this._vcsIns.roomInfo.disconnect(r,e),t&&t.streamID&&this._vcsIns.media.closeStream(null==t?void 0:t.streamID)}return t()}).catch(e=>n(e));else{const r=this._vcsIns.stopPullPeerScreenStream(e),o=this._drtcIns.unsubscribe(s,"video",!0);Promise.all([r,o]).then(e=>{this._remoteScreenStream=null,this._remoteScreenTrack=null,t()}).catch(e=>{n(e.message||e)})}})}switchBigStream(e){return pe.log("进入switchBigStream 方法"),new Promise((t,n)=>{const r=this._vcsIns.roomInfo.getIDByConnectID(e),s=this._vcsIns.roomInfo.getStreamID(r);"audience"===this._role?(pe.log("观众切换视频到大流"),this._signalingIns.switchTrack(e,1).then(t).catch(n)):(pe.log("drtc切换视频到大流"),this._drtcIns.setRemoteVideoStreamType(s,"high").then(e=>{pe.log(`drtc切换用户${s}视频到大流成功`),t()}).catch(n))})}switchSmallStream(e){return pe.log("进入switchSmallStream 方法"),new Promise((t,n)=>{const r=this._vcsIns.roomInfo.getIDByConnectID(e),s=this._vcsIns.roomInfo.getStreamID(r);"audience"===this._role?(pe.log("观众切换视频到小流"),this._signalingIns.switchTrack(e,0).then(t).catch(n)):(pe.log("drtc切换视频到小流"),this._drtcIns.setRemoteVideoStreamType(s,"low").then(e=>{pe.log(`drtc切换用户${s}视频到小流成功`),t()}).catch(n))})}getRtcType(){return this._rtcType}on(e,t){let n=t;if("drtc"===this._rtcType){"throwStreamNetworkState"===e&&(n=async e=>{let n=e;if(!n.closed){const e=this._vcsIns.roomInfo.getIDByConnectID(n.id);if(e){const t=this._vcsIns.roomInfo.getStreamID(e);n=await this._replaceConnectionStateState(n,t)}}return t(n)}),"onPeerSharingScreenStart"===e&&(n=e=>{if(null!=e&&e.isFromMrtc||e.id===this._vcsIns.getAccount().id)return t(e);pe.log("onPeerSharingScreenStart 事件被拦截，此次事件不是由mrtc触发")}),"onRoomMemberInfoChange"===e&&(n=e=>(e.persons=this._replacePersons(e.persons),t(e)));const r=["throwStreamNetworkState","onPeerSharingScreenStart"];"audience"===this._role&&r.includes(e)&&(n=async e=>t(e)),this._vcsIns.on(e,n)}else this._vcsIns.on(e,n)}_connectEffect(){const e=this._vcsIns.getRoom();pe.log("_connectEffect，触发vcs房间信息更新"),this._vcsIns.notice(this._globalParams.vcsTypes.NoticeType.throwRoomMemberInfo,e)}_reconnectEffect(){this._drtcMediaReconnectFailTrackIds.forEach(e=>{try{if(e===this._remoteMixAudioTrack.trackId)return pe.log("有混音流，且重连fail了，drtc重新订阅混音流"),void this._drtcIns.subscribe("mcu","audio").then(e=>{var t;pe.log("重连混音流成功","新的track：",e.getMediaStreamTrack()),this._updateStreamTrack(this._remoteMixAudioStream,null===(t=this._remoteMixAudioStream.getAudioTracks())||void 0===t?void 0:t[0],e.getMediaStreamTrack()),this._remoteMixAudioTrack=e}).catch(e=>{pe.log(e.message||e)});const t=this._drtcIns.remoteUsers.find(t=>{var n;return t.hasAuxiliary&&(null===(n=this._remoteScreenTrack)||void 0===n?void 0:n.trackId)===e}),n=this._drtcIns.remoteUsers.find(t=>{var n;return t.hasVideo&&!1===t.videoMuted&&(null===(n=this._remoteUserTracks[t.userId])||void 0===n?void 0:n.trackId)===e});if(t)return pe.log("有屏幕流，且屏幕流重连fail了，drtc重新订阅屏幕流"),void this._drtcIns.subscribe(t.userId,"video",!0).then(e=>{var t;pe.log("重连屏幕流成功","新的track：",e.getMediaStreamTrack()),this._updateStreamTrack(this._remoteScreenStream,null===(t=this._remoteScreenStream.getVideoTracks())||void 0===t?void 0:t[0],e.getMediaStreamTrack()),this._remoteScreenTrack=e}).catch(e=>{pe.log(e.message||e)});if(n)return pe.log(`用户${n.userId}有视频流，且视频流重连fail了，drtc重新订阅视频流`),void this._drtcIns.subscribe(n.userId,"video").then(e=>{var t;pe.log(`重连用户${n.userId}视频流成功`,"新的track：",e.getMediaStreamTrack()),this._updateStreamTrack(this._remoteUserStreams[n.userId],null===(t=this._remoteUserStreams[n.userId].getVideoTracks())||void 0===t?void 0:t[0],e.getMediaStreamTrack()),this._remoteUserTracks[n.userId]=e}).catch(e=>{pe.log(e.message||e)})}catch(e){pe.log("_reconnectEffect重新订阅流报错：",e)}}),this._drtcMediaReconnectFailTrackIds=[],this._connectEffect()}_joinEffect(){const e=this._vcsIns.getRoom(),t=this._drtcIns.remoteUsers.find(e=>e.hasAuxiliary);if(t){var n;pe.log("drtc正常入会后，触发屏幕共享流订阅消息上报");const r=null===(n=e.persons)||void 0===n?void 0:n.find(e=>e.stream_id===t.userId);this._vcsIns.roomInfo.event_startSharingScreen({id:r.id,index:null,type:3,isFromMrtc:!0})}}_rejoinEffect(){this._localVideoTrack&&(pe.log("drtc重新入会，推送本地视频流"),this._drtcIns.publish(this._localVideoTrack)),this._localAudioTrack&&(pe.log("drtc重新入会，推送本地音频流"),this._drtcIns.publish(this._localAudioTrack).then(()=>{this._drtcIns.mixAudioToGroup(this._localAudioTrack,!0)})),pe.log("drtc重新入会，重新订阅混音流"),this._drtcIns.subscribe("mcu","audio").then(e=>{var t;this._remoteMixAudioTrack=e,this._updateStreamTrack(this._remoteMixAudioStream,null===(t=this._remoteMixAudioStream.getAudioTracks())||void 0===t?void 0:t[0],this._remoteMixAudioTrack.getMediaStreamTrack())});const e=this._drtcIns.remoteUsers.find(e=>e.hasAuxiliary);if(e)if(this._remoteScreenStream){var t;if(e.auxiliaryTrack)pe.log("drtc重新入会后，更新对端屏幕共享流track"),this._updateStreamTrack(this._remoteScreenStream,null===(t=this._remoteScreenStream.getVideoTracks())||void 0===t?void 0:t[0],e.auxiliaryTrack.getMediaStreamTrack()),this._remoteScreenTrack=e.auxiliaryTrack;else pe.log("drtc重新入会后，重新订阅对端屏幕共享流"),this._drtcIns.subscribe(e.userId,"video",!0).then(e=>{var t;this._updateStreamTrack(this._remoteScreenStream,null===(t=this._remoteScreenStream.getVideoTracks())||void 0===t?void 0:t[0],e.getMediaStreamTrack()),this._remoteScreenTrack=e})}else{var n;pe.log("drtc重新入会后，触发屏幕共享流订阅消息上报");const t=null===(n=vcsRoomInfo.persons)||void 0===n?void 0:n.find(t=>t.stream_id===e.userId);this._vcsIns.roomInfo.event_startSharingScreen({id:t.id,index:null,type:3,isFromMrtc:!0})}}_listenVcsBeforeEnterRoomEvent(){var e=this;this._vcsIns.once("onSelfAccountChange",function(){for(var t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];e._vcsBeforeEnterRoomEventTransactions.onSelfAccountChange=n})}_triggerVcsBeforeEnterRoomEvent(){Object.entries(this._vcsBeforeEnterRoomEventTransactions).forEach(e=>{let[t,n]=e;this._vcsIns.eventBus.emit(t,...n),delete this._vcsBeforeEnterRoomEventTransactions[t]})}_replacePersons(e){pe.log("vcsPersons转换前数据：",e);const t=n.cloneDeep(e);return"audience"===this._role?null==t||t.forEach(e=>{this._replacePersonByAudience(e)}):null==t||t.forEach(e=>{var t;const n=null===(t=this._drtcIns)||void 0===t||null===(t=t.remoteUsers)||void 0===t?void 0:t.find(t=>t.userId==e.stream_id);n&&this._replacePerson(e,n)}),t}_replacePerson(e,t){return e.id!==this._vcsIns.getAccount().id&&(e.vstate=null==t||!t.hasVideo||null!=t&&t.videoMuted?1:0,e.astate=!1===this._remoteUserMicMuted[t.userId]?0:1,e.streams=this._replacePersonStreams(e.streams),this._vcsIns.roomInfo.checkPeer(e.id)&&this._vcsIns.roomInfo.getVideoState(e.id)!==e.vstate&&this._vcsIns.roomInfo.setVideoState(e.id.toString(),e.vstate),this._vcsIns.roomInfo.checkPeer(e.id)&&this._vcsIns.roomInfo.getAudioState(e.id)!==e.astate&&this._vcsIns.roomInfo.setAudioState(e.id.toString(),e.astate)),e}_replacePersonByAudience(e){const t=JSON.parse(e.extend_info);if(t.rtcExt){const n=JSON.parse(t.rtcExt),r="1"===n.ad?0:1,s="1"===n.vd?0:1,o=n.nq;e.streams=this._replacePersonStreams(e.streams),r!==e.astate&&(this._vcsIns.roomInfo.setVideoState(e.id.toString(),r),e.astate=r),s!==e.vstate&&(this._vcsIns.roomInfo.setAudioState(e.id.toString(),s),e.vstate=s),o&&(this._vcsIns.roomInfo.setNetLevel(e.id.toString(),o),e.netLevel=o)}}_replacePersonStreams(e){return null==e||e.forEach(e=>{e.angle=0}),e}_replaceConnectionStateState(e,t){return new Promise(n=>{const r=e;this._drtcIns.getRemoteVideoStats().then(e=>{const s=e[t].auxiliary||e[t].camera;s&&(r.keyFramesDecoded=s.keyFramesDecoded,r["bytesReceived/s"]=s.receiveBitrate/1024/8,r.packetsReceived=s.receivePackets,r.afterPackersLost=s.receivePacketsLost||0,r.beforePackersLost=s.receivePacketsLost||0),n(r)})})}_createSiganling(){var e,t;const n=this._vcsIns.getEnterRoomData();this._signalingIns=new ve({userID:this._enterRoomParams.ertcParams.userId,serv:`${n.stream_host}:${n.stream_port}`,conf:null===(e=n.room)||void 0===e?void 0:e.sdk_no,token:n.session,roomNo:null===(t=n.room)||void 0===t?void 0:t.no,prefix:this._enterRoomParams.ertcParams.domain,amixer:this._enterRoomParams.vcsParams.amixer,cdnPrefix:!0,ertcParams:this._enterRoomParams.ertcParams}),ve.event_signaling_change=this._vcsIns._signaling_state_change.bind(this._vcsIns),ve.event_reconnect_signaling=this._vcsIns._signaling_reconnect.bind(this._vcsIns),ve.event_network_change=this._vcsIns._signaling_network_change.bind(this._vcsIns),ve.event_sync_stream=this._vcsIns._sync_stream.bind(this._vcsIns),ve.event_user_stream_track=this._vcsIns.updateUserStreamLinkTrack.bind(this._vcsIns),ve.event_disconnect_signaling=this._vcsIns._signaling_disconnect.bind(this._vcsIns),ve.event_get_account=(()=>this._vcsIns.getAccountState()).bind(this._vcsIns)}_updateStreamTrack(e,t,n){t&&e.removeTrack(t),n&&e.addTrack(n)}_updateExtendInfo(e){const t=JSON.parse(this._vcsIns.controlsAccount.extend_info),n=t.rtcExt?JSON.parse(t.rtcExt):{},r=JSON.stringify({...t,rtcExt:JSON.stringify({...n,...e})});this._vcsIns.setControlsAccount({extend_info:r})}_resetRoomStatus(){this._rtcType=null,this._drtcNetworkState=null,this._mqttNetworkState=null,this._transactions={},this._role=null,this._remoteMixAudioTrack=null,this._remoteMixAudioStream=null,this._remoteScreenStream=null,this._remoteScreenTrack=null,this._remoteUserStreams={},this._remoteUserTracks={},this._remoteUserMicMuted={},this._drtcMediaReconnectFailTrackIds=[],this._resetLocalTrackStatus()}_resetLocalTrackStatus(){var e,t,n;null===(e=this._localVideoTrack)||void 0===e||e.close(),this._localVideoTrack=null,null===(t=this._localAudioTrack)||void 0===t||t.close(),this._localAudioTrack=null,null===(n=this._localScreenVideoTrack)||void 0===n||n.close(),this._localScreenVideoTrack=null}_addDrtcReconnect(e){if(this._transactions.drtc_reconnect){const t=this._transactions.drtc_reconnect.bind(this);this._transactions.drtc_reconnect=()=>{t(),e()}}else this._transactions.drtc_reconnect=e.bind(this)}}d(_e,"EVENT",{});class Se{constructor(e){return this.domain=(null==e?void 0:e.domain)||null,this._emrtcIns=new te(e),this._dmrtcIns=new _e(e),this._vcsIns=e.vcsIns||{},this._platformType=localStorage.getItem("mrtc-platformType")||null,this._platformMap={EZVIZ:"_emrtcIns",DING:"_dmrtcIns"},this._globalParams=e,new Proxy(this,{get:function(e,t){const n=!(t in e),r=e._platformMap[e._platformType];return n?r?"function"==typeof e[r][t]?e[r][t].bind(e[r]):e[r][t]:e._vcsIns[t]:e[t]},set:function(e,t,n){const r=e._platformMap[e._platformType];return t in e?(e[t]=n,!0):(r?e[r][t]=n:e._vcsIns[t]=n,!0)}})}async enterRoom(e){var t,n;const r=await this._getRoomAndPlatform(e),s=r.data.appId,o=r.data.platformType,i=null===(t=r.data.rtcInfo)||void 0===t?void 0:t.ding,a=null===(n=r.data.rtcInfo)||void 0===n?void 0:n.ezviz;return this._platformType=o,localStorage.setItem("mrtc-platformType",o),"EZVIZ"===o&&a?this._emrtcIns.enterRoom(e):"DING"===o&&i?this._dmrtcIns.enterRoom({...e,drtcParams:{appId:s,token:i.token,uid:e.ertcParams.userId,userName:e.vcsParams.accountData.nickname,channel:e.ertcParams.roomId,initMicMuted:!0}}):void 0}_getRoomAndPlatform(e){return new Promise((t,n)=>{const r={strRoomId:e.ertcParams.roomId,customId:e.ertcParams.userId,appId:e.ertcParams.appId,rtcPlatformAbility:this._globalParams.rtcPlatformAbility||2,bizCode:"WEBRTC"};C({url:`${this.domain||"https://open.ys7.com"}/api/v3/ertc/room/enter-info`,method:"POST",data:r,headerOptions:{accessToken:e.ertcParams.accessToken}}).then(e=>{var r;200===(null===(r=e.meta)||void 0===r?void 0:r.code)?t(e):n(e)}).catch(n)})}}d(Se,"EVENT",{});const Te=X,Ie=Z,Ee=Se,be=te;e.EMRTC_WEB=be,e.ERTC=Te,e.ERTCDevice=Ie,e.MRTC_WEB=Ee,e.default=Te,Object.defineProperty(e,"__esModule",{value:!0})});
